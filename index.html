<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barclays Regulatory Adherence Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for charting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- D3.js CDN for charting -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome for icons in table headers -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      /* Login Page Animations */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px) translateZ(0);
        }
        to {
          opacity: 1;
          transform: translateY(0) translateZ(0);
        }
      }
      
      @keyframes float {
        0%, 100% {
          transform: translateY(0px) rotate(0deg) translateZ(0);
        }
        33% {
          transform: translateY(-15px) rotate(120deg) translateZ(0);
        }
        66% {
          transform: translateY(-8px) rotate(240deg) translateZ(0);
        }
      }
      
      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }
      
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-50px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      
      .animate-login-fade-in {
        animation: fadeInUp 0.6s ease-out;
        will-change: transform, opacity;
        transform: translateZ(0); /* Hardware acceleration */
      }
      
      .floating-shapes {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      
      .shape {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        animation: float 8s ease-in-out infinite;
        will-change: transform;
        transform: translateZ(0); /* Hardware acceleration */
      }
      
      .shape-1 {
        width: 80px;
        height: 80px;
        top: 20%;
        left: 10%;
        animation-delay: 0s;
      }
      
      .shape-2 {
        width: 60px;
        height: 60px;
        top: 60%;
        right: 15%;
        animation-delay: 1s;
      }
      
      .shape-3 {
        width: 100px;
        height: 100px;
        bottom: 20%;
        left: 20%;
        animation-delay: 2s;
      }
      
      .shape-4 {
        width: 40px;
        height: 40px;
        top: 30%;
        right: 30%;
        animation-delay: 3s;
      }
      
      .shape-5 {
        width: 70px;
        height: 70px;
        bottom: 40%;
        right: 10%;
        animation-delay: 4s;
      }
      
      /* Input field animations */
      .login-input-animate {
        transition: all 0.3s ease;
      }
      
      .login-input-animate:focus {
        transform: scale(1.02);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
      }
      
      /* Button hover animation */
      .login-btn-animate {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      
      .login-btn-animate:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
      }
      
      .login-btn-animate::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
      }
      
      .login-btn-animate:hover::before {
        left: 100%;
      }
      
      /* Trade Highlighting Styles */
      .highlighted-trade {
        position: relative;
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
      }
      
      .highlighted-trade::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(45deg, #3b82f6, #1d4ed8);
        animation: pulse 2s infinite;
      }
      
      .highlighted-trade:hover {
        background-color: #fef3c7 !important;
        transform: translateX(4px);
      }
      
      /* Dashboard Animations */
      @keyframes slideInFromTop {
        from {
          opacity: 0;
          transform: translateY(-20px) translateZ(0);
        }
        to {
          opacity: 1;
          transform: translateY(0) translateZ(0);
        }
      }
      
      @keyframes slideInFromLeft {
        from {
          opacity: 0;
          transform: translateX(-50px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      
      @keyframes slideInFromRight {
        from {
          opacity: 0;
          transform: translateX(50px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      
      @keyframes fadeInScale {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      
      @keyframes bounceIn {
        0% {
          opacity: 0;
          transform: scale(0.3);
        }
        50% {
          opacity: 1;
          transform: scale(1.05);
        }
        70% {
          transform: scale(0.9);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }
      
      @keyframes shimmer {
        0% {
          background-position: -200px 0;
        }
        100% {
          background-position: calc(200px + 100%) 0;
        }
      }
      
      .dashboard-animate {
        animation: slideInFromTop 0.8s ease-out;
      }
      
      .kpi-animate {
        animation: fadeInScale 0.6s ease-out;
        transition: all 0.3s ease;
      }
      
      .kpi-animate:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }
      
      .card-animate {
        animation: slideInFromLeft 0.8s ease-out;
        transition: all 0.3s ease;
      }
      
      .card-animate:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }
      
      .chart-animate {
        animation: slideInFromRight 0.8s ease-out;
      }
      
      .title-animate {
        animation: bounceIn 1s ease-out;
      }
      
      .shimmer-effect {
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        background-size: 200px 100%;
        animation: shimmer 2s infinite;
      }
      
      /* Trade Exception Tab Animations - Optimized for Performance */
      .trade-exception-animate {
        animation: slideInFromTop 0.5s ease-out;
        will-change: transform, opacity;
        transform: translateZ(0); /* Hardware acceleration */
      }
      
      body {
        font-family: "Inter", sans-serif;
        background-color: #f0f2f5; /* Light grey background */
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        /* Performance optimizations */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }
      .header {
        background-color: #00AEEF; /* Custom blue color for header */
        color: white;
        padding: 1rem 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: center; /* Center the title */
        align-items: center;
        position: sticky; /* Make header sticky */
        top: 0; /* Stick to the top */
        left: 0; /* Stick to the left */
        right: 0; /* Extend to the right */
        z-index: 1000; /* High z-index to stay above all content */
        gap: 1rem; /* Space between logo and title */
        min-width: 100vw; /* Ensure it spans the full viewport width */
      }
      .header img {
        border-radius: 0.25rem; /* Slightly rounded corners for the logo */
      }
      .nav-sidebar {
        background-color: #00AEEF; /* Custom blue color for sidebar */
        padding: 1.5rem 0;
        width: 200px; /* Fixed width for the sidebar */
        min-width: 200px; /* Ensure minimum width is maintained */
        flex-shrink: 0; /* Prevent shrinking */
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        border-radius: 0 0.75rem 0.75rem 0; /* Rounded bottom-right corner */
      }
      .nav-tabs {
        display: flex;
        flex-direction: column; /* Stack tabs vertically */
        gap: 0.5rem; /* Space between tabs */
        padding: 0 1rem; /* Padding inside the sidebar */
      }
      .nav-tab {
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem; /* Rounded corners for tabs */
        cursor: pointer;
        transition: background-color 0.3s ease, color 0.3s ease,
          box-shadow 0.3s ease; /* Add box-shadow to transition */
        font-weight: 500;
        color: #ffffff; /* White for inactive tabs */
        text-align: left; /* Align text to the left */
        display: flex; /* Use flexbox for icon and text alignment */
        align-items: center; /* Vertically align icon and text */
        gap: 0.75rem; /* Space between icon and text */
      }
      .nav-tab svg {
        width: 1.25rem; /* Icon size */
        height: 1.25rem; /* Icon size */
        fill: currentColor; /* Make SVG color inherit from parent text color */
      }
      .nav-tab:hover {
        background-color: #5f9ea0; /* Cadet Blue on hover - a slightly different blue */
        color: white;
        /* Add blue box-shadow on hover */
        box-shadow: inset 0 2px 4px rgba(0, 0, 128, 0.3); /* Dark blue shadow on hover */
      }
      .nav-tab.active {
        background-color: #0055aa; /* A distinct darker blue for active tab */
        color: white;
        /* Blue box-shadow for active tab */
        box-shadow: inset 0 2px 4px rgba(0, 0, 128, 0.5); /* Dark blue shadow for active state */
      }
      .main-container {
        display: flex;
        flex-grow: 1;
        min-width: 0; /* Allow content to shrink if needed */
      }
      .content-area {
        flex-grow: 1;
        flex-shrink: 1; /* Allow content to shrink */
        min-width: 0; /* Allow content to shrink below its natural width */
        padding: 2rem;
        background-color: #ffffff; /* White background for content */
        border-radius: 0.75rem; /* Rounded corners for content area */
        margin: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        display: flex; /* Changed to flex for better content control */
        flex-direction: column; /* Stack content vertically */
        min-height: 300px; /* Minimum height for content area */
        color: #4a5568; /* Dark grey text */
        font-size: 1.25rem;
        text-align: center; /* Default text alignment for placeholders */
        overflow-x: auto; /* Allow horizontal scrolling if content is too wide */
      }
      .footer {
        background-color: #003366; /* Dark blue for footer */
        color: white;
        text-align: center;
        padding: 1rem;
        margin-top: auto; /* Push footer to the bottom */
        font-size: 0.875rem;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .main-container {
          flex-direction: column; /* Stack sidebar and content on small screens */
        }
        .nav-sidebar {
          width: 100%; /* Full width sidebar on small screens */
          border-radius: 0; /* Remove specific border-radius */
          padding-bottom: 0.5rem; /* Adjust padding */
        }
        .nav-tabs {
          flex-direction: row; /* Tabs can be row on small screens if they fit */
          flex-wrap: wrap;
          justify-content: center;
        }
        .nav-tab {
          text-align: center;
        }
        .content-area {
          margin: 1rem;
        }
      }

      /* Styles for Trade Exception tab */
      .header-container {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
      }
      .dropdown-menu {
        position: absolute;
        top: 100%; /* Position below the header */
        left: 0;
        z-index: 10;
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        min-width: 180px;
        padding: 0.75rem;
        display: none;
        flex-direction: column;
        gap: 0.5rem;
      }
      .dropdown-menu.show {
        display: flex;
      }
      .dropdown-item {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        color: #4b5563;
      }
      .dropdown-item:hover {
        background-color: #f3f4f6;
      }
      .dropdown-filter-section {
        border-top: 1px solid #e5e7eb;
        padding-top: 0.5rem;
        margin-top: 0.5rem;
      }
      .dropdown-filter-section label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #4b5563;
      }
      .dropdown-filter-section input[type="text"],
      .dropdown-filter-section input[type="date"],
      .dropdown-filter-section input[type="number"] {
        width: 100%;
        padding: 0.4rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }
      .dropdown-filter-section .checkbox-list {
        max-height: 120px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 0.25rem;
        padding: 0.5rem;
        margin-top: 0.5rem;
      }
      .dropdown-filter-section .checkbox-list div {
        margin-bottom: 0.25rem;
      }
      .dropdown-filter-section .checkbox-list input[type="checkbox"] {
        margin-right: 0.5rem;
        cursor: pointer;
      }
      .dropdown-filter-section .checkbox-list label {
        cursor: pointer;
        user-select: none;
      }
      .dropdown-filter-section .checkbox-list .select-all-checkbox {
        margin-right: 0.5rem;
        cursor: pointer;
      }
      .dropdown-filter-section .checkbox-list input[type="checkbox"] {
        width: auto !important;
        height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
        border: 1px solid #d1d5db !important;
        border-radius: 3px !important;
        background-color: white !important;
        cursor: pointer !important;
        display: inline-block !important;
        vertical-align: middle !important;
      }
      .dropdown-filter-section .checkbox-list input[type="checkbox"]:checked {
        background-color: #3b82f6 !important;
        border-color: #3b82f6 !important;
      }
      /* Custom colors for table cells */
      .text-red {
        color: #ef4444;
      } /* Tailwind red-500 */
      .text-green {
        color: #22c55e;
      } /* Tailwind green-500 */
      .text-yellow {
        color: #eab308;
      } /* Tailwind yellow-500 */
      /* Styles for smaller charts */
      .chart-container-small {
        height: 180px; /* Reduced height for charts */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        /* Added visual appeal */
        border: 1px solid #e0e0e0; /* Lighter border */
        border-radius: 0.5rem; /* Rounded corners */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Subtle shadow */
        padding: 1rem; /* Increase padding for better spacing */
      }
      .chart-container-small canvas {
        max-height: 150px; /* Ensure canvas itself respects the container height */
        width: 100% !important; /* Override Chart.js inline width */
        height: 100% !important; /* Override Chart.js inline height */
      }
      /* Chart titles in the containers */
      .chart-container-small h3 {
        font-size: 0.95rem; /* Slightly smaller title font */
        margin-bottom: 0.5rem;
        color: #374151; /* Darker gray for titles */
      }

      /* Styles for Trade Reporting tab */
      .table-input {
        width: 100%;
        padding: 0.375rem;
        border: 1px solid #d1d5db; /* gray-300 */
        border-radius: 0.375rem; /* rounded-md */
        font-size: 0.75rem; /* text-xs */
        background-color: #f9fafb; /* gray-50 */
      }
      .table-input:focus {
        outline: none;
        border-color: #3b82f6; /* blue-500 */
        box-shadow: 0 0 0 1px #3b82f6; /* ring-1 ring-blue-500 */
      }
      
      /* Enhanced table styling for better borders and alignment */
      table {
        border-collapse: collapse;
        width: 100%;
      }
      
      th, td {
        border: 1px solid #e5e7eb; /* gray-200 */
        padding: 0.75rem 1rem;
        text-align: left;
        vertical-align: top;
      }
      
      th {
        background-color: #f3f4f6; /* gray-100 */
        font-weight: 600;
        color: #374151; /* gray-700 */
        border-bottom: 2px solid #d1d5db; /* gray-300 */
      }
      
      tr:nth-child(even) {
        background-color: #f9fafb; /* gray-50 */
      }
      
      tr:hover {
        background-color: #f3f4f6; /* gray-100 */
      }
      /* Chart specific styles for D3 charts */
      .d3-chart-container {
        background-color: #ffffff;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
        padding: 1rem;
      }
      .d3-chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: #374151; /* gray-700 */
        margin-bottom: 0.5rem;
        text-align: center;
      }
      .axis text {
        font-size: 0.8rem; /* Increased font size for axis labels */
        fill: #6b7280; /* gray-500 */
      }
      .axis line,
      .axis path {
        stroke: #d1d5db; /* gray-300 */
      }
      .bar {
        fill: #3b82f6; /* blue-500 */
      }
      .slice text {
        font-size: 0.8em; /* Increased font size for pie chart labels */
        fill: #374151; /* Darker color for pie chart labels */
        text-anchor: middle;
      }
      .tooltip {
        position: absolute;
        text-align: center;
        width: auto;
        height: auto;
        padding: 8px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
        opacity: 0;
        z-index: 1000;
      }
      .filter-icon-reporting {
        /* Specific class for reporting tab filters */
        cursor: pointer;
        margin-left: 5px;
        color: #6b7280; /* Default gray color */
      }
      .filter-icon-reporting.active {
        color: #3b82f6; /* Blue color when filter is active */
      }
      .sort-icon-reporting {
        /* Specific class for reporting tab sort icons */
        margin-left: 5px;
        font-size: 0.7em;
        color: #6b7280;
      }

      /* Styles for Audit Trail Tab */
      .audit-table-container::-webkit-scrollbar {
        height: 8px;
      }
      .audit-table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      .audit-table-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
      }
      .audit-table-container::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      .audit-sort-arrow {
        display: inline-block;
        width: 0;
        height: 0;
        margin-left: 5px;
        vertical-align: middle;
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        opacity: 0.5;
      }
      .audit-sort-arrow.asc {
        border-bottom: 6px solid #333; /* Up arrow */
      }
      .audit-sort-arrow.desc {
        border-top: 6px solid #333; /* Down arrow */
      }
      .audit-sort-arrow.active {
        opacity: 1;
      }

      /* Styles for Dashboard Tab */
      /* Adjusted font size for the main header to prevent cutting off */
      .dashboard-header-title {
        font-size: 1.75rem; /* Reduced from 2rem */
        line-height: 1.2; /* Ensure good line spacing */
        word-break: break-word; /* Allow long words to break */
      }
      @media (min-width: 768px) {
        /* Adjust for medium screens and up */
        .dashboard-header-title {
          font-size: 2.25rem; /* Slightly larger on larger screens */
        }
      }
      @media (min-width: 1024px) {
        /* Adjust for large screens and up */
        .dashboard-header-title {
          font-size: 2.5rem; /* Original size on very large screens if space allows */
        }
      }

      .dashboard-card {
        background-color: #ffffff;
        border-radius: 0.5rem; /* Rounded corners */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
      }
      .blue-bg-card {
        background-color: #2b6cb0; /* A darker blue for the main section */
        color: white;
      }
      .kpi-box {
        background-color: #ffffff;
        border-radius: 0.5rem;
        padding: 1rem;
        text-align: center;
        flex-grow: 1; /* Allow boxes to grow */
        /* Ensure text wraps if needed and has some padding */
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .kpi-value {
        font-size: 1.75rem; /* Reduced from 2rem to prevent cutting off */
        font-weight: bold;
        color: #2b6cb0; /* Blue color for KPI values */
        line-height: 1.2; /* Adjust line height for better spacing */
      }
      @media (min-width: 768px) {
        .kpi-value {
          font-size: 2rem; /* Slightly larger on medium screens */
        }
      }
      @media (min-width: 1024px) {
        .kpi-value {
          font-size: 2.25rem; /* Original size on very large screens */
        }
      }
      .kpi-label {
        font-size: 0.8rem; /* Reduced from 0.875rem */
        color: #6b7280; /* Grey color for labels */
        text-transform: uppercase;
        margin-top: 0.25rem;
        line-height: 1.2; /* Ensure good line spacing for labels */
      }
      .rate-value {
        font-size: 1.75rem; /* Reduced from 2rem */
        font-weight: bold;
        color: #2b6cb0;
        line-height: 1.2;
      }
      @media (min-width: 768px) {
        .rate-value {
          font-size: 2rem;
        }
      }
      @media (min-width: 1024px) {
        .rate-value {
          font-size: 2.25rem;
        }
      }
      .rate-label {
        font-size: 0.8rem; /* Reduced from 0.875rem */
        color: #6b7280;
        text-transform: uppercase;
        margin-top: 0.25rem;
        line-height: 1.2;
      }
      .chart-container-dashboard {
        /* Renamed to avoid conflict with existing .chart-container */
        background-color: #ffffff; /* Lighter background for charts */
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1rem;
        height: 250px; /* Adjusted height for charts */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        color: #6b7280;
      }
      .chart-svg-line {
        width: 100%;
        height: 180px; /* Height for the SVG itself */
        margin-top: 0.5rem;
      }
      .table-header-dashboard {
        /* Renamed to avoid conflict */
        background-color: #e5e7eb; /* Light grey for table header */
        font-weight: bold;
        padding: 0.75rem;
        text-align: left;
      }
      .table-row-even-dashboard {
        /* Renamed to avoid conflict */
        background-color: #f9fafb; /* Lighter row background */
      }
      .table-row-odd-dashboard {
        /* Renamed to avoid conflict */
        background-color: #ffffff; /* White row background */
      }
      .table-cell-dashboard {
        /* Renamed to avoid conflict */
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb; /* Separator for rows */
      }
      .donut-chart-container-dashboard {
        /* Renamed to avoid conflict */
        background-color: #ffffff;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .donut-segment-dashboard {
        /* Renamed to avoid conflict */
        height: 15px;
        width: 15px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
      }
      .chart-svg-dashboard {
        /* Renamed to avoid conflict */
        width: 150px; /* Adjust size as needed */
        height: 150px;
        margin-bottom: 1rem;
      }

      /* Regulatory Frameworks Specific Styles */
      .framework-table-header {
        background-color: #e5e7eb; /* Tailwind gray-200 */
        font-weight: bold;
        padding: 0.75rem 1rem;
        text-align: left;
        font-size: 0.75rem; /* text-xs */
        color: #4b5563; /* gray-700 */
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .framework-table-cell {
        padding: 0.75rem 1rem;
        font-size: 0.875rem; /* text-sm */
        color: #374151; /* gray-800 */
        border-bottom: 1px solid #e5e7eb; /* gray-200 */
      }
      .framework-tab-button {
        flex: 1; /* Allow buttons to take equal width */
        min-width: 120px; /* Minimum width for smaller screens */
        padding: 0.75rem 1rem;
        background-color: #e5e7eb; /* gray-200 */
        color: #374151; /* gray-800 */
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease-in-out;
        text-align: center;
        font-weight: 500;
      }
      .framework-tab-button:hover {
        background-color: #d1d5db; /* gray-300 */
      }
      .framework-tab-button.active-framework {
        background-color: #2563eb; /* blue-600 */
        color: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transform: translateY(-2px); /* Slight lift effect */
      }
      .framework-tab-pane {
        background-color: #f9fafb; /* gray-50 */
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb; /* gray-200 */
        box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.05);
      }
      .framework-kpi-box {
        background-color: #ffffff;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
        text-align: center;
        border: 1px solid #e0e0e0;
      }
      .framework-kpi-value {
        font-size: 1.75rem;
        font-weight: bold;
        margin-top: 0.25rem;
      }
      .framework-kpi-label {
        font-size: 0.875rem;
        color: #6b7280;
      }
      /* Custom styling for dashboard for better appeal and formatting */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(
          auto-fit,
          minmax(200px, 1fr)
        ); /* Responsive grid columns */
        gap: 1.5rem; /* Consistent gap between items */
      }
      .dashboard-section-title {
        font-size: 1.75rem; /* Larger title for sections */
        font-weight: 700; /* Bold */
        color: #1f2937; /* Darker gray for section titles */
        margin-bottom: 1.5rem; /* More space below titles */
        text-align: left;
      }
      .kpi-box-dashboard {
        /* New class for dashboard KPIs for more specific styling */
        background-color: #ffffff;
        border-radius: 0.75rem; /* Slightly more rounded corners */
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08); /* More prominent shadow */
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.2s ease-in-out;
      }
      .kpi-box-dashboard:hover {
        transform: translateY(-5px); /* Lift effect on hover */
      }
      .kpi-value-dashboard {
        font-size: 2.5rem; /* Larger KPI values */
        font-weight: 800; /* Extra bold */
        color: #1a56db; /* Barclays blue for values */
        margin-bottom: 0.5rem;
      }
      .kpi-label-dashboard {
        font-size: 0.9rem; /* Slightly larger labels */
        color: #4b5563; /* Medium gray for labels */
        text-transform: uppercase;
        letter-spacing: 0.05em; /* Slight letter spacing */
      }
      .chart-container-dashboard {
        background-color: #ffffff;
        border-radius: 0.75rem; /* Consistent rounded corners */
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        padding: 1.5rem;
        height: 300px; /* Increased height for charts */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        color: #6b7280;
      }
      .chart-title-dashboard {
        font-size: 1.25rem; /* Larger chart titles */
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1rem;
      }
      .table-container-dashboard {
        background-color: #ffffff;
        border-radius: 0.75rem;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        overflow: hidden; /* Ensures rounded corners for table */
      }
      .table-header-dashboard-custom {
        /* Custom class for dashboard table headers */
        background-color: #e0f2f7; /* Very light blue background */
        font-weight: 700;
        padding: 1rem 1.5rem;
        text-align: left;
        color: #005f6b; /* Darker blue-green */
        border-bottom: 2px solid #b2ebf2; /* Light blue border */
      }
      .table-cell-dashboard-custom {
        /* Custom class for dashboard table cells */
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e0e0e0; /* Lighter separator */
        font-size: 0.95rem;
        color: #374151;
      }
      .table-row-hover-dashboard:hover {
        background-color: #f5fafd; /* Very light blue on hover */
      }
      .donut-chart-container-dashboard-custom {
        /* Custom class for dashboard donut charts */
        background-color: #ffffff;
        border-radius: 0.75rem;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .donut-segment-dashboard-custom {
        height: 18px; /* Slightly larger color squares */
        width: 18px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.75rem; /* More space */
      }
      .chart-svg-dashboard-custom {
        width: 180px; /* Larger donut charts */
        height: 180px;
        margin-bottom: 1.5rem;
      }
      .legend-item-dashboard {
        font-size: 0.9rem; /* Larger legend text */
        color: #4b5563;
      }
      /* Loading spinner styles */
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #3b82f6;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="flex flex-col min-h-screen">
    <!-- Login Container - Initially Visible -->
    <div id="loginContainer" class="fixed inset-0 flex items-center justify-center z-50" style="background: linear-gradient(135deg, #00AEEF 0%, #0099CC 100%);">
      <!-- Animated Background Elements -->
      <div class="absolute inset-0 overflow-hidden">
        <div class="floating-shapes">
          <div class="shape shape-1"></div>
          <div class="shape shape-2"></div>
          <div class="shape shape-3"></div>
        </div>
      </div>
      
      <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 animate-login-fade-in">
        <!-- Login Header -->
        <div class="text-center mb-8">

          <div class="text-center mb-6">
            <h1 class="text-2xl font-semibold text-black tracking-wide animate-pulse" style="font-family: 'Times New Roman', serif; text-shadow: 1px 1px 2px rgba(0,0,0,0.05);">BARCLAYS BANK</h1>
          </div>
          <h1 class="text-3xl font-bold text-gray-800 mb-2" style="animation: slideIn 1s ease-out 0.2s both;">Welcome to Regulatory Adherence Portal</h1>
          <p class="text-gray-600" style="animation: slideIn 1s ease-out 0.4s both;">Sign in to access the Regulatory Portal</p>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="space-y-6">
          <!-- ID Field -->
          <div>
            <label for="loginId" class="block text-sm font-medium text-gray-700 mb-2">
              User ID
            </label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-user text-gray-400"></i>
              </div>
              <input
                type="text"
                id="loginId"
                name="loginId"
                placeholder="Enter your ID"
                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors login-input-animate"
                required
              />
            </div>
          </div>

          <!-- Password Field -->
          <div>
            <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">
              Password
            </label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-lock text-gray-400"></i>
              </div>
              <input
                type="password"
                id="loginPassword"
                name="loginPassword"
                placeholder="Enter your password"
                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors login-input-animate"
                required
              />
            </div>
          </div>

          <!-- Error Message -->
          <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
            <div class="flex items-center">
              <i class="fas fa-exclamation-circle mr-2"></i>
              <span>Invalid ID or Password. Please try again.</span>
            </div>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center login-btn-animate"
          >
            <i class="fas fa-sign-in-alt mr-2"></i>
            Sign In
          </button>
        </form>

        <!-- Footer -->
        <div class="text-center mt-6">
          <p class="text-sm text-gray-500">
            Secure access to Barclays Regulatory Adherence Portal
          </p>
        </div>
      </div>
    </div>



    <!-- Portal Content - Initially Hidden -->
    <div id="portalContent" class="hidden w-full">
      <!-- Header Section -->
      <header class="header">
        <div class="flex items-center justify-between w-full">
          <div class="flex-1"></div>
          <h1 class="text-3xl font-bold text-center flex-1 whitespace-nowrap" style="color: white;">Barclays Regulatory Adherence Portal</h1>
          <div class="flex-1 flex justify-end">
            <!-- Logout Button -->
            <button
              id="logoutBtn"
              class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center"
            >
              <i class="fas fa-sign-out-alt mr-2"></i>
              Logout
            </button>
          </div>
        </div>
      </header>

      <!-- Main Container for Sidebar and Content -->
      <div class="main-container">
      <!-- Navigation Sidebar -->
      <nav class="nav-sidebar">
        <div class="nav-tabs" id="navTabs">
          <div class="nav-tab" data-tab="trade-exception">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2V8h2v6z" />
            </svg>
            Trade Exception
          </div>
          <div class="nav-tab" data-tab="trade-reporting">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm-1 7V3.5L18.5 9H13zM10 12H8v-2h2v2zm0 4H8v-2h2v2zm0-8H8V6h2v2zm4 8h-4v-2h4v2z"
              />
            </svg>
            Trade Reporting
          </div>
          <div class="nav-tab" data-tab="regulatory-frameworks">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8 15c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1zm0-6c-1.1 0-2-.9-2-2V7c0-1.1.9-2 2-2s2 .9 2 2v2c0 1.1-.9 2-2 2z"
              />
            </svg>
            Regulatory Frameworks
          </div>
          <div class="nav-tab" data-tab="audit-trail">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8V23l4-4-4-4v3z"
              />
            </svg>
            Audit Trail
          </div>

          <div class="nav-tab" data-tab="dashboard">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"
              />
            </svg>
            Dashboard
          </div>
        </div>
      </nav>

      <!-- Main Content Area -->
      <main class="content-area" id="contentArea">
        <p>Content for Dashboard will appear here.</p>
      </main>
    </div>

      </div>

      <!-- Footer Section -->
      <footer class="footer">&copy; 2025 Barclays. All rights reserved.</footer>
    </div>

    <!-- Modal for Trade Log Details (for Audit Trail) -->
    <div
      id="tradeLogModal"
      class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/2 lg:w-1/3">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
          <h3 class="text-xl font-semibold text-gray-800">
            Trade Log Details for
            <span id="modalTradeId" class="text-blue-600"></span>
          </h3>
          <button
            id="closeModal"
            class="text-gray-500 hover:text-gray-700 text-2xl font-bold"
          >
            &times;
          </button>
        </div>
        <div
          id="modalContent"
          class="text-gray-700 text-sm max-h-96 overflow-y-auto"
        >
          <!-- Log details will be populated here -->
        </div>
      </div>
    </div>

    <!-- Gmail Modal -->
    <div
      id="gmailModal"
      class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
          <h3 class="text-xl font-semibold text-gray-800">
            Send Gmail - Trade ID: <span id="gmailTradeId" class="text-blue-600"></span>
          </h3>
          <button
            id="closeGmailModal"
            class="text-gray-500 hover:text-gray-700 text-2xl font-bold"
          >
            &times;
          </button>
        </div>
        
        <div class="space-y-4">
          <!-- Trade Information -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-semibold text-gray-800 mb-2">Trade Information</h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span class="font-medium">Assigned To:</span>
                <span id="gmailAssignedTo" class="ml-2"></span>
              </div>
              <div>
                <span class="font-medium">Reporting Regulation:</span>
                <span id="gmailRegulation" class="ml-2"></span>
              </div>
            </div>
            <div class="mt-2">
              <span class="font-medium">Comments:</span>
              <div id="gmailComments" class="mt-1 p-2 bg-white border rounded text-sm"></div>
            </div>
          </div>

          <!-- Team Selection -->
          <div>
            <label for="teamSelect" class="block text-sm font-medium text-gray-700 mb-2">
              Select Team:
            </label>
            <select id="teamSelect" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">Select a team...</option>
              <option value="Reference">Reference</option>
              <option value="Network Management">Network Management</option>
              <option value="middle office">Middle Office</option>
              <option value="Settlements">Settlements</option>
              <option value="Confirmations">Confirmations</option>
              <option value="Collatreral">Collateral</option>
              <option value="Cost Management">Cost Management</option>
            </select>
          </div>

          <!-- Email Display -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Email Address:
            </label>
            <div id="emailDisplay" class="p-2 bg-gray-100 border rounded-md text-sm font-mono">
              Select a team to see the email address
            </div>
          </div>

          <!-- Send Button -->
          <div class="flex justify-end pt-4">
            <button
              id="sendGmailBtn"
              class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 flex items-center"
              disabled
            >
              <i class="fas fa-paper-plane mr-2"></i>
              Send Gmail
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // Import Firebase functions
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        onSnapshot,
        addDoc,
        updateDoc,
        deleteDoc,
        doc,
        setDoc,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Global Firebase variables
      let app;
      let db;
      let auth;
      let userId = null;
      let unsubscribeExceptionTrades = null; // To store the unsubscribe function for real-time listener

      // Static data from the screenshot for "Regulatory Data" - Limited to 2 rows and 4 columns
      const staticRegulatoryData = [
        {
          "Exception Type": "None",
          "Exception Description": "N/A",
          "Exception Resolution": "N/A",
          "Reporting Regulation": "EMIR",
        },
        {
          "Exception Type": "Regulatory Mismatch",
          "Exception Description": "Reporting currency mismatch",
          "Exception Resolution": "Submitted request to compliance",
          "Reporting Regulation": "MiFID II",
        },
      ];

      // Function to render the regulatory data table
      function renderRegulatoryDataTable(data) {
        if (!data || data.length === 0) {
          return '<p class="text-gray-600 text-center mt-4">No regulatory data available.</p>';
        }

        // Filter out specified columns (including common variations)
        const excludedColumns = [
          'BSB_CODE',
          'BASE_CURRENCY',
          'COSTBOOKEDDATE',
          'SORT_CODE',
          'FXGAINLOSS',
          'IBAN',
          'SOURCE',
          'METHOD',
          'SETTLEMENT_INSTRUCTION',
          'COMMISIONAMOUNT',
          'NETTING_ELIGIBILITY',
          'ABA_ROUTING_NO_',
          'COMMISIONCURRENCY',
          'SWIFT',
          'EXECUTION_VENUE',
          'BENEFICIARY',
          'ACCOUNT_NO',
          'EXPENSE_APPROVAL_STATUS',
          'BROKERAGECURRENCY',
          'UPLOADEDBY',
          'BROKERAGEEE',
          'ZENGIN',
          'UPLOADEDAT',
          'EXPENSEAPPROVALSTATUS',
          'SETTLEMENT_CURRENCY',
          'TERM_CURRENCY',
          'PNLCALCULATED',
          // Additional columns to remove
          'XPENSEAPPROVALSTATUS',
          'ACCOUNT ID',
          'UPLOADBY',
          'BROKERAGEFEE',
          'COMMISSIONCURRENCY',
          'CURRENCY_PAIR',
          // Common variations and alternative spellings
          'BSBCODE',
          'BASECURRENCY',
          'COSTBOOKED',
          'SORTCODE',
          'FXGAIN',
          'FXLOSS',
          'SETTLEMENTINSTRUCTION',
          'COMMISSIONAMOUNT',
          'NETTINGELIGIBILITY',
          'ABAROUTINGNO',
          'COMMISSIONCURRENCY',
          'EXECUTIONVENUE',
          'ACCOUNTNO',
          'EXPENSEAPPROVALSTATUS',
          'BROKERAGECURR',
          'UPLOADEDBY',
          'BROKERAGEFEE',
          'UPLOADEDAT',
          'SETTLEMENTCURRENCY',
          'TERMCURRENCY',
          'PNLCALC',
          'XPENSEAPPROVAL',
          'ACCOUNTID',
          'UPLOADBY',
          'COMMISSIONCURR',
          'CURRENCYPAIR',
          'COMMISIONAMOUNT',
          'NETTING_ELIGIBLITY',
          'BROKERAGEEE',
          'EXPENSE_APPROVAL_STATUS',
          'SETTLEMENT_INSTRUCTION',
          'EXECUTION_VENUE',
          'ABA_ROUTING_NO',
          'COMMISIONCURRENCY',
          // Additional columns to remove
          'CUSTODIAN',
          'AGENT BANK NAME',
          'COSTALLOCATIONSTATUS',
          'CLIENT_ID',
          // Common variations for new columns
          'CUSTODIAN',
          'AGENTBANKNAME',
          'AGENT_BANK_NAME',
          'COSTALLOCATION',
          'COST_ALLOCATION_STATUS',
          'CLIENTID',
          'CLIENT_ID',
          // Additional column to remove
          'PORTFOLIO',
          // Common variations for PORTFOLIO
          'PORTFOLIO',
          'PORTFOLIO_ID',
          'PORTFOLIONAME'
        ];
        
        // Debug: Log all available columns
        console.log("Available columns in data:", Object.keys(data[0]));
        console.log("Excluded columns:", excludedColumns);
        
        // More comprehensive filtering that handles case variations and partial matches
        const headers = Object.keys(data[0]).filter(header => {
          const headerUpper = header.toUpperCase();
          const headerLower = header.toLowerCase();
          
          // Check for exact matches
          if (excludedColumns.includes(header)) {
            console.log(`Excluding exact match: ${header}`);
            return false;
          }
          
          // Check for case-insensitive matches
          if (excludedColumns.some(excluded => excluded.toUpperCase() === headerUpper)) {
            console.log(`Excluding case-insensitive match: ${header}`);
            return false;
          }
          
          // Check for partial matches (in case column names have extra spaces or characters)
          if (excludedColumns.some(excluded => {
            const excludedUpper = excluded.toUpperCase().replace(/\s+/g, '');
            const headerUpperClean = headerUpper.replace(/\s+/g, '');
            return headerUpperClean.includes(excludedUpper) || excludedUpper.includes(headerUpperClean);
          })) {
            console.log(`Excluding partial match: ${header}`);
            return false;
          }
          
          return true;
        });
        
        // Debug: Log which columns are being filtered out
        const filteredOut = Object.keys(data[0]).filter(header => excludedColumns.includes(header));
        console.log("Columns being filtered out:", filteredOut);
        console.log("Final headers:", headers);
        let tableHtml = `
                      <div class="overflow-x-auto rounded-lg shadow-md border border-gray-300 mt-6">
                          <table class="min-w-full bg-white" id="regulatoryDataTable">
                              <thead class="bg-blue-100 border-b border-blue-200">
                                  <tr>
                                      ${headers
                                        .map(
                                          (header) =>
                                            `<th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider border-r border-blue-200">${header}</th>`
                                        )
                                        .join("")}
                                  </tr>
                              </thead>
                              <tbody class="bg-white divide-y divide-gray-200">
                                  ${data
                                    .map(
                                      (row, index) => `
                                      <tr class="hover:bg-gray-50 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                          ${headers
                                            .map(
                                              (header) =>
                                                `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">${row[header] || ''}</td>`
                                            )
                                            .join("")}
                                      </tr>
                                  `
                                    )
                                    .join("")}
                              </tbody>
                          </table>
                      </div>
                  `;
        return tableHtml;
      }

      let reportingTrades;

      // Login functionality
      document.addEventListener('DOMContentLoaded', function() {
        const loginContainer = document.getElementById('loginContainer');
        const portalContent = document.getElementById('portalContent');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');

        // Always show login page on page load/refresh
        // Removed sessionStorage check to ensure login page appears on every refresh

        // Login form submission
        if (loginForm) {
          loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('loginId').value.trim();
            const password = document.getElementById('loginPassword').value;

            // Validate credentials
            if (id === '1234' && password === 'Barclays') {
              // Add audit log entry for successful login
              addAuditLogEntry(
                "Authentication: Login Success",
                "N/A",
                "Security",
                "N/A",
                `User logged in successfully with ID: ${id}`,
                "Not Logged In",
                "Logged In"
              );
              
              // Hide error message
              loginError.classList.add('hidden');
              
              // Store login state
              sessionStorage.setItem('isLoggedIn', 'true');
              
              // Show portal directly
              showPortalWithTradeException();
            } else {
              // Add audit log entry for failed login
              addAuditLogEntry(
                "Authentication: Login Failed",
                "N/A",
                "Security",
                "N/A",
                `Failed login attempt with ID: ${id}`,
                "Not Logged In",
                "Login Failed"
              );
              
              // Show error message
              loginError.classList.remove('hidden');
              
              // Clear password field
              document.getElementById('loginPassword').value = '';
            }
          });
        }

        // Logout functionality
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function() {
            // Add audit log entry for logout
            addAuditLogEntry(
              "Authentication: Logout",
              "N/A",
              "Security",
              "N/A",
              "User logged out successfully",
              "Logged In",
              "Logged Out"
            );
            
            // Clear login state
            sessionStorage.removeItem('isLoggedIn');
            
            // Show login page
            showLogin();
          });
        }



        // Function to show portal
        function showPortal() {
          // Hide login container
          loginContainer.classList.add('hidden');
          
          // Show portal content
          portalContent.classList.remove('hidden');
          
          // Ensure portal content is visible
          portalContent.style.display = 'block';
          
          // Initialize portal functionality
          initializePortal();
        }

        // Function to show portal with Trade Exception tab active
        function showPortalWithTradeException() {
          console.log('showPortalWithTradeException called');
          
          // Hide login container with animation
          if (loginContainer) {
            loginContainer.style.animation = 'fadeInScale 0.5s ease-out reverse';
            setTimeout(() => {
            loginContainer.classList.add('hidden');
              loginContainer.style.animation = '';
            console.log('Login container hidden');
            }, 500);
          }
          
          // Show portal content with animation
          if (portalContent) {
            portalContent.classList.remove('hidden');
            portalContent.style.display = 'block';
            portalContent.style.visibility = 'visible';
            portalContent.style.animation = 'slideInFromTop 1s ease-out';
            console.log('Portal content shown');
          } else {
            console.error('Portal content element not found');
          }
          
          // Initialize portal functionality with Trade Exception tab
          setTimeout(() => {
            console.log('Initializing portal with Trade Exception');
            initializePortalWithTradeException();
          }, 200);
        }

        // Function to show login
        function showLogin() {
          loginContainer.classList.remove('hidden');
          portalContent.classList.add('hidden');
          
          // Clear form
          if (loginForm) {
            loginForm.reset();
          }
          
          // Hide error message
          loginError.classList.add('hidden');
        }

        // Function to initialize portal functionality
        function initializePortal() {
          // Set initial active tab to Trade Exception
          const tradeExceptionTab = document.querySelector('[data-tab="trade-exception"]');
          if (tradeExceptionTab) {
            tradeExceptionTab.classList.add('active');
          }
          
          // Initialize content
          updateContent('trade-exception');
        }

        // Function to initialize portal functionality with Trade Exception tab
        function initializePortalWithTradeException() {
          // Remove active class from all tabs
          document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
          });
          
          // Set Trade Exception as active tab
          const tradeExceptionTab = document.querySelector('[data-tab="trade-exception"]');
          if (tradeExceptionTab) {
            tradeExceptionTab.classList.add('active');
          }
          
          // Initialize content with Trade Exception
          updateContent('trade-exception');
        }


      });

      // Initialize Firebase on window load
      window.onload = async () => {
        const firebaseConfig = {
          apiKey: "AIzaSyCgK8fg7tXgaU-0oWcCGO9bdHWnwImLBmQ",
          authDomain: "barclays-network-management.firebaseapp.com",
          projectId: "barclays-network-management",
          storageBucket: "barclays-network-management.firebasestorage.app",
          messagingSenderId: "308811523712",
          appId: "1:308811523712:web:69e0bc7919d1057cbc2865",
          measurementId: "G-X0HKTS2D3E",
        };

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Expose db, auth, and userId globally for other scripts to use
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.getFirebaseUserId = () => userId;
        window.getAppId = () =>
          typeof __app_id !== "undefined" ? __app_id : "default-app-id";

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
            console.log("Firebase authenticated. User ID:", userId);
            // Initial fetch after auth
            // We will call fetchTradeDataFromDatabase when the tab is activated
          } else {
            try {
              if (typeof __initial_auth_token !== "undefined") {
                await signInWithCustomToken(auth, __initial_auth_token);
              } else {
                await signInAnonymously(auth);
              }
              userId = auth.currentUser.uid;
              console.log(
                "Firebase authenticated (anonymously). User ID:",
                userId
              );
              // We will call fetchTradeDataFromDatabase when the tab is activated
            } catch (error) {
              console.error("Firebase authentication failed:", error);
            }
          }
        });

        const getTrade = async () => {
          const querySnapshot = await getDocs(collection(db, "unified_data"));
          const trades = [];
          querySnapshot.forEach((doc) => {
            // doc.data() is never undefined for query doc snapshots
            trades.push(doc.data());
          });
          console.log("Data from unified_data collection:", trades);
          return trades;
        };
        const getRegulatorydata = async () => {
          const querySnapshot = await getDocs(
            collection(db, "cost_management")
          );
          const trades = [];
          querySnapshot.forEach((doc) => {
            // doc.data() is never undefined for query doc snapshots
            trades.push(doc.data());
          });
          console.log(trades);
          return trades;
        };

        reportingTrades = await getTrade();
        
        // Add sample data if no data is available
        if (!reportingTrades || reportingTrades.length === 0) {
          console.log('No data from Firebase, adding sample data for testing');
          reportingTrades = [
            {
              "TradeID": "TRD001",
              "Trade Date": "2025-01-15",
              "Counterparty": "Goldman Sachs",
              "Product Type": "Interest Rate Swap",
              "Notional Amount": "10,000,000",
              "Reporting Regulation": "MiFID II",
              "Reporting Status": "ACK",
              "Assigned To": "John Smith",
              "Comment": "Successfully reported"
            },
            {
              "TradeID": "TRD002", 
              "Trade Date": "2025-01-16",
              "Counterparty": "Morgan Stanley",
              "Product Type": "FX Forward",
              "Notional Amount": "5,000,000",
              "Reporting Regulation": "EMIR",
              "Reporting Status": "ACK",
              "Assigned To": "Jane Doe",
              "Comment": "Reported to TR"
            },
            {
              "TradeID": "TRD003",
              "Trade Date": "2025-01-17", 
              "Counterparty": "JP Morgan",
              "Product Type": "Credit Default Swap",
              "Notional Amount": "15,000,000",
              "Reporting Regulation": "Dodd Frank",
              "Reporting Status": "NACK",
              "Assigned To": "Mike Johnson",
              "Comment": "Rejected - missing data"
            },
            {
              "TradeID": "TRD004",
              "Trade Date": "2025-01-18",
              "Counterparty": "Citibank",
              "Product Type": "Repo",
              "Notional Amount": "20,000,000", 
              "Reporting Regulation": "SFTR",
              "Reporting Status": "ACK",
              "Assigned To": "Sarah Wilson",
              "Comment": "Securities financing reported"
            },
            {
              "TradeID": "TRD005",
              "Trade Date": "2025-01-19",
              "Counterparty": "Deutsche Bank",
              "Product Type": "FX Option",
              "Notional Amount": "8,000,000",
              "Reporting Regulation": "MAS",
              "Reporting Status": "PENDING",
              "Assigned To": "Tom Brown",
              "Comment": "Awaiting confirmation"
            },
            {
              "TradeID": "TRD006",
              "Trade Date": "2025-01-20",
              "Counterparty": "Barclays",
              "Product Type": "Equity Swap",
              "Notional Amount": "12,000,000",
              "Reporting Regulation": "MiFID II",
              "Reporting Status": "ACK",
              "Assigned To": "Alice Johnson",
              "Comment": "Equity derivative reported"
            },
            {
              "TradeID": "TRD007",
              "Trade Date": "2025-01-21",
              "Counterparty": "UBS",
              "Product Type": "Commodity Swap",
              "Notional Amount": "7,500,000",
              "Reporting Regulation": "EMIR",
              "Reporting Status": "ACK",
              "Assigned To": "Bob Wilson",
              "Comment": "Commodity derivative reported"
            },
            {
              "TradeID": "TRD008",
              "Trade Date": "2025-01-22",
              "Counterparty": "Credit Suisse",
              "Product Type": "Interest Rate Swap",
              "Notional Amount": "25,000,000",
              "Reporting Regulation": "Dodd Frank",
              "Reporting Status": "ACK",
              "Assigned To": "Carol Davis",
              "Comment": "Interest rate derivative reported"
            },
            {
              "TradeID": "TRD009",
              "Trade Date": "2025-01-23",
              "Counterparty": "BNP Paribas",
              "Product Type": "Securities Lending",
              "Notional Amount": "18,000,000",
              "Reporting Regulation": "SFTR",
              "Reporting Status": "NACK",
              "Assigned To": "David Miller",
              "Comment": "Rejected - invalid UTI"
            },
            {
              "TradeID": "TRD010",
              "Trade Date": "2025-01-24",
              "Counterparty": "Societe Generale",
              "Product Type": "FX Swap",
              "Notional Amount": "9,000,000",
              "Reporting Regulation": "MAS",
              "Reporting Status": "ACK",
              "Assigned To": "Eva Garcia",
              "Comment": "FX derivative reported"
            },
            {
              "TradeID": "TRD011",
              "Trade Date": "2025-01-25",
              "Counterparty": "HSBC",
              "Product Type": "Credit Default Swap",
              "Notional Amount": "30,000,000",
              "Reporting Regulation": "MiFID II",
              "Reporting Status": "ACK",
              "Assigned To": "Frank Lee",
              "Comment": "Credit derivative reported"
            },
            {
              "TradeID": "TRD012",
              "Trade Date": "2025-01-26",
              "Counterparty": "Nomura",
              "Product Type": "Repo",
              "Notional Amount": "15,000,000",
              "Reporting Regulation": "SFTR",
              "Reporting Status": "ACK",
              "Assigned To": "Grace Kim",
              "Comment": "Securities financing reported"
            },
            {
              "TradeID": "TRD013",
              "Trade Date": "2025-01-27",
              "Counterparty": "Mizuho",
              "Product Type": "FX Forward",
              "Notional Amount": "6,500,000",
              "Reporting Regulation": "EMIR",
              "Reporting Status": "ACK",
              "Assigned To": "Henry Chen",
              "Comment": "FX derivative reported"
            },
            {
              "TradeID": "TRD014",
              "Trade Date": "2025-01-28",
              "Counterparty": "Sumitomo",
              "Product Type": "Interest Rate Swap",
              "Notional Amount": "22,000,000",
              "Reporting Regulation": "Dodd Frank",
              "Reporting Status": "NACK",
              "Assigned To": "Iris Wang",
              "Comment": "Rejected - missing counterparty data"
            },
            {
              "TradeID": "TRD015",
              "Trade Date": "2025-01-29",
              "Counterparty": "Mitsubishi UFJ",
              "Product Type": "Equity Option",
              "Notional Amount": "11,000,000",
              "Reporting Regulation": "MAS",
              "Reporting Status": "ACK",
              "Assigned To": "Jack Taylor",
              "Comment": "Equity derivative reported"
            }
          ];
        }
        
        // Also populate exceptionTradeData with unified_data for Trade Exception tab
        exceptionTradeData = await getTrade();
        
        // Refresh regulatory frameworks content if it's currently visible
        refreshRegulatoryFrameworksContent();
        
        // Set default exception statuses based on trade index
        exceptionTradeData.forEach((trade, index) => {
          const tradeId = trade.TRADEID || trade.TradeID || "";
          const storedStatus = localStorage.getItem(`exceptionStatus_${tradeId}`);
          
          if (storedStatus) {
            // Use stored status if available
            trade.exceptionStatus = storedStatus;
          } else {
            // Set default statuses based on index (1-based for user reference)
            const tradeNumber = index + 1;
            if (tradeNumber === 1 || tradeNumber === 2) {
              trade.exceptionStatus = "Open";
            } else if (tradeNumber === 3) {
              trade.exceptionStatus = "Resolved";
            } else if (tradeNumber === 4) {
              trade.exceptionStatus = "Open";
            } else if (tradeNumber === 5 || tradeNumber === 6) {
              trade.exceptionStatus = "Under Review";
            } else if (tradeNumber === 7) {
              trade.exceptionStatus = "Resolved";
            } else if (tradeNumber === 8) {
              trade.exceptionStatus = "Open";
            } else {
              trade.exceptionStatus = "Default";
            }
            // Store the default status
            localStorage.setItem(`exceptionStatus_${tradeId}`, trade.exceptionStatus);
          }
        });

        // Initialize tab switching functionality
        const navTabs = document.getElementById("navTabs");
        const contentArea = document.getElementById("contentArea");

        if (navTabs && contentArea) {
          // Add click event listener to the navigation tabs container
          navTabs.addEventListener("click", (event) => {
            console.log("Tab click event triggered");
            const clickedTab = event.target.closest(".nav-tab");
            console.log("Clicked tab:", clickedTab);

            // If a tab was clicked
            if (clickedTab) {
              console.log("Tab clicked:", clickedTab.dataset.tab);
              
              // Remove 'active' class from all tabs
              document.querySelectorAll(".nav-tab").forEach((tab) => {
                tab.classList.remove("active");
              });

              // Add 'active' class to the clicked tab
              clickedTab.classList.add("active");

              // Get the data-tab attribute to determine which content to show
              const tabName = clickedTab.dataset.tab;
              console.log("Switching to tab:", tabName);

              // Add audit log entry for tab navigation (only if logged in)
              if (sessionStorage.getItem('isLoggedIn') === 'true') {
                addAuditLogEntry(
                  "Navigation: Tab Switch",
                  "N/A",
                  "User Interface",
                  "N/A",
                  `User navigated to ${tabName} tab`,
                  "N/A",
                  tabName
                );
              }

              // Update the content area
              updateContent(tabName);
            } else {
              console.log("No tab was clicked, target:", event.target);
            }
          });

          // Set initial content for the active tab (only if logged in)
          if (sessionStorage.getItem('isLoggedIn') === 'true') {
            updateContent("trade-exception"); // Start with Trade Exception tab
            // Set the first tab as active
            const firstTab = document.querySelector('.nav-tab');
            if (firstTab) {
              firstTab.classList.add('active');
            }
          }
        }
      };
      //  dddddddddddddd
      // Function to fetch data from Firestore and set up real-time listener
      window.fetchTradeDataFromDatabase = async () => {
        if (!window.firebaseDb || !window.getFirebaseUserId()) {
          console.warn(
            "Firebase not initialized or user not authenticated yet. Retrying in 1 second..."
          );
          setTimeout(window.fetchTradeDataFromDatabase, 1000);
          return;
        }

        const loadingIndicator = document.getElementById("loadingIndicator");
        if (loadingIndicator) loadingIndicator.classList.remove("hidden");

        // Unsubscribe from previous listener if it exists to avoid multiple listeners
        if (unsubscribeExceptionTrades) {
          unsubscribeExceptionTrades();
          unsubscribeExceptionTrades = null;
          console.log("Unsubscribed from previous exception trades listener.");
        }

        const exceptionsCollectionRef = collection(
          window.firebaseDb,
          `artifacts/${window.getAppId()}/public/data/tradeExceptions`
        );

        try {
          // Set up real-time listener
          unsubscribeExceptionTrades = onSnapshot(
            exceptionsCollectionRef,
            (snapshot) => {
              const fetchedData = [];
              snapshot.forEach((doc) => {
                fetchedData.push({ id: doc.id, ...doc.data() });
              });
              console.log("Fetched data from Firestore:", fetchedData);
              exceptionTradeData = fetchedData; // Update global data
              
              // Apply stored statuses from localStorage to fetched data
              exceptionTradeData.forEach((trade) => {
                const tradeId = trade.TRADEID || trade.TradeID || "";
                const storedStatus = localStorage.getItem(`exceptionStatus_${tradeId}`);
                if (storedStatus) {
                  trade.exceptionStatus = storedStatus;
                }
              });
              
              renderExceptionTable(exceptionTradeData); // Re-render table with fetched data
              if (loadingIndicator) loadingIndicator.classList.add("hidden");
            },
            (error) => {
              console.error(
                "Error fetching real-time data from Firestore:",
                error
              );
              if (loadingIndicator) loadingIndicator.classList.add("hidden");
            }
          );
        } catch (error) {
          console.error("Error setting up Firestore listener:", error);
          if (loadingIndicator) loadingIndicator.classList.add("hidden");
        }
      };

      // Function to save/update trade exception to Firestore
      window.saveExceptionTradeToFirestore = async (trade) => {
        if (!window.firebaseDb || !window.getFirebaseUserId()) {
          console.error(
            "Firebase not initialized or user not authenticated. Cannot save trade."
          );
          return;
        }
        try {
          // Check if the trade already exists (has an an ID)
          if (trade.id) {
            const tradeRef = doc(
              window.firebaseDb,
              `artifacts/${window.getAppId()}/public/data/tradeExceptions`,
              trade.id
            );
            await setDoc(tradeRef, trade, { merge: true }); // Use setDoc with merge to update
            console.log("Trade updated in Firestore:", trade.id);
          } else {
            // If no ID, it's a new trade, add it
            const docRef = await addDoc(
              collection(
                window.firebaseDb,
                `artifacts/${window.getAppId()}/public/data/tradeExceptions`
              ),
              trade
            );
            console.log("New trade added to Firestore with ID:", docRef.id);
            // Optionally, update the local data with the new ID if you want to allow further edits
            // This might require re-fetching or carefully updating the local array
          }
        } catch (error) {
          console.error("Error saving/updating trade in Firestore:", error);
        }
      };

      // Function to delete trade exception from Firestore
      window.deleteExceptionTradeFromFirestore = async (tradeId) => {
        if (!window.firebaseDb || !window.getFirebaseUserId()) {
          console.error(
            "Firebase not initialized or user not authenticated. Cannot delete trade."
          );
          return;
        }
        try {
          await deleteDoc(
            doc(
              window.firebaseDb,
              `artifacts/${window.getAppId()}/public/data/tradeExceptions`,
              tradeId
            )
          );
          console.log("Trade deleted from Firestore:", tradeId);
        } catch (error) {
          console.error("Error deleting trade from Firestore:", error);
        }
      };

      // Global state for Trade Exception
      let exceptionTradeData = []; // Start with empty data, will be populated from DB or mock
      let exceptionCurrentSortColumn = null;
      let exceptionCurrentSortDirection = "asc"; // 'asc' or 'desc'
      let exceptionActiveFilters = {}; // Stores { columnKey: filterValue }

      // Global state for Trade Reporting

      let reportingCurrentSort = { key: null, direction: "asc" };
      window.reportingActiveFilters = {}; // Stores { columnKey: { type: 'text'|'checkbox'|'dateRange'|'numberRange', value: string|array|{from,to}|{min,max} } }

      // Global state for Audit Trail
      // Initial auditData is now empty as requested, entries will be added dynamically
      const auditData = [];
      let auditCurrentSortColumn = null;
      let auditSortDirection = "asc"; // 'asc' or 'desc'

      // const navTabs = document.getElementById('navTabs'); // Defined in window.onload
      // const contentArea = document.getElementById('contentArea'); // Defined in window.onload
      let currentActiveTab = "dashboard"; // Keep track of the currently active tab

      // Function to add an entry to the audit log
      function addAuditLogEntry(
        actionType,
        tradeID,
        department,
        regulationAffected,
        remarks,
        statusBefore = "N/A",
        statusAfter = "N/A"
      ) {
        const timestamp = new Date().toLocaleString();
        const newEntry = {
          timestamp,
          actionType,
          tradeID,
          department,
          regulationAffected,
          remarks,
          statusBefore,
          statusAfter,
        };
        auditData.push(newEntry);
        console.log("Audit Log Entry Added:", newEntry);

        // If currently on the audit-trail tab, re-render it to show the new entry
        if (currentActiveTab === "audit-trail") {
          applyAuditFiltersAndSort();
        }
        
        // Make function globally accessible for testing
        window.addAuditLogEntry = addAuditLogEntry;
        window.auditData = auditData;
        
        // Add test function for tab switching
        window.testTabSwitch = function(tabName) {
          console.log("Testing tab switch to:", tabName);
          updateContent(tabName);
        };
      }

      // --- Trade Exception Specific Functions ---
      // Helper function to get field value
      function getFieldValue(trade, columnKey) {
        switch (columnKey) {
          case "id":
            return trade.TRADEID || trade.TradeID || trade.tradeId || "";
          case "tradeDate":
            return trade.TRADEDATA || trade.TradeDate || trade.tradeDate || trade.date || "";
          case "counterparty":
            return trade.COUNTERPARTY || trade.Counterparty || "";
          case "productType":
            return trade.ProductType || trade.productType || "";
          case "notionalAmount":
            return trade.NOTIONALAMOUNT || trade.NotionalAmount || trade.notionalAmount || "";
          case "exceptionType":
            return trade.EXCEPTIONTYPE || trade["Exception Type"] || trade.exceptionType || "";
          case "exceptionDescription":
            return trade["EXCEPTION DESCRIPTION"] || trade["Exception Description"] || trade.exceptionDescription || "";
          case "exceptionResolution":
            return trade["EXCEPTION RESOLUTION"] || trade["Exception Resolution"] || trade.exceptionResolution || "";
          case "exceptionStatus":
            return trade.exceptionStatus || trade.ExceptionFlag || trade.SettlementStatus || trade.TradeStatus || "Default";
          case "assignedTo":
            return trade.assignedTo || "";
          case "comment":
            return trade.comments || trade.notes || trade.comment || "";
          default:
            return trade[columnKey] || "";
        }
      }

      // Function to apply filters to exception data
      function applyExceptionFilters(data) {
        console.log("Applying filters. Active filters:", exceptionActiveFilters);
        let filteredData = data.filter((trade) => {
          for (const key in exceptionActiveFilters) {
            const filter = exceptionActiveFilters[key];
            const fieldValue = getFieldValue(trade, key);
            
            console.log(`Filtering trade ${trade.TRADEID || trade.TradeID || 'unknown'}:`, key, fieldValue, filter);
            
            if (filter.type === "text") {
              if (
                !String(fieldValue)
                  .toLowerCase()
                  .includes(filter.value.toLowerCase())
              ) {
                console.log(`Trade filtered out by text filter: ${key}`);
                return false;
              }
            } else if (filter.type === "checkbox" && filter.value.length > 0) {
              if (!filter.value.includes(fieldValue)) {
                console.log(`Trade filtered out by checkbox filter: ${key}, value: ${fieldValue}, allowed: ${filter.value}`);
                return false;
              }
            } else if (filter.type === "dateRange") {
              const tradeDate = new Date(fieldValue);
              if (filter.from && tradeDate < new Date(filter.from))
                return false;
              if (filter.to && tradeDate > new Date(filter.to)) return false;
            } else if (filter.type === "numberRange") {
              const notional = parseFloat(
                String(fieldValue).replace(/[^0-9.-]+/g, "")
              );
              if (filter.min !== "" && notional < parseFloat(filter.min))
                return false;
              if (filter.max !== "" && notional > parseFloat(filter.max))
                return false;
            }
          }
          return true;
        });
        
        console.log(`Filtered data: ${filteredData.length} trades out of ${data.length}`);
        return filteredData;
      }

      // Function to render the Trade Exception table
      function renderExceptionTable(data) {
        console.log(data);
        const tableBody = document.getElementById("exception-table-body");
        if (!tableBody) return; // Ensure element exists before manipulating

        tableBody.innerHTML = ""; // Clear existing rows

        // Apply filters first
        let filteredData = applyExceptionFilters(data);
        
        console.log(`Filtered data: ${filteredData.length} trades out of ${data.length}`);

        // Apply sorting
        if (exceptionCurrentSortColumn) {
          filteredData.sort((a, b) => {
            let valA = getFieldValue(a, exceptionCurrentSortColumn);
            let valB = getFieldValue(b, exceptionCurrentSortColumn);

            if (exceptionCurrentSortColumn === "notionalAmount") {
              valA = parseFloat(String(valA).replace(/[^0-9.-]+/g, "")) || 0;
              valB = parseFloat(String(valB).replace(/[^0-9.-]+/g, "")) || 0;
            } else if (exceptionCurrentSortColumn === "tradeDate") {
              valA = new Date(valA || 0);
              valB = new Date(valB || 0);
            } else {
              valA = String(valA || "").toLowerCase();
              valB = String(valB || "").toLowerCase();
            }

            if (valA < valB) {
              return exceptionCurrentSortDirection === "asc" ? -1 : 1;
            }
            if (valA > valB) {
              return exceptionCurrentSortDirection === "asc" ? 1 : -1;
            }
            return 0;
          });
        }

        filteredData.forEach((trade) => {
          // Map Firebase unified_data collection fields to table columns
          const tradeId = trade.TRADEID || trade.TradeID || "";
          const tradeDate = trade.TRADEDATA || trade.TradeDate || trade.tradeDate || trade.date || "";
          const counterparty = trade.COUNTERPARTY || trade.Counterparty || "";
          const productType = trade.ProductType || trade.productType || "";
          const notionalAmount = trade.NOTIONALAMOUNT || trade.NotionalAmount || trade.notionalAmount || "";
          const exceptionType = trade.EXCEPTIONTYPE || trade["Exception Type"] || trade.exceptionType || "";
          const exceptionDescription = trade["EXCEPTION DESCRIPTION"] || trade["Exception Description"] || trade.exceptionDescription || "";
          const exceptionResolution = trade["EXCEPTION RESOLUTION"] || trade["Exception Resolution"] || trade.exceptionResolution || "";
          // Get stored status from localStorage or use default
          const storedStatus = localStorage.getItem(`exceptionStatus_${tradeId}`);
          const exceptionStatus = storedStatus || 
            trade.ExceptionFlag ||
            trade.exceptionStatus ||
            trade.SettlementStatus ||
            trade.TradeStatus ||
            "Default";
          const assignedTo = trade.assignedTo || "";
          const comment = trade.comments || trade.notes || trade.comment || "";

          // Status color logic for dropdown options
          let statusColorClass = "";
          if (!exceptionStatus || exceptionStatus === "Default") {
            statusColorClass = "text-gray-600";
          } else if (exceptionStatus === "Open") {
            statusColorClass = "text-red-600";
          } else if (exceptionStatus === "Under Review") {
            statusColorClass = "text-yellow-600";
          } else if (exceptionStatus === "Resolved") {
            statusColorClass = "text-green-600";
          }

          const row = document.createElement("tr");
          row.className = "hover:bg-gray-50";
          row.innerHTML = `
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-black">${tradeId}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-black">${tradeDate}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-black">${counterparty}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-black">${productType}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-black">${notionalAmount}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">${exceptionType}</td>
                  <td class="px-6 py-4 text-sm text-red-600 max-w-xs overflow-hidden text-ellipsis">${exceptionDescription}</td>
                  <td class="px-6 py-4 text-sm text-green-600 max-w-xs overflow-hidden text-ellipsis">${exceptionResolution}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-black">
                    <select class="w-full border rounded-md p-2 text-sm" data-id="${tradeId}" data-field="exceptionStatus" data-old-value="${exceptionStatus || 'Default'}">
                      <option value="Default" ${!exceptionStatus || exceptionStatus === "Default" ? "selected" : ""} class="text-gray-600">Default</option>
                      <option value="Open" ${exceptionStatus === "Open" ? "selected" : ""} class="text-red-600">Open</option>
                      <option value="Under Review" ${exceptionStatus === "Under Review" ? "selected" : ""} class="text-yellow-600">Under Review</option>
                      <option value="Resolved" ${exceptionStatus === "Resolved" ? "selected" : ""} class="text-green-600">Resolved</option>
                    </select>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-black">
                    <input type="text" class="w-full border rounded-md p-2 text-sm" data-id="${tradeId}" data-field="assignedTo" value="${assignedTo}" data-old-value="${assignedTo}">
                  </td>
                  <td class="px-6 py-4 text-sm text-black max-w-xs overflow-hidden text-ellipsis">
                    <textarea class="w-full border rounded-md p-2 text-sm" data-id="${tradeId}" data-field="comment" data-old-value="${comment}">${comment}</textarea>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-900">
                  </td>
                `;
          tableBody.appendChild(row);
          
          // Add Gmail button to the Communications column
          const communicationsCell = row.cells[row.cells.length - 1]; // Last cell is Communications
          const gmailButton = document.createElement("button");
          gmailButton.innerHTML = '<i class="fas fa-envelope text-blue-600"></i>';
          gmailButton.classList.add(
            "px-3",
            "py-1",
            "bg-blue-100",
            "hover:bg-blue-200",
            "text-blue-600",
            "rounded",
            "transition-colors",
            "duration-200",
            "text-sm"
          );
          gmailButton.title = "Send Gmail";
          
          // Add click event for Gmail functionality
          gmailButton.addEventListener("click", () => {
            showGmailModal(tradeId, assignedTo, comment, exceptionType);
          });
          
          communicationsCell.appendChild(gmailButton);
        });

        // Attach event listeners for the newly rendered elements
        tableBody
          .querySelectorAll('input[data-field="assignedTo"]')
          .forEach((input) => {
            input.addEventListener("change", (e) =>
              updateExceptionTradeData(e.target)
            );
          });
        tableBody
          .querySelectorAll('textarea[data-field="comment"]')
          .forEach((textarea) => {
            textarea.addEventListener("change", (e) =>
              updateExceptionTradeData(e.target)
            );
          });
        tableBody
          .querySelectorAll('select[data-field="exceptionStatus"]')
          .forEach((select) => {
            select.addEventListener("change", (e) => {
              console.log("Status dropdown changed:", e.target.value);
              updateExceptionTradeData(e.target);
              
              // Force immediate chart update with multiple attempts
              setTimeout(() => {
                console.log("Forcing chart update from dropdown change...");
                const filteredData = applyExceptionFilters(exceptionTradeData);
                updateExceptionDashboardSummary(filteredData);
                
                // Destroy existing charts first
                if (exceptionStatusChartInstance) {
                  try {
                    exceptionStatusChartInstance.destroy();
                    exceptionStatusChartInstance = null;
                  } catch (error) {
                    console.log("Error destroying status chart:", error);
                  }
                }
                if (exceptionTypeChartInstance) {
                  try {
                    exceptionTypeChartInstance.destroy();
                    exceptionTypeChartInstance = null;
                  } catch (error) {
                    console.log("Error destroying type chart:", error);
                  }
                }
                
                // Recreate charts with new data
                renderExceptionCharts(filteredData);
                window.updateStatusBreakdownChart();
              }, 100);
              
              // Additional backup update
              setTimeout(() => {
                console.log("Backup chart update...");
                const filteredData = applyExceptionFilters(exceptionTradeData);
                renderExceptionCharts(filteredData);
                window.updateStatusBreakdownChart();
              }, 300);
            });
          });

        updateExceptionDashboardSummary(filteredData); // Update summary based on filtered data
        renderExceptionCharts(filteredData); // Render charts based on filtered data
        
        // Re-attach event listeners for the table headers
        setTimeout(() => {
          attachExceptionTableEventListeners();
        }, 100);
        
        // Also try again after a longer delay to ensure DOM is ready
        setTimeout(() => {
          attachExceptionTableEventListeners();
        }, 500);
      }

      // Function to update trade data (mock update for now)
      function updateExceptionTradeData(element) {
        const tradeId = element.dataset.id;
        const field = element.dataset.field;
        const oldValue = element.dataset.oldValue; // Get the old value
        const newValue = element.value;
        const tradeIndex = exceptionTradeData.findIndex(
          (trade) => trade.id === tradeId
        );

        if (tradeIndex !== -1 && oldValue !== newValue) {
          // Only log if value actually changed
          const oldTrade = { ...exceptionTradeData[tradeIndex] }; // Clone for statusBefore/After
          exceptionTradeData[tradeIndex][field] = newValue;
          // Update the old-value data attribute for future changes
          element.dataset.oldValue = newValue;

          let actionType = `Manual: ${formatTabName(field)} Update`;
          let remarks = `${formatTabName(
            field
          )} changed from '${oldValue}' to '${newValue}'.`;
          let statusBefore = oldTrade.exceptionStatus;
          let statusAfter = exceptionTradeData[tradeIndex].exceptionStatus;

          if (field === "exceptionStatus") {
            actionType = `Manual: Exception Status Update`;
            remarks = `Exception status changed from '${oldValue}' to '${newValue}'.`;
            statusBefore = oldValue;
            statusAfter = newValue;
            // Save to localStorage for persistence
            localStorage.setItem(`exceptionStatus_${tradeId}`, newValue);
          } else if (field === "assignedTo") {
            actionType = `Manual: Assignment Update`;
            remarks = `Assigned to changed from '${oldValue}' to '${newValue}'.`;
          } else if (field === "comment") {
            actionType = `Manual: Comment Update`;
            remarks = `Comment updated.`;
          }

          addAuditLogEntry(
            actionType,
            tradeId,
            "Operations", // Assuming Operations department for these changes
            "N/A", // Regulation affected might be specific, or N/A
            remarks,
            statusBefore,
            statusAfter
          );
          
          // Refresh audit trail if currently on audit trail tab
          if (currentActiveTab === "audit-trail") {
            setTimeout(() => {
              renderAuditTable(auditData);
            }, 100);
          }

          // Save to Firestore
          window.saveExceptionTradeToFirestore(exceptionTradeData[tradeIndex]);

          renderExceptionTable(exceptionTradeData); // Re-render table to reflect changes and re-apply filters/sort
          
                    // Update charts when exception status changes
          if (field === "exceptionStatus") {
            console.log("Status changed, updating charts...");
            console.log("Updated trade data:", exceptionTradeData);
            
            // Get filtered data for charts (same logic as in renderExceptionTable)
            const filteredData = applyExceptionFilters(exceptionTradeData);
            console.log("Filtered data for charts:", filteredData);
            
            // Update dashboard summary immediately
            updateExceptionDashboardSummary(filteredData);
            
            // Force chart update with multiple attempts
            console.log("Forcing chart update...");
            
            // Method 1: Destroy and recreate charts immediately
            if (exceptionStatusChartInstance) {
              try {
                exceptionStatusChartInstance.destroy();
                console.log("Destroyed existing status chart");
              } catch (error) {
                console.log("Error destroying status chart:", error);
              }
              exceptionStatusChartInstance = null;
            }
            
            if (exceptionTypeChartInstance) {
              try {
                exceptionTypeChartInstance.destroy();
                console.log("Destroyed existing type chart");
              } catch (error) {
                console.log("Error destroying type chart:", error);
              }
              exceptionTypeChartInstance = null;
            }
            
            // Method 2: Force immediate update
            setTimeout(() => {
              console.log("Method 2: Immediate chart update...");
              renderExceptionCharts(filteredData);
            }, 100);
            
            // Method 3: Specific status chart update
            setTimeout(() => {
              console.log("Method 3: Specific status chart update...");
              window.updateStatusBreakdownChart();
            }, 200);
            
            // Method 4: Final backup update
            setTimeout(() => {
              console.log("Method 4: Final backup update...");
              renderExceptionCharts(filteredData);
              window.updateStatusBreakdownChart();
            }, 400);
            
            // Method 5: Additional backup with fresh data
            setTimeout(() => {
              console.log("Method 5: Additional backup update...");
              const freshFilteredData = applyExceptionFilters(exceptionTradeData);
              renderExceptionCharts(freshFilteredData);
              window.updateStatusBreakdownChart();
            }, 600);
            
            console.log("All chart update methods scheduled");
          }
      
      // Test function to manually update charts
      window.testChartUpdate = function() {
        console.log("Manual chart update test...");
        const filteredData = applyExceptionFilters(exceptionTradeData);
        console.log("Test filtered data:", filteredData);
        updateExceptionDashboardSummary(filteredData);
        
        // Destroy existing charts first
        if (exceptionStatusChartInstance) {
          try {
            exceptionStatusChartInstance.destroy();
            exceptionStatusChartInstance = null;
          } catch (error) {
            console.log("Error destroying status chart:", error);
          }
        }
        if (exceptionTypeChartInstance) {
          try {
            exceptionTypeChartInstance.destroy();
            exceptionTypeChartInstance = null;
          } catch (error) {
            console.log("Error destroying type chart:", error);
          }
        }
        
        renderExceptionCharts(filteredData);
        window.updateStatusBreakdownChart();
        console.log("Manual chart update completed");
      };
      
      // Function to force refresh charts
      window.refreshExceptionCharts = function() {
        console.log("Force refreshing exception charts...");
        if (exceptionStatusChartInstance) {
          exceptionStatusChartInstance.destroy();
          exceptionStatusChartInstance = null;
        }
        if (exceptionTypeChartInstance) {
          exceptionTypeChartInstance.destroy();
          exceptionTypeChartInstance = null;
        }
        const filteredData = applyExceptionFilters(exceptionTradeData);
        renderExceptionCharts(filteredData);
        console.log("Charts refreshed successfully");
      };
      
      // Function to force update all charts immediately
      window.forceUpdateCharts = function() {
        console.log("Force updating all charts...");
        const filteredData = applyExceptionFilters(exceptionTradeData);
        updateExceptionDashboardSummary(filteredData);
        
        // Destroy existing charts first
        if (exceptionStatusChartInstance) {
          try {
            exceptionStatusChartInstance.destroy();
            exceptionStatusChartInstance = null;
          } catch (error) {
            console.log("Error destroying status chart:", error);
          }
        }
        if (exceptionTypeChartInstance) {
          try {
            exceptionTypeChartInstance.destroy();
            exceptionTypeChartInstance = null;
          } catch (error) {
            console.log("Error destroying type chart:", error);
          }
        }
        
        renderExceptionCharts(filteredData);
        window.updateStatusBreakdownChart();
        console.log("Force update completed");
      };
      
      // Function to test status change simulation
      window.testStatusChange = function() {
        console.log("Testing status change simulation...");
        // Simulate changing a status
        if (exceptionTradeData.length > 0) {
          const firstTrade = exceptionTradeData[0];
          const oldStatus = firstTrade.exceptionStatus || 'Default';
          firstTrade.exceptionStatus = oldStatus === 'Open' ? 'Resolved' : 'Open';
          console.log(`Changed status from ${oldStatus} to ${firstTrade.exceptionStatus}`);
          
          // Trigger chart updates
          const filteredData = applyExceptionFilters(exceptionTradeData);
          updateExceptionDashboardSummary(filteredData);
          
          // Destroy and recreate charts
          if (exceptionStatusChartInstance) {
            try {
              exceptionStatusChartInstance.destroy();
              exceptionStatusChartInstance = null;
            } catch (error) {
              console.log("Error destroying status chart:", error);
            }
          }
          if (exceptionTypeChartInstance) {
            try {
              exceptionTypeChartInstance.destroy();
              exceptionTypeChartInstance = null;
            } catch (error) {
              console.log("Error destroying type chart:", error);
            }
          }
          
          renderExceptionCharts(filteredData);
          window.updateStatusBreakdownChart();
          console.log("Status change test completed");
        }
      };
      
      // Function to specifically update status breakdown chart
      window.updateStatusBreakdownChart = function() {
        console.log("Updating status breakdown chart...");
        const filteredData = applyExceptionFilters(exceptionTradeData);
        
        // Count statuses
        const statusCounts = filteredData.reduce((acc, trade) => {
          const status = trade.exceptionStatus || "Default";
          acc[status] = (acc[status] || 0) + 1;
          return acc;
        }, {});
        
        // Filter out "Default" from the chart data
        const filteredStatusCounts = Object.fromEntries(
          Object.entries(statusCounts).filter(([key]) => key !== "Default")
        );
        
        const statusLabels = Object.keys(filteredStatusCounts);
        const statusData = Object.values(filteredStatusCounts);
        
        console.log("Status breakdown data:", statusLabels, statusData);
        
        // Update the chart
        if (exceptionStatusChartInstance) {
          exceptionStatusChartInstance.destroy();
          exceptionStatusChartInstance = null;
        }
        
        const ctxStatus = document.getElementById("exceptionStatusChart");
        if (ctxStatus && statusLabels.length > 0 && statusData.length > 0) {
          const statusColors = statusLabels.map(label => {
            switch (label.toLowerCase()) {
              case 'open':
                return '#ef4444'; // Red
              case 'under review':
                return '#eab308'; // Yellow
              case 'resolved':
                return '#22c55e'; // Green
              default:
                return '#6b7280'; // Gray
            }
          });
          
          exceptionStatusChartInstance = new Chart(ctxStatus, {
            type: "pie",
            data: {
              labels: statusLabels,
              datasets: [{
                data: statusData,
                backgroundColor: statusColors,
                hoverOffset: 4,
              }],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                  labels: { font: { size: 10 } },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      let label = context.label || "";
                      if (label) {
                        label += ": ";
                      }
                      if (context.parsed !== null) {
                        label += context.parsed;
                      }
                      return label;
                    },
                  },
                },
              },
            },
          });
          console.log("Status breakdown chart updated successfully");
        }
      };
          
          console.log(
            `Updated Trade ID: ${tradeId}, Field: ${field}, New Value: ${newValue}`
          );
        }
      }

      // Function to delete a trade (mock delete for now)
      function deleteExceptionTrade(tradeId) {
        const initialLength = exceptionTradeData.length;
        const deletedTrade = exceptionTradeData.find(
          (trade) => trade.id === tradeId
        );
        exceptionTradeData = exceptionTradeData.filter(
          (trade) => trade.id !== tradeId
        );
        if (exceptionTradeData.length < initialLength) {
          // Add audit log for deletion
          addAuditLogEntry(
            "Manual: Trade Deletion",
            tradeId,
            "Operations",
            "N/A", // Regulation affected might be specific, or N/A
            `Trade ${tradeId} deleted.`,
            deletedTrade ? deletedTrade.exceptionStatus : "N/A",
            "Deleted"
          );
          // Delete from Firestore
          window.deleteExceptionTradeFromFirestore(tradeId);

          renderExceptionTable(exceptionTradeData);
          console.log(`Deleted Trade ID: ${tradeId}`);
        }
      }

      // Function to update dashboard summary (dynamic parts only)
      function updateExceptionDashboardSummary(data) {
        const openCount = data.filter(
          (trade) => trade.exceptionStatus === "Open"
        ).length;
        const underReviewCount = data.filter(
          (trade) => trade.exceptionStatus === "Under Review"
        ).length;
        const resolvedCount = data.filter(
          (trade) => trade.exceptionStatus === "Resolved"
        ).length;
        const defaultCount = data.filter(
          (trade) => !trade.exceptionStatus || trade.exceptionStatus === "Default"
        ).length;
        const totalExceptions = data.length;

        // Create summary items array, excluding Default completely
        const summaryItems = [
          { label: "Exception Trades", count: totalExceptions, color: "text-red-600" },
          { label: "Open", count: openCount, color: "text-red-600" },
          { label: "Under Review", count: underReviewCount, color: "text-yellow-600" },
          { label: "Resolved", count: resolvedCount, color: "text-green-600" }
        ];

        const summaryHtml = `
          <div class="flex flex-wrap justify-center items-center gap-8">
            ${summaryItems.map(item => `
              <div class="flex items-center space-x-2">
                <span class="font-semibold">${item.label}</span>
                <span class="${item.color} font-bold text-2xl">${item.count}</span>
              </div>
            `).join('')}
          </div>
                  `;
        const dashboardSummaryElement = document.getElementById(
          "exception-dashboard-summary"
        );
        if (dashboardSummaryElement) {
          dashboardSummaryElement.innerHTML = summaryHtml;
        }
      }

      // --- Dropdown/Sort/Filter Logic for Trade Exception ---
      function attachExceptionTableEventListeners() {
        console.log("Attaching exception table event listeners...");
        
        // Multiple attempts to ensure listeners are attached
        const attachListeners = () => {
          // Find the exception table
          const exceptionTable = document.querySelector("#exception-table-body");
          if (!exceptionTable) {
            console.log("Exception table not found, retrying...");
            return false;
          }
          
          const table = exceptionTable.closest("table");
          if (!table) {
            console.log("Table element not found, retrying...");
            return false;
          }
          
          const headers = table.querySelectorAll("thead th .header-container");
          console.log("Found headers:", headers.length);
          
          if (headers.length === 0) {
            console.log("No headers found, retrying...");
            return false;
          }
          
          headers.forEach((header, index) => {
          const columnKey = header.dataset.column;
          const dropdownMenu = header.querySelector(".dropdown-menu");
            const filterIcon = header.querySelector(".fas.fa-caret-down");

            console.log(`Header ${index}:`, columnKey, "Dropdown:", !!dropdownMenu, "Icon:", !!filterIcon);

            if (header && dropdownMenu && filterIcon) {
              // Remove existing event listeners
              header.removeEventListener("click", header._clickHandler);
              filterIcon.removeEventListener("click", filterIcon._clickHandler);
              
              // Create new event handler for header
              header._clickHandler = (event) => {
                console.log("Header clicked:", columnKey);
                event.preventDefault();
                event.stopPropagation();
                
            // Close other dropdowns
            document.querySelectorAll(".dropdown-menu").forEach((menu) => {
              if (menu !== dropdownMenu) {
                menu.classList.remove("show");
              }
            });
                
            // Toggle visibility
            dropdownMenu.classList.toggle("show");
            populateExceptionDropdown(columnKey, dropdownMenu, filterIcon);
              };
              
              // Create new event handler for filter icon
              filterIcon._clickHandler = (event) => {
                console.log("Filter icon clicked:", columnKey);
                event.preventDefault();
                event.stopPropagation();
                
                // Close other dropdowns
                document.querySelectorAll(".dropdown-menu").forEach((menu) => {
                  if (menu !== dropdownMenu) {
                    menu.classList.remove("show");
                  }
                });
                
                // Toggle visibility
                dropdownMenu.classList.toggle("show");
                populateExceptionDropdown(columnKey, dropdownMenu, filterIcon);
              };
              
              // Add event listeners
              header.addEventListener("click", header._clickHandler);
              filterIcon.addEventListener("click", filterIcon._clickHandler);
              
              console.log(`Event listeners attached for header ${index}:`, columnKey);
            }
          });
          
          return true;
        };
        
        // Try multiple times with different delays
        setTimeout(attachListeners, 100);
        setTimeout(attachListeners, 500);
        setTimeout(attachListeners, 1000);
      }

      // Close dropdowns if clicked outside
      document.addEventListener("click", (event) => {
        document.querySelectorAll(".dropdown-menu").forEach((menu) => {
          if (
            menu.classList.contains("show") &&
            !menu.closest(".header-container").contains(event.target)
          ) {
            menu.classList.remove("show");
          }
        });
      });

      // Test function to manually trigger dropdown
      function testDropdown() {
        console.log("Testing dropdown functionality...");
        const headers = document.querySelectorAll("#exception-table-body").closest("table").querySelectorAll("thead th .header-container");
        console.log("Found headers:", headers.length);
        
        if (headers.length > 0) {
          const firstHeader = headers[0];
          const dropdownMenu = firstHeader.querySelector(".dropdown-menu");
          const filterIcon = firstHeader.querySelector(".fas.fa-caret-down");
          const columnKey = firstHeader.dataset.column;
          
          console.log("Testing with first header:", columnKey);
          console.log("Dropdown menu:", !!dropdownMenu);
          console.log("Filter icon:", !!filterIcon);
          
          if (dropdownMenu && filterIcon) {
            dropdownMenu.classList.toggle("show");
            populateExceptionDropdown(columnKey, dropdownMenu, filterIcon);
          }
        }
      }

      function populateExceptionDropdown(columnKey, dropdownMenu, filterIcon) {
        console.log("Populating dropdown for column:", columnKey);
        console.log("Dropdown menu element:", dropdownMenu);
        console.log("Filter icon element:", filterIcon);
        dropdownMenu.innerHTML = ""; // Clear previous content

        // Sort options
        const sortAscItem = document.createElement("div");
        sortAscItem.className = "dropdown-item";
        sortAscItem.innerHTML =
          '<i class="fas fa-sort-up mr-2"></i> Sort Ascending';
        sortAscItem.onclick = (e) => {
          e.stopPropagation();
          console.log("Sort ascending clicked for:", columnKey);
          sortExceptionData(columnKey, "asc");
          dropdownMenu.classList.remove("show");
        };
        dropdownMenu.appendChild(sortAscItem);

        const sortDescItem = document.createElement("div");
        sortDescItem.className = "dropdown-item";
        sortDescItem.innerHTML =
          '<i class="fas fa-sort-down mr-2"></i> Sort Descending';
        sortDescItem.onclick = (e) => {
          e.stopPropagation();
          console.log("Sort descending clicked for:", columnKey);
          sortExceptionData(columnKey, "desc");
          dropdownMenu.classList.remove("show");
        };
        dropdownMenu.appendChild(sortDescItem);

        // Filter Section
        const filterSection = document.createElement("div");
        filterSection.className = "dropdown-filter-section";
        filterSection.innerHTML =
          '<span class="text-xs font-semibold text-gray-500 block mb-2">Filter By</span>';

        // Map column keys to actual data fields
        const getFieldValue = (trade, columnKey) => {
          switch (columnKey) {
            case "id":
              return trade.TRADEID || trade.TradeID || trade.tradeId || "";
            case "tradeDate":
              return trade.TRADEDATA || trade.TradeDate || trade.tradeDate || trade.date || "";
            case "counterparty":
              return trade.COUNTERPARTY || trade.Counterparty || "";
            case "productType":
              return trade.ProductType || trade.productType || "";
            case "notionalAmount":
              return trade.NOTIONALAMOUNT || trade.NotionalAmount || trade.notionalAmount || "";
            case "exceptionType":
              return trade.EXCEPTIONTYPE || trade["Exception Type"] || trade.exceptionType || "";
            case "exceptionDescription":
              return trade["EXCEPTION DESCRIPTION"] || trade["Exception Description"] || trade.exceptionDescription || "";
            case "exceptionResolution":
              return trade["EXCEPTION RESOLUTION"] || trade["Exception Resolution"] || trade.exceptionResolution || "";
            case "exceptionStatus":
              return trade.exceptionStatus || trade.ExceptionFlag || trade.SettlementStatus || trade.TradeStatus || "Default";
            case "assignedTo":
              return trade.assignedTo || "";
            case "comment":
              return trade.comments || trade.notes || trade.comment || "";
            default:
              return trade[columnKey] || "";
          }
        };

        const uniqueValues = [
          ...new Set(exceptionTradeData.map((trade) => getFieldValue(trade, columnKey))),
        ]
          .filter(Boolean)
          .sort(); // Filter out empty strings and sort

        console.log("Unique values for", columnKey, ":", uniqueValues);
        console.log("Exception trade data length:", exceptionTradeData.length);
        console.log("Sample data for", columnKey, ":", exceptionTradeData.slice(0, 3).map(trade => getFieldValue(trade, columnKey)));
        console.log("Filter type for", columnKey, ":", 
          ["exceptionType", "exceptionStatus", "productType", "counterparty"].includes(columnKey) ? "checkbox" : 
          ["id", "exceptionDescription", "exceptionResolution", "comment", "assignedTo"].includes(columnKey) ? "text" :
          columnKey === "tradeDate" ? "dateRange" :
          columnKey === "notionalAmount" ? "numberRange" : "unknown"
        );

        if (
          [
            "id",
            "exceptionDescription",
            "exceptionResolution",
            "comment",
            "assignedTo",
          ].includes(columnKey)
        ) {
          // Text filter
          const textInput = document.createElement("input");
          textInput.type = "text";
          textInput.placeholder = `Search ${formatTabName(columnKey)}...`;
          textInput.value = exceptionActiveFilters[columnKey]?.value || "";
          textInput.oninput = (e) => {
            console.log("Text filter input:", columnKey, e.target.value);
            exceptionActiveFilters[columnKey] = {
              type: "text",
              value: e.target.value.trim(),
            };
            renderExceptionTable(exceptionTradeData);
            if (e.target.value.trim()) {
              filterIcon.classList.add("active");
            } else {
              filterIcon.classList.remove("active");
            }
          };
          filterSection.appendChild(textInput);
        } else if (
          ["exceptionType", "exceptionStatus", "productType", "counterparty"].includes(
            columnKey
          )
        ) {
          // Checkbox filter
          console.log("Creating checkbox filter for column:", columnKey);
          const checkboxList = document.createElement("div");
          checkboxList.className = "checkbox-list";
          
          // Add "Select All" checkbox
          const selectAllDiv = document.createElement("div");
          const selectAllCheckbox = document.createElement("input");
          selectAllCheckbox.type = "checkbox";
          selectAllCheckbox.id = `filter-${columnKey}-select-all`;
          selectAllCheckbox.className = "select-all-checkbox";
          
          const selectAllLabel = document.createElement("label");
          selectAllLabel.htmlFor = `filter-${columnKey}-select-all`;
          selectAllLabel.textContent = "Select All";
          selectAllLabel.style.fontWeight = "bold";
          selectAllLabel.style.color = "#3b82f6";
          
          selectAllDiv.appendChild(selectAllCheckbox);
          selectAllDiv.appendChild(selectAllLabel);
          checkboxList.appendChild(selectAllDiv);
          
          // Add separator
          const separator = document.createElement("hr");
          separator.style.margin = "0.5rem 0";
          separator.style.borderColor = "#e5e7eb";
          checkboxList.appendChild(separator);
          
          uniqueValues.forEach((val) => {
            console.log("Creating checkbox for value:", val);
            const div = document.createElement("div");
            div.style.marginBottom = "0.25rem";
            div.style.display = "flex";
            div.style.alignItems = "center";
            div.style.gap = "0.5rem";
            
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = `filter-${columnKey}-${val}`;
            checkbox.value = val;
            checkbox.className = "filter-checkbox";
            
            if (
              exceptionActiveFilters[columnKey] &&
              exceptionActiveFilters[columnKey].value.includes(val)
            ) {
              checkbox.checked = true;
            }
            
            // Create a more robust change handler
            const handleCheckboxChange = () => {
              console.log("Checkbox clicked for:", columnKey, "Value:", val, "Checked:", checkbox.checked);
              
              // Get all checked checkboxes
              const checkedBoxes = checkboxList.querySelectorAll("input.filter-checkbox:checked");
              let selectedValues = Array.from(checkedBoxes).map((cb) => cb.value);
              
              console.log("Checkbox filter changed:", columnKey, selectedValues);
              console.log("All checkboxes in list:", checkboxList.querySelectorAll("input.filter-checkbox"));
              console.log("Checked checkboxes:", checkedBoxes);
              
              // Update the active filters
              if (selectedValues.length > 0) {
              exceptionActiveFilters[columnKey] = {
                type: "checkbox",
                value: selectedValues,
              };
                filterIcon.classList.add("active");
              } else {
                delete exceptionActiveFilters[columnKey];
                filterIcon.classList.remove("active");
              }
              
              console.log("Updated active filters:", exceptionActiveFilters);
              
              // Re-render the table
              renderExceptionTable(exceptionTradeData);
            };
            
            // Add multiple event listeners for better reliability
            checkbox.addEventListener('change', handleCheckboxChange);
            checkbox.addEventListener('click', (e) => {
              e.stopPropagation();
              console.log("Checkbox clicked directly:", val);
            });
            
            // Also add click event to label for better UX
            const label = document.createElement("label");
            label.htmlFor = `filter-${columnKey}-${val}`;
            label.textContent = val;
            label.style.cursor = "pointer";
            label.style.fontSize = "0.875rem";
            label.onclick = (e) => {
              e.stopPropagation();
              console.log("Label clicked for:", val);
              checkbox.checked = !checkbox.checked;
              checkbox.dispatchEvent(new Event('change'));
            };
            
            div.appendChild(checkbox);
            div.appendChild(label);
            checkboxList.appendChild(div);
            
            console.log("Checkbox created for:", val, "ID:", checkbox.id);
          });
          
          // Select All functionality
          selectAllCheckbox.onchange = () => {
            const checkboxes = checkboxList.querySelectorAll("input.filter-checkbox");
            checkboxes.forEach(cb => {
              cb.checked = selectAllCheckbox.checked;
            });
            
            let selectedValues = selectAllCheckbox.checked ? 
              Array.from(checkboxes).map(cb => cb.value) : [];
            
            console.log("Select all changed:", columnKey, selectedValues);
            
            // Update the active filters
            if (selectedValues.length > 0) {
              exceptionActiveFilters[columnKey] = {
                type: "checkbox",
                value: selectedValues,
              };
              filterIcon.classList.add("active");
            } else {
              delete exceptionActiveFilters[columnKey];
              filterIcon.classList.remove("active");
            }
            
            // Re-render the table
            renderExceptionTable(exceptionTradeData);
          };
          filterSection.appendChild(checkboxList);
          // Add Clear Filter button
          const clearFilterBtn = document.createElement("button");
          clearFilterBtn.className =
            "mt-2 w-full bg-red-100 text-red-700 hover:bg-red-200 text-xs py-1 px-2 rounded";
          clearFilterBtn.textContent = "Clear Filter";
          clearFilterBtn.onclick = (e) => {
            e.stopPropagation();
            delete exceptionActiveFilters[columnKey];
            renderExceptionTable(exceptionTradeData);
            dropdownMenu.classList.remove("show");
            filterIcon.classList.remove("active"); // Deactivate filter icon
          };
          filterSection.appendChild(clearFilterBtn);
        } else if (columnKey === "tradeDate") {
          // Date range filter
          const dateFilterDiv = document.createElement("div");
          dateFilterDiv.innerHTML = `
                          <label for="date-from-${columnKey}">From:</label>
                          <input type="date" id="date-from-${columnKey}" class="mt-1 block w-full pl-3 pr-3 py-1 text-base border-gray-300 rounded-md" value="${
            exceptionActiveFilters[columnKey]?.from || ""
          }">
                          <label for="date-to-${columnKey}" class="mt-2">To:</label>
                          <input type="date" id="date-to-${columnKey}" class="mt-1 block w-full pl-3 pr-3 py-1 text-base border-gray-300 rounded-md" value="${
            exceptionActiveFilters[columnKey]?.to || ""
          }">
                          <button class="apply-date-filter mt-2 w-full bg-blue-100 text-blue-700 hover:bg-blue-200 text-xs py-1 px-2 rounded">Apply Date Filter</button>
                          <button class="clear-date-filter mt-1 w-full bg-red-100 text-red-700 hover:bg-red-200 text-xs py-1 px-2 rounded">Clear Date Filter</button>
                      `;
          filterSection.appendChild(dateFilterDiv);

          dateFilterDiv.querySelector(".apply-date-filter").onclick = (e) => {
            e.stopPropagation();
            const fromDate = dateFilterDiv.querySelector(
              `#date-from-${columnKey}`
            ).value;
            const toDate = dateFilterDiv.querySelector(
              `#date-to-${columnKey}`
            ).value;
            exceptionActiveFilters[columnKey] = {
              type: "dateRange",
              from: fromDate,
              to: toDate,
            };
            renderExceptionTable(exceptionTradeData);
            dropdownMenu.classList.remove("show");
            if (fromDate || toDate) {
              filterIcon.classList.add("active");
            } else {
              filterIcon.classList.remove("active");
            }
          };
          dateFilterDiv.querySelector(".clear-date-filter").onclick = (e) => {
            e.stopPropagation();
            delete exceptionActiveFilters[columnKey];
            renderExceptionTable(exceptionTradeData);
            dropdownMenu.classList.remove("show");
            filterIcon.classList.remove("active");
          };
        } else if (columnKey === "notionalAmount") {
          // Min/Max numeric filter
          const amountFilterDiv = document.createElement("div");
          amountFilterDiv.innerHTML = `
                          <label for="amount-min-${columnKey}">Min:</label>
                          <input type="number" id="amount-min-${columnKey}" placeholder="Min" class="mt-1 block w-full pl-3 pr-3 py-1 text-base border-gray-300 rounded-md" value="${
            exceptionActiveFilters[columnKey]?.min || ""
          }">
                          <label for="amount-max-${columnKey}" class="mt-2">Max:</label>
                          <input type="number" id="amount-max-${columnKey}" placeholder="Max" class="mt-1 block w-full pl-3 pr-3 py-1 text-base border-gray-300 rounded-md" value="${
            exceptionActiveFilters[columnKey]?.max || ""
          }">
                          <button class="apply-amount-filter mt-2 w-full bg-blue-100 text-blue-700 hover:bg-blue-200 text-xs py-1 px-2 rounded">Apply Amount Filter</button>
                          <button class="clear-amount-filter mt-1 w-full bg-red-100 text-red-700 hover:bg-red-200 text-xs py-1 px-2 rounded">Clear Amount Filter</button>
                      `;
          filterSection.appendChild(amountFilterDiv);

          amountFilterDiv.querySelector(".apply-amount-filter").onclick = (
            e
          ) => {
            e.stopPropagation();
            const minAmount = amountFilterDiv.querySelector(
              `#amount-min-${columnKey}`
            ).value;
            const maxAmount = amountFilterDiv.querySelector(
              `#amount-max-${columnKey}`
            ).value;
            exceptionActiveFilters[columnKey] = {
              type: "numberRange",
              min: minAmount,
              max: maxAmount,
            };
            renderExceptionTable(exceptionTradeData);
            dropdownMenu.classList.remove("show");
            if (minAmount || maxAmount) {
              filterIcon.classList.add("active");
            } else {
              filterIcon.classList.remove("active");
            }
          };
          amountFilterDiv.querySelector(".clear-amount-filter").onclick = (
            e
          ) => {
            e.stopPropagation();
            delete exceptionActiveFilters[columnKey];
            renderExceptionTable(exceptionTradeData);
            dropdownMenu.classList.remove("show");
            filterIcon.classList.remove("active");
          };
        }
        dropdownMenu.appendChild(filterSection);

        // Set initial state of filter icon based on whether a filter is active for this column
        if (
          exceptionActiveFilters[columnKey] &&
          (exceptionActiveFilters[columnKey].value?.length > 0 ||
            exceptionActiveFilters[columnKey].from ||
            exceptionActiveFilters[columnKey].to ||
            exceptionActiveFilters[columnKey].min ||
            exceptionActiveFilters[columnKey].max)
        ) {
          filterIcon.classList.add("active");
        } else {
          filterIcon.classList.remove("active");
        }
      }

      function sortExceptionData(key, direction) {
        exceptionCurrentSortColumn = key;
        exceptionCurrentSortDirection = direction;
        
        // Helper function to get field value
        const getFieldValue = (trade, columnKey) => {
          switch (columnKey) {
            case "id":
              return trade.TRADEID || trade.TradeID || trade.tradeId || "";
            case "tradeDate":
              return trade.TRADEDATA || trade.TradeDate || trade.tradeDate || trade.date || "";
            case "counterparty":
              return trade.COUNTERPARTY || trade.Counterparty || "";
            case "productType":
              return trade.ProductType || trade.productType || "";
            case "notionalAmount":
              return trade.NOTIONALAMOUNT || trade.NotionalAmount || trade.notionalAmount || "";
            case "exceptionType":
              return trade.EXCEPTIONTYPE || trade["Exception Type"] || trade.exceptionType || "";
            case "exceptionDescription":
              return trade["EXCEPTION DESCRIPTION"] || trade["Exception Description"] || trade.exceptionDescription || "";
            case "exceptionResolution":
              return trade["EXCEPTION RESOLUTION"] || trade["Exception Resolution"] || trade.exceptionResolution || "";
            case "exceptionStatus":
              return trade.exceptionStatus || trade.ExceptionFlag || trade.SettlementStatus || trade.TradeStatus || "Default";
            case "assignedTo":
              return trade.assignedTo || "";
            case "comment":
              return trade.comments || trade.notes || trade.comment || "";
            default:
              return trade[columnKey] || "";
          }
        };
        
        // Sort the data
        exceptionTradeData.sort((a, b) => {
          let valA = getFieldValue(a, key);
          let valB = getFieldValue(b, key);

          // Handle different data types
          if (key === "notionalAmount") {
            valA = parseFloat(String(valA).replace(/[^0-9.-]+/g, "")) || 0;
            valB = parseFloat(String(valB).replace(/[^0-9.-]+/g, "")) || 0;
          } else if (key === "tradeDate") {
            valA = new Date(valA || 0);
            valB = new Date(valB || 0);
          } else {
            valA = String(valA || "").toLowerCase();
            valB = String(valB || "").toLowerCase();
          }

          if (valA < valB) {
            return direction === "asc" ? -1 : 1;
          }
          if (valA > valB) {
            return direction === "asc" ? 1 : -1;
          }
          return 0;
        });
        
        renderExceptionTable(exceptionTradeData);
      }

      // --- Charting Logic for Trade Exception ---
      let exceptionStatusChartInstance = null;
      let exceptionTypeChartInstance = null;

      function renderExceptionCharts(data) {
        console.log("renderExceptionCharts called with data:", data);

        // Ensure we have valid data
        if (!data || data.length === 0) {
          console.log("No data provided for charts, skipping render");
          return;
        }

        // Aggressively destroy existing chart instances
        if (exceptionStatusChartInstance) {
          console.log("Aggressively destroying existing status chart");
          try {
          exceptionStatusChartInstance.destroy();
          } catch (error) {
            console.log("Error destroying status chart:", error);
          }
          exceptionStatusChartInstance = null;
        }
        if (exceptionTypeChartInstance) {
          console.log("Aggressively destroying existing type chart");
          try {
            exceptionTypeChartInstance.destroy();
          } catch (error) {
            console.log("Error destroying type chart:", error);
          }
          exceptionTypeChartInstance = null;
        }
        
        // Force a small delay to ensure charts are destroyed
        setTimeout(() => {
          console.log("Creating new charts after destruction delay...");
          createExceptionCharts(data);
        }, 10);
      }
      
      function createExceptionCharts(data) {
        console.log("createExceptionCharts called with data:", data);

        // Data for Exception Status Breakdown (Pie Chart)
        const statusCounts = data.reduce((acc, trade) => {
          const status = trade.exceptionStatus || "Default";
          acc[status] = (acc[status] || 0) + 1;
          return acc;
        }, {});
        
        // Filter out "Default" from the chart data
        const filteredStatusCounts = Object.fromEntries(
          Object.entries(statusCounts).filter(([key]) => key !== "Default")
        );
        
        const statusLabels = Object.keys(filteredStatusCounts);
        const statusData = Object.values(filteredStatusCounts);
        
        // Dynamic color mapping based on status
        const statusColors = statusLabels.map(label => {
          switch (label.toLowerCase()) {
            case 'open':
              return '#ef4444'; // Red
            case 'under review':
              return '#eab308'; // Yellow
            case 'resolved':
              return '#22c55e'; // Green
            default:
              return '#6b7280'; // Gray for any other status
          }
        });

        const ctxStatus = document.getElementById("exceptionStatusChart");
        console.log("Status chart canvas element:", ctxStatus);
        console.log("Status labels:", statusLabels);
        console.log("Status data:", statusData);
        console.log("Status colors:", statusColors);
        
        if (ctxStatus && statusLabels.length > 0 && statusData.length > 0) {
          console.log("Creating new status chart with data:", statusLabels, statusData);
          console.log("Status chart colors:", statusColors);
          
          // Clear the canvas first
          const ctx = ctxStatus.getContext('2d');
          ctx.clearRect(0, 0, ctxStatus.width, ctxStatus.height);
          
          try {
          exceptionStatusChartInstance = new Chart(ctxStatus, {
            type: "pie",
            data: {
              labels: statusLabels,
              datasets: [
                {
                  data: statusData,
                  backgroundColor: statusColors,
                  hoverOffset: 4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                  labels: {
                    font: {
                      size: 10,
                    },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      let label = context.label || "";
                      if (label) {
                        label += ": ";
                      }
                      if (context.parsed !== null) {
                        label += context.parsed;
                      }
                      return label;
                    },
                  },
                },
              },
            },
          });
            console.log("Status chart created successfully");
          } catch (error) {
            console.error("Error creating status chart:", error);
          }
        }



        // Data for Exception Count per Type (Bar Chart)
        const typeCounts = data.reduce((acc, trade) => {
          const exceptionType = trade.EXCEPTIONTYPE || trade["Exception Type"] || trade.exceptionType || "Unknown";
          acc[exceptionType] = (acc[exceptionType] || 0) + 1;
          return acc;
        }, {});
        
        // Filter out "None" and similar values from the chart data
        const filteredTypeCounts = Object.fromEntries(
          Object.entries(typeCounts).filter(([key]) => {
            const lowerKey = key.toLowerCase().trim();
            const noneValues = ['none', 'null', 'undefined', 'n/a', 'na', ''];
            const shouldExclude = noneValues.includes(lowerKey);
            
            if (shouldExclude) {
              console.log(`Excluding exception type from chart: "${key}"`);
            }
            
            return !shouldExclude;
          })
        );
        
        console.log("Original type counts:", typeCounts);
        console.log("Filtered type counts:", filteredTypeCounts);
        
        const typeLabels = Object.keys(filteredTypeCounts);
        const typeData = Object.values(filteredTypeCounts);
        const typeColors = ["#3b82f6", "#6366f1", "#8b5cf6"];

        const ctxType = document.getElementById("exceptionTypeChart");
        if (ctxType) {
          exceptionTypeChartInstance = new Chart(ctxType, {
            type: "bar",
            data: {
              labels: typeLabels,
              datasets: [
                {
                  label: "Count",
                  data: typeData,
                  backgroundColor: typeColors,
                  borderColor: typeColors,
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false,
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      let label = context.dataset.label || "";
                      if (label) {
                        label += ": ";
                      }
                      if (context.parsed.y !== null) {
                        label += context.parsed.y;
                      }
                      return label;
                    },
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0,
                    font: {
                      size: 10,
                    },
                  },
                  grid: {
                    display: false,
                  },
                },
                x: {
                  ticks: {
                    font: {
                      size: 10,
                    },
                  },
                  grid: {
                    display: false,
                  },
                },
              },
            },
          });
        }


      }

      // Function to render the Trade Exception tab content
      function renderTradeExceptionContent() {
        // HTML for the Trade Exception tab
        return `
                      <div class="bg-white rounded-lg shadow-md p-6 trade-exception-animate"> <!-- Removed p-4, kept p-6 for the internal content -->
                          <p class="text-gray-700 text-sm italic mb-4 p-4 bg-blue-50 rounded-md border border-blue-200">
                              This tab tracks and displays trades that have failed to meet operational, regulatory, or system-specific checks  like incomplete data, mismatches, or system rejections. These exceptions need resolution before further processing.
                          </p>
                          <!-- Exception Dashboard Summary -->
                          <div id="exception-dashboard-summary" class="mb-8 p-6 bg-gray-50 rounded-md border border-gray-200 text-center text-xl font-bold text-gray-800 w-full">
                              <!-- Content updated by updateExceptionDashboardSummary function -->
                          </div>
                          <!-- Analysis Section with Charts -->
                          <section class="p-6 bg-gray-50 rounded-md border border-gray-200 mb-8">
                              <h2 class="text-xl font-semibold text-gray-800 mb-4">Analysis Dashboard</h2>
                              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                  <!-- Chart 1: Exception Status Breakup (Pie Chart) -->
                                  <div class="bg-white p-4 rounded-md shadow-sm border border-gray-100 chart-container-small">
                                      <h3 class="text-lg font-semibold text-gray-700 mb-2">Exception Status Breakdown</h3>
                                      <canvas id="exceptionStatusChart"></canvas>
                                  </div>
                                  <!-- Chart 2: Exception Count per Type (Bar Chart) -->
                                  <div class="bg-white p-4 rounded-md shadow-sm border border-gray-100 chart-container-small">
                                      <h3 class="text-lg font-semibold text-gray-700 mb-2">Exceptions by Type</h3>
                                      <canvas id="exceptionTypeChart"></canvas>
                                  </div>
                              </div>
                          </section>
                          <!-- Exception List Table -->
                          <section class="p-6 bg-gray-50 rounded-md border border-gray-200">
                              <h2 class="text-xl font-semibold text-gray-800 mb-4">Exception List</h2>
                              <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                                  <table class="min-w-full divide-y divide-gray-200">
                                      <thead class="bg-blue-100 border-b border-blue-300">
                                          <tr>
                                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider border-r border-blue-300">
                                                  <div class="header-container" data-column="id">
                                                      <span class="font-bold text-black">TradeID</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider border-r border-blue-300">
                                                  <div class="header-container" data-column="tradeDate">
                                                      <span class="font-bold text-black">TradeDate</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                                  </th>
                                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider border-r border-blue-300">
                                                  <div class="header-container" data-column="counterparty">
                                                      <span class="font-bold text-black">Counterparty</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider border-r border-blue-300">
                                                  <div class="header-container" data-column="productType">
                                                      <span class="font-bold text-black">ProductType</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider border-r border-blue-300">
                                                  <div class="header-container" data-column="notionalAmount">
                                                      <span class="font-bold text-black">NotionalAmount</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider border-r border-blue-300">
                                                  <div class="header-container" data-column="exceptionType">
                                                      <span class="font-bold text-black">Exception Type</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider border-r border-blue-300">
                                                  <div class="header-container" data-column="exceptionDescription">
                                                      <span class="font-bold text-black">Exception Description</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider border-r border-blue-300">
                                                  <div class="header-container" data-column="exceptionResolution">
                                                      <span class="font-bold text-black">Exception Resolution</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider border-r border-blue-300">
                                                  <div class="header-container" data-column="exceptionStatus">
                                                      <span class="font-bold text-black">Exception Status</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider border-r border-blue-300">
                                                  <div class="header-container" data-column="assignedTo">
                                                      <span class="font-bold text-black">Assigned To</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider border-r border-blue-300">
                                                  <div class="header-container" data-column="comment">
                                                      <span class="font-bold text-black">Comment</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider shadow-sm bg-blue-100">
                                                  <div class="header-container" data-column="communications">
                                                      <span class="font-bold text-black">Communications</span>
                                                  </div>
                                              </th>
                                          </tr>
                                      </thead>
                                      <tbody class="bg-white divide-y divide-gray-200" id="exception-table-body">
                                      </tbody>
                                  </table>
                              </div>
                          </section>
                      </div>
                  `;
      }

      // --- Trade Reporting Specific Functions ---
      // D3 Tooltip element (global for D3 charts)
      const d3Tooltip = d3
        .select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

      const chartWidth = 300; // Small width for 2x2 grid
      const chartHeight = 200; // Small height for 2x2 grid
      const margin = { top: 20, right: 20, bottom: 40, left: 50 };

      // Function to populate the summary dashboard for Trade Reporting
      function populateReportingSummary() {
        const totalTrades = reportingTrades.length;
        const reportedSuccessfully = reportingTrades.filter(
          (trade) => (trade.reportingStatus || 'Reported') === 'Reported'
        ).length;
        const failedReports = reportingTrades.filter(
          (trade) => trade.reportingStatus === 'Failed'
        ).length;
        const pendingReports = reportingTrades.filter(
          (trade) => trade.reportingStatus === 'Pending'
        ).length;

        const totalTradesEl = document.getElementById("totalTrades");
        const reportedSuccessfullyEl = document.getElementById(
          "reportedSuccessfully"
        );
        const failedReportsEl = document.getElementById("failedReports");
        const pendingReportsEl = document.getElementById("pendingReports");

        if (totalTradesEl) totalTradesEl.textContent = totalTrades;
        if (reportedSuccessfullyEl)
          reportedSuccessfullyEl.textContent = reportedSuccessfully;
        if (failedReportsEl) failedReportsEl.textContent = failedReports;
        if (pendingReportsEl) pendingReportsEl.textContent = pendingReports;
      }

      // Function to populate the detailed trade reporting table
      window.populateReportingTradeTable = function() {
        const tableBody = document.getElementById("tradeTableBody");
        if (!tableBody) return; // Ensure element exists

        tableBody.innerHTML = ""; // Clear existing rows
        
        // Refresh regulatory frameworks content when trade reporting data is updated
        refreshRegulatoryFrameworksContent();
        
        // Clear any existing highlights when data is updated
        clearTradeHighlights();

        let filteredTrades = [...reportingTrades];

        // Apply per-column filters
        filteredTrades = filteredTrades.filter((trade) => {
          for (const key in window.reportingActiveFilters) {
            const filter = window.reportingActiveFilters[key];
            let value = "";
            // Use the same logic as the table for extracting the value for each key
            if (key === "tradeId") {
              value = trade.TradeID || trade.tradeId || "";
            } else if (key === "counterparty") {
              value = trade.Counterparty || trade.LEI || "";
            } else if (key === "productType") {
              value = trade.ProductType || trade.productType || "";
            } else if (key === "notionalAmount") {
              value = trade.NotionalAmount || trade.notionalAmount || "";
            } else if (key === "reportingRegulation") {
              value = trade["Reporting Regulation"] || trade.reportingRegulation || "";


            } else if (key === "assignedTo") {
              value = trade.assignedTo || "";
            } else if (key === "comment") {
              value = trade.comments || trade.notes || trade.comment || "";
            } else {
              value = trade[key];
            }
            if (filter.type === "text") {
              if (
                !String(value)
                  .toLowerCase()
                  .includes(filter.value.toLowerCase())
              ) {
                return false;
              }
            } else if (filter.type === "checkbox") {
              if (filter.value.length === 0) {
                continue;
              }
              if (!filter.value.includes(value)) {
                return false;
              }
            } else if (filter.type === "dateRange") {
              const tradeDate = new Date(value);
              if (filter.from && tradeDate < new Date(filter.from)) {
                return false;
              }
              if (filter.to && tradeDate > new Date(filter.to)) {
                return false;
              }
            } else if (filter.type === "numberRange") {
              const notional = parseFloat(
                String(value).replace(/[^0-9.-]+/g, "")
              );
              if (filter.min !== "" && notional < parseFloat(filter.min)) {
                return false;
              }
              if (filter.max !== "" && notional > parseFloat(filter.max)) {
                return false;
              }
            }
          }
          return true;
        });

        // Apply sorting
        if (reportingCurrentSort.key) {
          const sortKey = reportingCurrentSort.key;
          filteredTrades.sort((a, b) => {
            let valA = "";
            let valB = "";
            // Use the same logic as the table for extracting the value for each key
            if (sortKey === "tradeId") {
              valA = a.TradeID || a.tradeId || "";
              valB = b.TradeID || b.tradeId || "";
            } else if (sortKey === "counterparty") {
              valA = a.Counterparty || a.LEI || "";
              valB = b.Counterparty || b.LEI || "";
            } else if (sortKey === "productType") {
              valA = a.ProductType || a.productType || "";
              valB = b.ProductType || b.productType || "";
            } else if (sortKey === "notionalAmount") {
              valA = a.NotionalAmount || a.notionalAmount || "";
              valB = b.NotionalAmount || b.notionalAmount || "";
            } else if (sortKey === "reportingRegulation") {
              valA = a["Reporting Regulation"] || a.reportingRegulation || "";
              valB = b["Reporting Regulation"] || b.reportingRegulation || "";


            } else if (sortKey === "assignedTo") {
              valA = a.assignedTo || "";
              valB = b.assignedTo || "";
            } else if (sortKey === "comment") {
              valA = a.comments || a.notes || a.comment || "";
              valB = b.comments || b.notes || b.comment || "";
            } else if (sortKey === "tradeDate") {
              valA = a.TradeDate || a.tradeDate || a.date || "";
              valB = b.TradeDate || b.tradeDate || b.date || "";
            } else {
              valA = a[sortKey];
              valB = b[sortKey];
            }
            // For notionalAmount, sort numerically
            if (sortKey === "notionalAmount") {
              valA = parseFloat(String(valA).replace(/[^0-9.-]+/g, ""));
              valB = parseFloat(String(valB).replace(/[^0-9.-]+/g, ""));
              if (isNaN(valA)) valA = 0;
              if (isNaN(valB)) valB = 0;
            }
            // For tradeDate, sort as dates
            if (sortKey === "tradeDate") {
              valA = new Date(valA);
              valB = new Date(valB);
            }
            if (valA < valB)
              return reportingCurrentSort.direction === "asc" ? -1 : 1;
            if (valA > valB)
              return reportingCurrentSort.direction === "asc" ? 1 : -1;
            return 0;
          });
        }

        filteredTrades.forEach((trade, index) => {
          // Map only the required fields for Detailed Trade Reporting Table
          const tradeId = trade.TradeID || trade.tradeId || "";
          const tradeDate =
            trade.TradeDate || trade.tradeDate || trade.date || "";
          const counterpartyNameOrLEI = trade.Counterparty || trade.LEI || "";
          const productType = trade.ProductType || trade.productType || "";
          const notionalAmount =
            trade.NotionalAmount || trade.notionalAmount || "";
          const reportingRegulation =
            trade["Reporting Regulation"] || trade.reportingRegulation || "";


          const assignedTo = trade.assignedTo || "";
          const comment = trade.comments || trade.notes || trade.comment || "";

          const row = tableBody.insertRow();
          row.classList.add("hover:bg-gray-50", index % 2 === 0 ? "bg-white" : "bg-gray-50");
          row.dataset.tradeId = tradeId;

          // Trade ID
          let cell = row.insertCell();
          cell.classList.add(
            "px-6",
            "py-3",
            "whitespace-nowrap",
            "text-xs",
            "font-medium",
            "text-gray-900",
            "border-r",
            "border-gray-200"
          );
          cell.textContent = tradeId;

          // Trade Date
          cell = row.insertCell();
          cell.classList.add(
            "px-6",
            "py-3",
            "whitespace-nowrap",
            "text-xs",
            "text-gray-900",
            "border-r",
            "border-gray-200"
          );
          cell.textContent = tradeDate;

          // Counterparty Name / LEI
          cell = row.insertCell();
          cell.classList.add(
            "px-6",
            "py-3",
            "whitespace-nowrap",
            "text-xs",
            "text-gray-900",
            "border-r",
            "border-gray-200"
          );
          cell.textContent = counterpartyNameOrLEI;

          // Product Type
          cell = row.insertCell();
          cell.classList.add(
            "px-6",
            "py-3",
            "whitespace-nowrap",
            "text-xs",
            "text-gray-900",
            "border-r",
            "border-gray-200"
          );
          cell.textContent = productType;

          // Notional Amount
          cell = row.insertCell();
          cell.classList.add(
            "px-6",
            "py-3",
            "whitespace-nowrap",
            "text-xs",
            "text-gray-900",
            "border-r",
            "border-gray-200"
          );
          cell.textContent = notionalAmount;

          // Reporting Regulation
          cell = row.insertCell();
          cell.classList.add(
            "px-6",
            "py-3",
            "whitespace-nowrap",
            "text-xs",
            "text-gray-900",
            "border-r",
            "border-gray-200"
          );
          cell.textContent = reportingRegulation;





          // Assigned To (editable)
          cell = row.insertCell();
          cell.classList.add(
            "px-6",
            "py-3",
            "whitespace-nowrap",
            "text-xs",
            "text-gray-900",
            "border-r",
            "border-gray-200"
          );
          const assignedToInput = document.createElement("input");
          assignedToInput.type = "text";
          assignedToInput.value = assignedTo;
          assignedToInput.classList.add("table-input");
          assignedToInput.placeholder = "Assign to...";
          assignedToInput.addEventListener("change", (e) => {
            const oldAssignedTo = assignedTo;
            trade.assignedTo = e.target.value;
            addAuditLogEntry(
              "Manual: Assigned To Update",
              tradeId,
              "Operations", // Placeholder department
              reportingRegulation,
              `Assigned to changed from \"${oldAssignedTo}\" to \"${trade.assignedTo}\".`,
              oldAssignedTo,
              trade.assignedTo
            );
          });
          cell.appendChild(assignedToInput);

          // Comment (editable)
          cell = row.insertCell();
          cell.classList.add(
            "px-6",
            "py-3",
            "whitespace-nowrap",
            "text-xs",
            "text-gray-900"
          );
          const commentTextarea = document.createElement("textarea");
          commentTextarea.value = comment;
          commentTextarea.classList.add("table-input", "h-16", "resize-y");
          commentTextarea.placeholder = "Add comments...";
          commentTextarea.addEventListener("change", (e) => {
            const oldComment = comment;
            trade.comment = e.target.value;
            addAuditLogEntry(
              "Manual: Comment Update",
              tradeId,
              "Operations", // Placeholder department
              reportingRegulation,
              `Comment updated for trade ${tradeId}.`,
              oldComment,
              trade.comment
            );
          });
          cell.appendChild(commentTextarea);

          // Communications (Gmail functionality)
          cell = row.insertCell();
          cell.classList.add(
            "px-6",
            "py-3",
            "whitespace-nowrap",
            "text-xs",
            "text-gray-900"
          );
          
          // Create Gmail button
          const gmailButton = document.createElement("button");
          gmailButton.innerHTML = '<i class="fas fa-envelope text-blue-600"></i>';
          gmailButton.classList.add(
            "px-3",
            "py-1",
            "bg-blue-100",
            "hover:bg-blue-200",
            "text-blue-600",
            "rounded",
            "transition-colors",
            "duration-200",
            "text-sm"
          );
          gmailButton.title = "Send Gmail";
          
          // Add click event for Gmail functionality
          gmailButton.addEventListener("click", () => {
            showGmailModal(tradeId, assignedTo, comment, reportingRegulation);
          });
          
          cell.appendChild(gmailButton);
        });
      }

      // D3 Charting Functions for Trade Reporting
      function drawTradesByRegulationChart() {
        // Use the same logic as the table for extracting reportingRegulation
        const regulationCounts = {};
        reportingTrades.forEach(trade => {
          const reportingRegulation = trade["Reporting Regulation"] || trade.reportingRegulation || "";
          if (reportingRegulation) {
            regulationCounts[reportingRegulation] = (regulationCounts[reportingRegulation] || 0) + 1;
          }
        });
        const sortedData = Object.entries(regulationCounts)
          .map(([key, value]) => ({ key, value }))
          .sort((a, b) => b.value - a.value);
        d3.select("#chartRegulation").selectAll("*").remove(); // Clear previous chart
        const svg = d3
          .select("#chartRegulation")
          .attr("width", chartWidth)
          .attr("height", chartHeight)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);
        const x = d3
          .scaleBand()
          .domain(sortedData.map((d) => d.key))
          .range([0, chartWidth - margin.left - margin.right])
          .padding(0.1);
        const y = d3
          .scaleLinear()
          .domain([0, d3.max(sortedData, (d) => d.value) + 1])
          .range([chartHeight - margin.top - margin.bottom, 0]);
        svg
          .append("g")
          .attr(
            "transform",
            `translate(0,${chartHeight - margin.top - margin.bottom})`
          )
          .call(d3.axisBottom(x))
          .selectAll("text")
          .attr("transform", "translate(-10,0)rotate(-45)")
          .style("text-anchor", "end")
          .style("font-size", "0.8rem");
        svg
          .append("g")
          .call(
            d3.axisLeft(y).ticks(d3.max(sortedData, (d) => d.value)).tickFormat(d3.format("d"))
          )
          .selectAll("text")
          .style("font-size", "0.8rem");
        svg
          .selectAll(".bar")
          .data(sortedData)
          .enter()
          .append("rect")
          .attr("class", "bar")
          .attr("x", (d) => x(d.key))
          .attr("y", (d) => y(d.value))
          .attr("width", x.bandwidth())
          .attr(
            "height",
            (d) => chartHeight - margin.top - margin.bottom - y(d.value)
          )
          .on("mouseover", function (event, d) {
            d3Tooltip.transition().duration(200).style("opacity", 0.9);
            d3Tooltip
              .html(`Count: ${d.value}`)
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY - 28 + "px");
          })
          .on("mouseout", function (d) {
            d3Tooltip.transition().duration(500).style("opacity", 0);
          });
      }
      function drawTradesByStatusChart() {
        const data = d3.rollup(
          reportingTrades,
          (v) => v.length,
          (d) => d.reportingStatus || 'Reported'
        );
        const pieData = Array.from(data, ([key, value]) => ({
          status: key,
          count: value,
        }));
        d3.select("#chartStatus").selectAll("*").remove(); // Clear previous chart
        const radius = Math.min(chartWidth, chartHeight) / 2 - margin.top;
        const svg = d3
          .select("#chartStatus")
          .attr("width", chartWidth)
          .attr("height", chartHeight)
          .append("g")
          .attr("transform", `translate(${chartWidth / 2},${chartHeight / 2})`);
        const color = d3
          .scaleOrdinal()
          .domain(["Reported", "Failed", "Pending"])
          .range(["#10B981", "#EF4444", "#F59E0B"]); // Green, Red, Yellow
        const pie = d3
          .pie()
          .value((d) => d.count)
          .sort(null);
        const arc = d3.arc().innerRadius(0).outerRadius(radius);
        const arcs = svg
          .selectAll(".arc")
          .data(pie(pieData))
          .enter()
          .append("g")
          .attr("class", "arc");
        arcs
          .append("path")
          .attr("d", arc)
          .attr("fill", (d) => color(d.data.status))
          .on("mouseover", function (event, d) {
            d3Tooltip.transition().duration(200).style("opacity", 0.9);
            d3Tooltip
              .html(`${d.data.status}: ${d.data.count}`)
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY - 28 + "px");
          })
          .on("mouseout", function (d) {
            d3Tooltip.transition().duration(500).style("opacity", 0);
          });
        // Add a vertically stacked legend to the right of the chart
        const legendContainer = d3.select("#chartStatus")
          .append("g")
          .attr("transform", `translate(${chartWidth - 10},${chartHeight / 2 - 40})`); // Right of chart, vertically centered
        const legendData = pieData;
        const legend = legendContainer.selectAll(".legend-item")
          .data(legendData)
          .enter()
          .append("g")
          .attr("class", "legend-item")
          .attr("transform", (d, i) => `translate(0,${i * 24})`); // Stack vertically
        legend.append("rect")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 14)
          .attr("height", 14)
          .attr("fill", d => color(d.status));
        legend.append("text")
          .attr("x", 20)
          .attr("y", 11)
          .text(d => `${d.status} (${d.count})`)
          .style("font-size", "0.8em")
          .style("fill", "#374151");
      }
      function drawTradesByProductTypeChart() {
        // Use the same logic as the table for extracting productType
        const productTypeCounts = {};
        reportingTrades.forEach(trade => {
          const productType = trade.ProductType || trade.productType || "";
          if (productType) {
            productTypeCounts[productType] = (productTypeCounts[productType] || 0) + 1;
          }
        });
        const sortedData = Object.entries(productTypeCounts)
          .map(([key, value]) => ({ key, value }))
          .sort((a, b) => b.value - a.value);
        d3.select("#chartProductType").selectAll("*").remove(); // Clear previous chart
        const svg = d3
          .select("#chartProductType")
          .attr("width", chartWidth)
          .attr("height", chartHeight)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);
        const x = d3
          .scaleBand()
          .domain(sortedData.map((d) => d.key))
          .range([0, chartWidth - margin.left - margin.right])
          .padding(0.1);
        const y = d3
          .scaleLinear()
          .domain([0, d3.max(sortedData, (d) => d.value) + 1])
          .range([chartHeight - margin.top - margin.bottom, 0]);
        svg
          .append("g")
          .attr(
            "transform",
            `translate(0,${chartHeight - margin.top - margin.bottom})`
          )
          .call(d3.axisBottom(x))
          .selectAll("text")
          .attr("transform", "translate(-10,0)rotate(-45)")
          .style("text-anchor", "end")
          .style("font-size", "0.8rem");
        svg
          .append("g")
          .call(
            d3.axisLeft(y).ticks(d3.max(sortedData, (d) => d.value)).tickFormat(d3.format("d"))
          )
          .selectAll("text")
          .style("font-size", "0.8rem");
        svg
          .selectAll(".bar")
          .data(sortedData)
          .enter()
          .append("rect")
          .attr("class", "bar")
          .attr("x", (d) => x(d.key))
          .attr("y", (d) => y(d.value))
          .attr("width", x.bandwidth())
          .attr(
            "height",
            (d) => chartHeight - margin.top - margin.bottom - y(d.value)
          )
          .on("mouseover", function (event, d) {
            d3Tooltip.transition().duration(200).style("opacity", 0.9);
            d3Tooltip
              .html(`Count: ${d.value}`)
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY - 28 + "px");
          })
          .on("mouseout", function (d) {
            d3Tooltip.transition().duration(500).style("opacity", 0);
          });
      }
      function drawTradeStatusByRegulationChart() {
        d3.select("#chartStatusByRegulation").selectAll("*").remove(); // Clear previous chart
        const statuses = ["Reported", "Failed", "Pending"];
        const regulations = Array.from(
          new Set(reportingTrades.map((d) => d["Reporting Regulation"] || d.reportingRegulation || ""))
        ).sort();
        // Aggregate data
        const aggregatedData = [];
        regulations.forEach((reg) => {
          const regData = { regulation: reg };
          statuses.forEach((status) => {
            regData[status] = reportingTrades.filter(
              (t) =>
                (t["Reporting Regulation"] || t.reportingRegulation || "") === reg &&
                ((t.RegulatoryReportingStatus || t.reportingStatus || "Reported") === status)
            ).length;
          });
          aggregatedData.push(regData);
        });
        const svg = d3
          .select("#chartStatusByRegulation")
          .attr("width", chartWidth)
          .attr("height", chartHeight)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);
        const x = d3
          .scaleBand()
          .domain(regulations)
          .range([0, chartWidth - margin.left - margin.right])
          .padding(0.1);
        const y = d3
          .scaleLinear()
          .domain([
            0,
            d3.max(aggregatedData, (d) => statuses.reduce((sum, s) => sum + d[s], 0)) + 1,
          ])
          .range([chartHeight - margin.top - margin.bottom, 0]);
        const color = d3
          .scaleOrdinal()
          .domain(statuses)
          .range(["#10B981", "#EF4444", "#F59E0B"]); // Green, Red, Yellow
        svg
          .append("g")
          .attr(
            "transform",
            `translate(0,${chartHeight - margin.top - margin.bottom})`
          )
          .call(d3.axisBottom(x))
          .selectAll("text")
          .attr("transform", "translate(-10,0)rotate(-45)")
          .style("text-anchor", "end")
          .style("font-size", "0.8rem"); /* Increased font size */
        svg
          .append("g")
          .call(
            d3
              .axisLeft(y)
              .ticks(
                d3.max(aggregatedData, (d) => d3.sum(statuses, (s) => d[s]))
              )
              .tickFormat(d3.format("d"))
          ) // Whole numbers
          .selectAll("text")
          .style("font-size", "0.8rem"); /* Increased font size */
        // Stacked bars
        const stack = d3.stack().keys(statuses);
        const stackedSeries = stack(aggregatedData);
        svg
          .selectAll(".stack")
          .data(stackedSeries)
          .enter()
          .append("g")
          .attr("fill", (d) => color(d.key))
          .selectAll("rect")
          .data((d) => d)
          .enter()
          .append("rect")
          .attr("x", (d) => x(d.data.regulation))
          .attr("y", (d) => y(d[1]))
          .attr("height", (d) => y(d[0]) - y(d[1]))
          .attr("width", x.bandwidth())
          .on("mouseover", function (event, d) {
            d3Tooltip.transition().duration(200).style("opacity", 0.9);
            d3Tooltip
              .html(`${d3.select(this.parentNode).datum().key}: ${d[1] - d[0]}`)
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY - 28 + "px");
          })
          .on("mouseout", function (d) {
            d3Tooltip.transition().duration(500).style("opacity", 0);
          });
        // Add legend
        const legend = svg
          .append("g")
          .attr("font-family", "sans-serif")
          .attr("font-size", 8)
          .attr("text-anchor", "end")
          .selectAll("g")
          .data(statuses.slice().reverse())
          .enter()
          .append("g")
          .attr("transform", (d, i) => `translate(0,${i * 12})`);
        legend
          .append("rect")
          .attr("x", chartWidth - margin.left - margin.right - 19)
          .attr("width", 10)
          .attr("height", 10)
          .attr("fill", color);
        legend
          .append("text")
          .attr("x", chartWidth - margin.left - margin.right - 24)
          .attr("y", 5)
          .attr("dy", "0.32em")
          .text((d) => d);
      }
      // Function to draw all charts for Trade Reporting
      function drawReportingCharts() {
        drawTradesByRegulationChart();
        drawTradesByStatusChart();
        drawTradesByProductTypeChart();
        drawTradeStatusByRegulationChart();
      }

      // Function to populate dropdown for Trade Reporting
      function populateReportingDropdown(columnKey, dropdownMenu, filterIcon) {
        console.log(`Populating dropdown for: ${columnKey}`);
        dropdownMenu.innerHTML = ""; // Clear previous content

        // Sort options
        const sortAscItem = document.createElement("div");
        sortAscItem.className = "dropdown-item";
        sortAscItem.innerHTML =
          '<i class="fas fa-sort-up mr-2"></i> Sort Ascending';
        sortAscItem.onclick = (e) => {
          e.stopPropagation();
          reportingCurrentSort.key = columnKey;
          reportingCurrentSort.direction = "asc";
          populateReportingTradeTable();
          dropdownMenu.classList.remove("show");
        };
        dropdownMenu.appendChild(sortAscItem);

        const sortDescItem = document.createElement("div");
        sortDescItem.className = "dropdown-item";
        sortDescItem.innerHTML =
          '<i class="fas fa-sort-down mr-2"></i> Sort Descending';
        sortDescItem.onclick = (e) => {
          e.stopPropagation();
          reportingCurrentSort.key = columnKey;
          reportingCurrentSort.direction = "desc";
          populateReportingTradeTable();
          dropdownMenu.classList.remove("show");
        };
        dropdownMenu.appendChild(sortDescItem);

        // Filter Section
        const filterSection = document.createElement("div");
        filterSection.className = "dropdown-filter-section";
        filterSection.innerHTML =
          '<span class="text-xs font-semibold text-gray-500 block mb-2">Filter By</span>';

        // Determine filter type for each column
        let filterType = "checkbox";
        if (["tradeId", "notionalAmount"].includes(columnKey)) {
          filterType = "text";
        } else if (["counterparty", "productType", "reportingRegulation"].includes(columnKey)) {
          filterType = "checkbox";
        } else if (columnKey === "tradeDate") {
          filterType = "dateRange";
        }

        if (filterType === "text") {
          // Text filter
          const textInput = document.createElement("input");
          textInput.type = "text";
          textInput.placeholder = `Search ${columnKey.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}...`;
          textInput.value = reportingActiveFilters[columnKey]?.value || "";
          textInput.oninput = (e) => {
            reportingActiveFilters[columnKey] = {
              type: "text",
              value: e.target.value.trim(),
            };
            populateReportingTradeTable();
            if (e.target.value.trim()) {
              filterIcon.classList.add("active");
            } else {
              filterIcon.classList.remove("active");
            }
          };
          filterSection.appendChild(textInput);
        } else if (filterType === "dateRange") {
          // Date range filter
          const dateFilterDiv = document.createElement("div");
          dateFilterDiv.innerHTML = `
                          <label for="date-from-${columnKey}">From:</label>
                          <input type="date" id="date-from-${columnKey}" class="mt-1 block w-full pl-3 pr-3 py-1 text-base border-gray-300 rounded-md" value="${
            reportingActiveFilters[columnKey]?.from || ""
          }">
                          <label for="date-to-${columnKey}" class="mt-2">To:</label>
                          <input type="date" id="date-to-${columnKey}" class="mt-1 block w-full pl-3 pr-3 py-1 text-base border-gray-300 rounded-md" value="${
            reportingActiveFilters[columnKey]?.to || ""
          }">
                          <button class="apply-date-filter mt-2 w-full bg-blue-100 text-blue-700 hover:bg-blue-200 text-xs py-1 px-2 rounded">Apply Date Filter</button>
                          <button class="clear-date-filter mt-1 w-full bg-red-100 text-red-700 hover:bg-red-200 text-xs py-1 px-2 rounded">Clear Date Filter</button>
                      `;
          filterSection.appendChild(dateFilterDiv);

          dateFilterDiv.querySelector(".apply-date-filter").onclick = (e) => {
            e.stopPropagation();
            const fromDate = dateFilterDiv.querySelector(
              `#date-from-${columnKey}`
            ).value;
            const toDate = dateFilterDiv.querySelector(
              `#date-to-${columnKey}`
            ).value;
            reportingActiveFilters[columnKey] = {
              type: "dateRange",
              from: fromDate,
              to: toDate,
            };
            populateReportingTradeTable();
            dropdownMenu.classList.remove("show");
            if (fromDate || toDate) {
              filterIcon.classList.add("active");
            } else {
              filterIcon.classList.remove("active");
            }
          };
          dateFilterDiv.querySelector(".clear-date-filter").onclick = (e) => {
            e.stopPropagation();
            delete reportingActiveFilters[columnKey];
            populateReportingTradeTable();
            dropdownMenu.classList.remove("show");
            filterIcon.classList.remove("active");
          };
        } else if (filterType === "checkbox") {
          // Checkbox filter
          let uniqueValues = [];
          if (columnKey === "counterparty") {
            uniqueValues = [...new Set(reportingTrades.map(trade => trade.Counterparty || trade.LEI || ""))];
          } else if (columnKey === "productType") {
            uniqueValues = [...new Set(reportingTrades.map(trade => trade.ProductType || trade.productType || ""))];
          } else if (columnKey === "reportingRegulation") {
            uniqueValues = [...new Set(reportingTrades.map(trade => trade["Reporting Regulation"] || trade.reportingRegulation || ""))];
          } else {
            uniqueValues = [...new Set(reportingTrades.map(trade => trade[columnKey]))];
          }
          uniqueValues = uniqueValues.filter(Boolean).sort();
          const checkboxList = document.createElement("div");
          checkboxList.className = "checkbox-list";
          checkboxList.style.maxHeight = "200px";
          checkboxList.style.overflowY = "auto";
          checkboxList.style.marginBottom = "0.5rem";
          // Select All option
          const selectAllDiv = document.createElement("div");
          const selectAllCheckbox = document.createElement("input");
          selectAllCheckbox.type = "checkbox";
          selectAllCheckbox.id = `filter-${columnKey}-select-all`;
          selectAllCheckbox.checked = reportingActiveFilters[columnKey]?.value?.length === uniqueValues.length;
          selectAllCheckbox.onchange = () => {
            if (selectAllCheckbox.checked) {
            reportingActiveFilters[columnKey] = {
                type: "checkbox",
                value: [...uniqueValues],
            };
              // Check all checkboxes
              checkboxList.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = true);
            } else {
              reportingActiveFilters[columnKey] = {
                type: "checkbox",
                value: [],
              };
              checkboxList.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = false);
            }
            populateReportingTradeTable();
            if (reportingActiveFilters[columnKey].value.length > 0) {
              filterIcon.classList.add("active");
            } else {
              filterIcon.classList.remove("active");
            }
          };
          const selectAllLabel = document.createElement("label");
          selectAllLabel.htmlFor = selectAllCheckbox.id;
          selectAllLabel.textContent = "Select All";
          selectAllDiv.appendChild(selectAllCheckbox);
          selectAllDiv.appendChild(selectAllLabel);
          checkboxList.appendChild(selectAllDiv);
          uniqueValues.forEach((val) => {
            const div = document.createElement("div");
            div.style.display = "flex";
            div.style.alignItems = "center";
            div.style.gap = "0.5rem";
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = `filter-${columnKey}-${val}`;
            checkbox.value = val;
            // Initialize checked state based on current filter
            if (
              reportingActiveFilters[columnKey] &&
              reportingActiveFilters[columnKey].value.includes(val)
            ) {
              checkbox.checked = true;
            }
            checkbox.onchange = () => {
              let selectedValues = Array.from(
                checkboxList.querySelectorAll("input[type='checkbox']:not(#filter-" + columnKey + "-select-all)")
              ).filter(cb => cb.checked).map((cb) => cb.value);
              reportingActiveFilters[columnKey] = {
                type: "checkbox",
                value: selectedValues,
              };
              // Update Select All state
              selectAllCheckbox.checked = selectedValues.length === uniqueValues.length;
              populateReportingTradeTable();
              if (selectedValues.length > 0) {
                filterIcon.classList.add("active");
              } else {
                filterIcon.classList.remove("active");
              }
            };
            const label = document.createElement("label");
            label.htmlFor = `filter-${columnKey}-${val}`;
            label.textContent = val;
            div.appendChild(checkbox);
            div.appendChild(label);
            checkboxList.appendChild(div);
          });
          filterSection.appendChild(checkboxList);
          // Add Clear Filter button
          const clearFilterBtn = document.createElement("button");
          clearFilterBtn.className =
            "mt-2 w-full bg-red-100 text-red-700 hover:bg-red-200 text-xs py-1 px-2 rounded";
          clearFilterBtn.textContent = "Clear Filter";
          clearFilterBtn.onclick = (e) => {
            e.stopPropagation();
            delete reportingActiveFilters[columnKey];
            populateReportingTradeTable();
            dropdownMenu.classList.remove("show");
            filterIcon.classList.remove("active"); // Deactivate filter icon
          };
          filterSection.appendChild(clearFilterBtn);
        }
        dropdownMenu.appendChild(filterSection);

        // Set initial state of filter icon based on whether a filter is active for this column
        if (
          reportingActiveFilters[columnKey] &&
          (reportingActiveFilters[columnKey].value?.length > 0 ||
            reportingActiveFilters[columnKey].from ||
            reportingActiveFilters[columnKey].to ||
            reportingActiveFilters[columnKey].min ||
            reportingActiveFilters[columnKey].max)
        ) {
          filterIcon.classList.add("active");
        } else {
          filterIcon.classList.remove("active");
        }
      }

      function renderTradeReportingContent() {
        return `
                      <div class="p-6 bg-white rounded-lg shadow-md">
                          <h2 class="text-2xl font-semibold text-gray-800 mb-2">Trade Reporting</h2>
                          <p class="text-gray-600 italic text-sm mb-6">This tab ensures all eligible trades are correctly reported to the respective Trade Repositories (TRs) or Approved Reporting Mechanisms (ARMs) as per various regulations (like EMIR, MiFID II, SFTR, Dodd-Frank), and tracks the status of these submissions.</p>
                          <!-- Detailed Trade Reporting Table -->
                          <section class="mb-8">
                              <div class="flex justify-between items-center mb-4">
                                  <h3 class="text-xl md:text-2xl font-semibold text-gray-800">Detailed Trade Reporting Table</h3>
                              </div>
                              <div class="overflow-x-auto rounded-xl shadow-lg border border-gray-200 bg-gradient-to-br from-white to-gray-50">
                                  <table class="min-w-full bg-white" id="detailedTable">
                                      <thead class="bg-blue-100 border-b border-blue-300">
                                          <tr>
                                              <th scope="col" class="px-6 py-4 text-left text-sm font-bold text-black uppercase tracking-wider border-r border-blue-300 shadow-sm bg-blue-100">
                                                  <div class="header-container flex items-center justify-between" data-column="tradeId">
                                                      <span class="font-bold text-black">Trade ID</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-4 text-left text-sm font-bold text-black uppercase tracking-wider border-r border-blue-300 shadow-sm bg-blue-100">
                                                  <div class="header-container flex items-center justify-between" data-column="tradeDate">
                                                      <span class="font-bold text-black">Trade Date</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-4 text-left text-sm font-bold text-black uppercase tracking-wider border-r border-blue-300 shadow-sm bg-blue-100">
                                                  <div class="header-container flex items-center justify-between" data-column="counterparty">
                                                      <span class="font-bold text-black">Counterparty Name / LEI</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-4 text-left text-sm font-bold text-black uppercase tracking-wider border-r border-blue-300 shadow-sm bg-blue-100">
                                                  <div class="header-container flex items-center justify-between" data-column="productType">
                                                      <span class="font-bold text-black">Product Type</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-4 text-left text-sm font-bold text-black uppercase tracking-wider border-r border-blue-300 shadow-sm bg-blue-100">
                                                  <div class="header-container flex items-center justify-between" data-column="notionalAmount">
                                                      <span class="font-bold text-black">Notional Amount</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-4 text-left text-sm font-bold text-black uppercase tracking-wider border-r border-blue-300 shadow-sm bg-blue-100">
                                                  <div class="header-container flex items-center justify-between" data-column="reportingRegulation">
                                                      <span class="font-bold text-black">Reporting Regulation</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>


                                              <th scope="col" class="px-6 py-4 text-left text-sm font-bold text-black uppercase tracking-wider border-r border-blue-300 shadow-sm bg-blue-100">
                                                  <div class="header-container flex items-center justify-between" data-column="assignedTo">
                                                      <span class="font-bold text-black">Assigned To</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-4 text-left text-sm font-bold text-black uppercase tracking-wider shadow-sm bg-blue-100">
                                                  <div class="header-container flex items-center justify-between" data-column="comment">
                                                      <span class="font-bold text-black">Comment</span> <i class="fas fa-caret-down ml-2 filter-icon-reporting text-gray-600 hover:text-black transition-colors"></i>
                                                      <div class="dropdown-menu"></div>
                                                  </div>
                                              </th>
                                              <th scope="col" class="px-6 py-4 text-left text-sm font-bold text-black uppercase tracking-wider shadow-sm bg-blue-100">
                                                  <div class="header-container flex items-center justify-between" data-column="communications">
                                                      <span class="font-bold text-black">Communications</span>
                                                  </div>
                                              </th>
                                          </tr>
                                      </thead>
                                      <tbody id="tradeTableBody" class="divide-y divide-gray-200">
                                          <!-- Trade data will be populated here by JavaScript -->
                                      </tbody>
                                  </table>
                              </div>
                          </section>
                      </div>
                  `;
      }

      // --- Audit Trail Specific Functions ---
      // Function to render the Audit Trail table
      function renderAuditTable(data) {
        console.log("Rendering audit table with data:", data);
        const auditTrailTableBody = document.getElementById(
          "auditTrailTableBody"
        );
        if (!auditTrailTableBody) {
          console.error("auditTrailTableBody element not found");
          return; // Ensure element exists
        }

        auditTrailTableBody.innerHTML = ""; // Clear existing rows
        if (data.length === 0) {
          console.log("No audit data to display");
          auditTrailTableBody.innerHTML = `<tr><td colspan="8" class="px-4 py-4 text-center text-gray-500">No audit trail data found. Make changes in other tabs to see logs here.</td></tr>`;
          return;
        }
        // Sort auditData by timestamp in descending order (most recent first)
        const sortedAuditData = [...data].sort(
          (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
        );

        sortedAuditData.forEach((item) => {
          const row = document.createElement("tr");
          row.classList.add("hover:bg-gray-50");
          row.innerHTML = `
                          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${item.timestamp}</td>
                          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${item.actionType}</td>
                          <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-blue-600 hover:text-blue-800 cursor-pointer trade-id" data-trade-id="${item.tradeID}">${item.tradeID}</td>
                          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${item.department}</td>
                          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${item.regulationAffected}</td>
                          <td class="px-4 py-3 whitespace-normal text-sm text-gray-900">${item.remarks}</td>
                          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${item.statusBefore}</td>
                          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${item.statusAfter}</td>
                      `;
          auditTrailTableBody.appendChild(row);
        });
        // Add event listeners to Trade ID cells after rendering
        document.querySelectorAll(".trade-id").forEach((cell) => {
          cell.addEventListener("click", (event) => {
            const tradeId = event.target.dataset.tradeId;
            if (tradeId && tradeId !== "N/A") {
              showTradeLogModal(tradeId);
            }
          });
        });
      }

      // Function to apply filters and sorting for Audit Trail
      function applyAuditFiltersAndSort() {
        let filtered = [...auditData];

        // Get DOM elements for filters
        const actionTypeFilter = document.getElementById("actionTypeFilter");
        const tradeIdFilter = document.getElementById("tradeIdFilter");
        const departmentFilter = document.getElementById("departmentFilter");
        const regulationFilter = document.getElementById("regulationFilter");

        // Apply Action Type Filter
        const selectedActionType = actionTypeFilter
          ? actionTypeFilter.value
          : "";
        if (selectedActionType) {
          filtered = filtered.filter((item) =>
            item.actionType.startsWith(selectedActionType)
          );
        }
        // Apply Trade ID Filter
        const tradeIdSearchTerm = tradeIdFilter
          ? tradeIdFilter.value.toLowerCase()
          : "";
        if (tradeIdSearchTerm) {
          filtered = filtered.filter((item) =>
            item.tradeID.toLowerCase().includes(tradeIdSearchTerm)
          );
        }
        // Apply Department Filter (User Filter)
        const departmentSearchTerm = departmentFilter
          ? departmentFilter.value.toLowerCase()
          : "";
        if (departmentSearchTerm) {
          filtered = filtered.filter((item) =>
            item.department.toLowerCase().includes(departmentSearchTerm)
          );
        }
        // Apply Regulation Filter
        const selectedRegulation = regulationFilter
          ? regulationFilter.value
          : "";
        if (selectedRegulation) {
          filtered = filtered.filter(
            (item) => item.regulationAffected === selectedRegulation
          );
        }
        // Apply Sorting
        if (auditCurrentSortColumn) {
          filtered.sort((a, b) => {
            const valA = a[auditCurrentSortColumn];
            const valB = b[auditCurrentSortColumn];
            if (valA < valB) {
              return auditSortDirection === "asc" ? -1 : 1;
            }
            if (valA > valB) {
              return auditSortDirection === "asc" ? 1 : -1;
            }
            return 0;
          });
        }
        renderAuditTable(filtered);
        updateAuditSortArrows(); // Update sort arrow visuals after sorting
      }

      // Function to update sort arrow visuals for Audit Trail
      function updateAuditSortArrows() {
        document.querySelectorAll(".audit-sort-arrow").forEach((arrow) => {
          arrow.classList.remove("asc", "desc", "active");
          arrow.innerHTML = ""; // Clear previous arrow
        });
        if (auditCurrentSortColumn) {
          const activeArrow = document.querySelector(
            `.audit-sort-arrow[data-sort-target="${auditCurrentSortColumn}"]`
          );
          if (activeArrow) {
            activeArrow.classList.add("active", auditSortDirection);
          }
        }
      }

      // Function to show trade-specific log modal for Audit Trail
      function showTradeLogModal(tradeId) {
        const tradeLogModal = document.getElementById("tradeLogModal");
        const modalTradeId = document.getElementById("modalTradeId");
        const modalContent = document.getElementById("modalContent");
        const closeModalBtn = document.getElementById("closeModal");

        modalTradeId.textContent = tradeId;
        modalContent.innerHTML = ""; // Clear previous content
        const tradeLogs = auditData.filter((item) => item.tradeID === tradeId);
        if (tradeLogs.length > 0) {
          const ul = document.createElement("ul");
          ul.classList.add("list-disc", "list-inside", "space-y-2");
          tradeLogs.forEach((log) => {
            const li = document.createElement("li");
            li.innerHTML = `
                              <strong>Timestamp:</strong> ${log.timestamp}<br>
                              <strong>Action Type:</strong> ${log.actionType}<br>
                              <strong>Department:</strong> ${log.department}<br>
                              <strong>Regulation Affected:</strong> ${log.regulationAffected}<br>
                              <strong>Remarks:</strong> ${log.remarks}<br>
                              <strong>Status Before:</strong> ${log.statusBefore}<br>
                              <strong>Status After:</strong> ${log.statusAfter}
                          `;
            ul.appendChild(li);
          });
          modalContent.appendChild(ul);
        } else {
          modalContent.innerHTML =
            "<p>No detailed logs found for this Trade ID.</p>";
        }
        tradeLogModal.classList.remove("hidden");

        // Ensure modal close listeners are attached only once
        if (!closeModalBtn._hasClickListener) {
          closeModalBtn.addEventListener("click", () => {
            tradeLogModal.classList.add("hidden");
          });
          tradeLogModal.addEventListener("click", (event) => {
            if (event.target === tradeLogModal) {
              tradeLogModal.classList.add("hidden");
            }
          });
          closeModalBtn._hasClickListener = true; // Mark as attached
        }
      }

      // Team email mapping
      const teamEmails = {
        "Reference": "reference.barclays@gmail.com",
        "Network Management": "nwm.barclays@gmail.com",
        "middle office": "mo.barclays@gmail.com",
        "Settlements": "settlements.barclays@gmail.com",
        "Confirmations": "confirmations.barclays@gmail.com",
        "Collatreral": "collateral.barclays@gmail.com",
        "Cost Management": "cost.barclays@gmail.com"
      };

      // Function to show Gmail modal
      function showGmailModal(tradeId, assignedTo, comment, reportingRegulation) {
        const modal = document.getElementById("gmailModal");
        const gmailTradeId = document.getElementById("gmailTradeId");
        const gmailAssignedTo = document.getElementById("gmailAssignedTo");
        const gmailRegulation = document.getElementById("gmailRegulation");
        const gmailComments = document.getElementById("gmailComments");
        const teamSelect = document.getElementById("teamSelect");
        const emailDisplay = document.getElementById("emailDisplay");
        const sendGmailBtn = document.getElementById("sendGmailBtn");
        const closeGmailModal = document.getElementById("closeGmailModal");

        // Populate trade information
        gmailTradeId.textContent = tradeId;
        gmailAssignedTo.textContent = assignedTo || "Not assigned";
        gmailRegulation.textContent = reportingRegulation || "Not specified";
        gmailComments.textContent = comment || "No comments";

        // Reset form
        teamSelect.value = "";
        emailDisplay.textContent = "Select a team to see the email address";
        sendGmailBtn.disabled = true;

        // Remove existing event listeners to prevent duplicates
        const newTeamSelect = teamSelect.cloneNode(true);
        teamSelect.parentNode.replaceChild(newTeamSelect, teamSelect);
        const newSendGmailBtn = sendGmailBtn.cloneNode(true);
        sendGmailBtn.parentNode.replaceChild(newSendGmailBtn, sendGmailBtn);

        // Team selection change handler
        newTeamSelect.addEventListener("change", function() {
          const selectedTeam = this.value;
          if (selectedTeam && teamEmails[selectedTeam]) {
            emailDisplay.textContent = teamEmails[selectedTeam];
            newSendGmailBtn.disabled = false;
          } else {
            emailDisplay.textContent = "Select a team to see the email address";
            newSendGmailBtn.disabled = true;
          }
        });

        // Send Gmail button handler
        newSendGmailBtn.addEventListener("click", function() {
          console.log("Send Gmail button clicked"); // Debug log
          const selectedTeam = newTeamSelect.value;
          const emailAddress = teamEmails[selectedTeam];
          
          // Add audit log entry for Gmail communication
          addAuditLogEntry(
            "Communication: Gmail Sent",
            tradeId,
            "Operations",
            reportingRegulation || "N/A",
            `Gmail sent to ${selectedTeam} (${emailAddress}) regarding trade ${tradeId}. Assigned To: ${assignedTo || 'Not assigned'}, Comments: ${comment || 'No comments'}`,
            "N/A",
            "Email Sent"
          );
          
          // Show success message
          showGmailSuccessMessage();
          
          // Close modal after a short delay
          setTimeout(() => {
            modal.classList.add("hidden");
          }, 2000);
        });

        // Close modal handler
        closeGmailModal.onclick = function() {
          modal.classList.add("hidden");
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
          if (event.target === modal) {
            modal.classList.add("hidden");
          }
        };

        // Show modal
        modal.classList.remove("hidden");
      }

      // Function to show Gmail success message
      function showGmailSuccessMessage() {
        console.log("showGmailSuccessMessage called"); // Debug log
        // Create success notification
        const notification = document.createElement("div");
        notification.className = "fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center";
        notification.innerHTML = `
          <i class="fas fa-check-circle mr-2"></i>
          <span>Mail sent</span>
        `;
        
        document.body.appendChild(notification);
        console.log("Notification created and added to DOM"); // Debug log
        
        // Remove notification after 3 seconds
        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      function renderDashboardContent() {
        return `
                      <div class="p-4 md:p-8">
                          <div class="max-w-7xl mx-auto space-y-8"> <!-- Increased space-y for better separation -->
                              <h2 class="dashboard-section-title">Overall KPIs</h2>
                              <!-- Overall KPIs Section -->
                              <div class="dashboard-grid">
                                  <div class="kpi-box-dashboard">
                                      <div class="kpi-value-dashboard">10</div>
                                      <div class="kpi-label-dashboard">Total Trades</div>
                                  </div>
                                  <div class="kpi-box-dashboard">
                                      <div class="kpi-value-dashboard">6</div>
                                      <div class="kpi-label-dashboard">Reported Trades</div>
                                  </div>
                                  <div class="kpi-box-dashboard">
                                      <div class="kpi-value-dashboard">2</div>
                                      <div class="kpi-label-dashboard">Rejected Trades</div>
                                  </div>
                                  <div class="kpi-box-dashboard">
                                      <div class="kpi-value-dashboard">1</div>
                                      <div class="kpi-label-dashboard">Non-Reportable Trades</div>
                                  </div>
                                  <div class="kpi-box-dashboard">
                                      <div class="kpi-value-dashboard">1</div>
                                      <div class="kpi-label-dashboard">Pending Trades</div>
                                  </div>
                              </div>

                              <h2 class="dashboard-section-title">Key Metrics</h2>
                              <!-- Completeness Section -->
                              <div class="dashboard-card">
                                  <h3 class="text-xl font-semibold text-gray-800 mb-4">Completeness</h3>
                                  <div class="dashboard-grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5">
                                      <div class="kpi-box-dashboard">
                                          <div class="kpi-value-dashboard">8</div>
                                          <div class="kpi-label-dashboard">Reported</div>
                                      </div>
                                      <div class="kpi-box-dashboard">
                                          <div class="kpi-value-dashboard">1</div>
                                          <div class="kpi-label-dashboard">Rejected</div>
                                      </div>
                                      <div class="kpi-box-dashboard">
                                          <div class="kpi-value-dashboard">1</div>
                                          <div class="kpi-label-dashboard">Pending</div>
                                      </div>
                                      <div class="kpi-box-dashboard">
                                          <div class="kpi-value-dashboard">0</div>
                                          <div class="kpi-label-dashboard">Non-Reportable</div>
                                      </div>
                                      <div class="kpi-box-dashboard">
                                          <div class="kpi-value-dashboard">80%</div>
                                          <div class="kpi-label-dashboard">Completeness Percentage</div>
                                      </div>
                                  </div>
                              </div>

                              <!-- Accuracy Section -->
                              <div class="dashboard-card">
                                  <h3 class="text-xl font-semibold text-gray-800 mb-4">Accuracy</h3>
                                  <div class="dashboard-grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
                                      <div class="kpi-box-dashboard">
                                          <div class="kpi-value-dashboard">10</div>
                                          <div class="kpi-label-dashboard">Total Reported</div>
                                      </div>
                                      <div class="kpi-box-dashboard">
                                          <div class="kpi-value-dashboard">9</div>
                                          <div class="kpi-label-dashboard">Accurate</div>
                                      </div>
                                      <div class="kpi-box-dashboard">
                                          <div class="kpi-value-dashboard">1</div>
                                          <div class="kpi-label-dashboard">Exception</div>
                                      </div>
                                      <div class="kpi-box-dashboard">
                                          <div class="kpi-value-dashboard">90%</div>
                                          <div class="kpi-label-dashboard">Accurate Percentage</div>
                                      </div>
                                  </div>
                              </div>

                              <!-- Timeliness Section -->
                              <div class="dashboard-card">
                                  <h3 class="text-xl font-semibold text-gray-800 mb-4">Timeliness</h3>
                                  <div class="dashboard-grid grid-cols-2 md:grid-cols-3">
                                      <div class="kpi-box-dashboard">
                                          <div class="kpi-value-dashboard">6</div>
                                          <div class="kpi-label-dashboard">On Time Reported</div>
                                      </div>
                                      <div class="kpi-box-dashboard">
                                          <div class="kpi-value-dashboard">1</div>
                                          <div class="kpi-label-dashboard">Late Reported</div>
                                      </div>
                                      <div class="kpi-box-dashboard">
                                          <div class="kpi-value-dashboard">60%</div>
                                          <div class="kpi-label-dashboard">Timeliness Percentage</div>
                                      </div>
                                  </div>
                              </div>

                              <h2 class="dashboard-section-title">Performance Trends</h2>
                              <!-- Charts Section (Line Charts) -->
                              <div class="dashboard-grid grid-cols-1 md:grid-cols-3">
                                  <!-- Completeness Rate by Trade Month -->
                                  <div class="chart-container-dashboard">
                                      <h3 class="chart-title-dashboard">Completeness Rate by Trade Month</h3>
                                      <svg class="chart-svg-line" viewBox="0 0 300 150">
                                          <!-- Y-axis labels -->
                                          <text x="10" y="140" font-size="10" fill="#6b7280">80%</text>
                                          <text x="10" y="75" font-size="10" fill="#6b7280">100%</text>
                                          <text x="10" y="10" font-size="10" fill="#6b7280">120%</text>
                                          <!-- X-axis labels -->
                                          <text x="70" y="145" font-size="10" fill="#6b7280">Jan 2025</text>
                                          <text x="150" y="145" font-size="10" fill="#6b7280">May 2025</text>
                                          <text x="230" y="145" font-size="10" fill="#6b7280">Jun 2025</text>
                                          <!-- Grid lines -->
                                          <line x1="40" y1="130" x2="290" y2="130" stroke="#e5e7eb" stroke-width="1"></line>
                                          <line x1="40" y1="65" x2="290" y2="65" stroke="#e5e7eb" stroke-width="1"></line>
                                          <line x1="40" y1="0" x2="290" y2="0" stroke="#e5e7eb" stroke-width="1"></line>
                                          <!-- Line path (approximating 100% flat line) -->
                                          <polyline points="70,65 150,65 230,65" fill="none" stroke="#3B82F6" stroke-width="2"></polyline>
                                      </svg>
                                  </div>
                                  <!-- Timeliness Rate by Trade Month -->
                                  <div class="chart-container-dashboard">
                                      <h3 class="chart-title-dashboard">Timeliness Rate by Trade Month</h3>
                                      <svg class="chart-svg-line" viewBox="0 0 300 150">
                                          <!-- Y-axis labels -->
                                          <text x="10" y="140" font-size="10" fill="#6b7280">60%</text>
                                          <text x="10" y="75" font-size="10" fill="#6b7280">80%</text>
                                          <text x="10" y="10" font-size="10" fill="#6b7280">100%</text>
                                          <!-- X-axis labels -->
                                          <text x="70" y="145" font-size="10" fill="#6b7280">Jan 2025</text>
                                          <text x="150" y="145" font-size="10" fill="#6b7280">May 2025</text>
                                          <text x="230" y="145" font-size="10" fill="#6b7280">Jun 2025</text>
                                          <!-- Grid lines -->
                                          <line x1="40" y1="130" x2="290" y2="130" stroke="#e5e7eb" stroke-width="1"></line>
                                          <line x1="40" y1="65" x2="290" y2="65" stroke="#e5e7eb" stroke-width="1"></line>
                                          <line x1="40" y1="0" x2="290" y2="0" stroke="#e5e7eb" stroke-width="1"></line>
                                          <!-- Line path (approximating declining trend) -->
                                          <polyline points="70,10 150,65 230,130" fill="none" stroke="#3B82F6" stroke-width="2"></polyline>
                                      </svg>
                                  </div>
                                  <!-- Accuracy Rate by Trade Month -->
                                  <div class="chart-container-dashboard">
                                      <h3 class="chart-title-dashboard">Accuracy Rate by Trade Month</h3>
                                      <svg class="chart-svg-line" viewBox="0 0 300 150">
                                          <!-- Y-axis labels -->
                                          <text x="10" y="140" font-size="10" fill="#6b7280">50%</text>
                                          <text x="10" y="75" font-size="10" fill="#6b7280">75%</text>
                                          <text x="10" y="10" font-size="10" fill="#6b7280">100%</text>
                                          <!-- X-axis labels -->
                                          <text x="70" y="145" font-size="10" fill="#6b7280">Jan 2025</text>
                                          <text x="150" y="145" font-size="10" fill="#6b7280">May 2025</text>
                                          <text x="230" y="145" font-size="10" fill="#6b7280">Jun 2025</text>
                                          <!-- Grid lines -->
                                          <line x1="40" y1="130" x2="290" y2="130" stroke="#e5e7eb" stroke-width="1"></line>
                                          <line x1="40" y1="65" x2="290" y2="65" stroke="#e5e7eb" stroke-width="1"></line>
                                          <line x1="40" y1="0" x2="290" y2="0" stroke="#e5e7eb" stroke-width="1"></line>
                                          <!-- Line path (approximating declining trend) -->
                                          <polyline points="70,10 150,65 230,130" fill="none" stroke="#3B82F6" stroke-width="2"></polyline>
                                      </svg>
                                  </div>
                              </div>

                              <h2 class="dashboard-section-title">Regulation Insights</h2>
                              <!-- Table and Donut Charts Section -->
                              <div class="dashboard-grid grid-cols-1 md:grid-cols-3">
                                  <!-- Regulation Status Breakdown Table -->
                                  <div class="md:col-span-1 table-container-dashboard">
                                      <h3 class="chart-title-dashboard p-4 border-b border-gray-200">Regulation Status Breakdown</h3>
                                      <table class="min-w-full divide-y divide-gray-200">
                                          <thead>
                                              <tr>
                                                  <th class="table-header-dashboard-custom">Trade Month</th>
                                                  <th class="table-header-dashboard-custom">Dodd-Frank</th>
                                                  <th class="table-header-dashboard-custom">EMIR</th>
                                                  <th class="table-header-dashboard-custom">MiFID II</th>
                                                  <th class="table-header-dashboard-custom">SFTR</th>
                                                  <th class="table-header-dashboard-custom">Total</th>
                                              </tr>
                                          </thead>
                                          <tbody class="bg-white divide-y divide-gray-200">
                                              <tr class="table-row-hover-dashboard">
                                                  <td class="table-cell-dashboard-custom">Jan 2025</td>
                                                  <td class="table-cell-dashboard-custom">1</td>
                                                  <td class="table-cell-dashboard-custom">1</td>
                                                  <td class="table-cell-dashboard-custom"></td>
                                                  <td class="table-cell-dashboard-custom">1</td>
                                                  <td class="table-cell-dashboard-custom">3</td>
                                              </tr>
                                              <tr class="table-row-hover-dashboard">
                                                  <td class="table-cell-dashboard-custom">Jun 2025</td>
                                                  <td class="table-cell-dashboard-custom"></td>
                                                  <td class="table-cell-dashboard-custom">1</td>
                                                  <td class="table-cell-dashboard-custom">3</td>
                                                  <td class="table-cell-dashboard-custom">2</td>
                                                  <td class="table-cell-dashboard-custom">8</td>
                                              </tr>
                                              <tr class="table-row-hover-dashboard font-bold bg-gray-50">
                                                  <td class="table-cell-dashboard-custom">Total</td>
                                                  <td class="table-cell-dashboard-custom">2</td>
                                                  <td class="table-cell-dashboard-custom">3</td>
                                                  <td class="table-cell-dashboard-custom">4</td>
                                                  <td class="table-cell-dashboard-custom">2</td>
                                                  <td class="table-cell-dashboard-custom">11</td>
                                              </tr>
                                          </tbody>
                                      </table>
                                  </div>
                                  <!-- Regulation Status Breakdown Donut Chart -->
                                  <div class="donut-chart-container-dashboard-custom">
                                      <h3 class="chart-title-dashboard">Regulation Status Breakdown</h3>
                                      <svg class="chart-svg-dashboard-custom" viewBox="0 0 100 100">
                                          <!-- Reported: 63.64% (Blue) -->
                                          <circle cx="50" cy="50" r="40" fill="transparent" stroke="#3B82F6" stroke-width="20"
                                                  stroke-dasharray="200 251.3" stroke-dashoffset="0" transform="rotate(-90 50 50)"></circle>
                                          <!-- Not Reported: 27.27% (Orange) -->
                                          <circle cx="50" cy="50" r="40" fill="transparent" stroke="#F97316" stroke-width="20"
                                                  stroke-dasharray="85.6 251.3" stroke-dashoffset="-200" transform="rotate(-90 50 50)"></circle>
                                          <!-- Rejected: 9.09% (Gray) -->
                                          <circle cx="50" cy="50" r="40" fill="transparent" stroke="#6B7280" stroke-width="20"
                                                  stroke-dasharray="28.6 251.3" stroke-dashoffset="-285.6" transform="rotate(-90 50 50)"></circle>
                                      </svg>
                                      <div class="flex flex-col items-start text-sm">
                                          <div class="flex items-center mb-1 legend-item-dashboard">
                                              <span class="donut-segment-dashboard-custom bg-blue-500"></span> Reported (7 - 63.64%)
                                          </div>
                                          <div class="flex items-center mb-1 legend-item-dashboard">
                                              <span class="donut-segment-dashboard-custom bg-orange-500"></span> Not Reported (3 - 27.27%)
                                          </div>
                                          <div class="flex items-center legend-item-dashboard">
                                              <span class="donut-segment-dashboard-custom bg-gray-500"></span> Rejected (1 - 9.09%)
                                          </div>
                                      </div>
                                  </div>
                                  <!-- Regulation Breakdown Donut Chart -->
                                  <div class="donut-chart-container-dashboard-custom">
                                      <h3 class="chart-title-dashboard">Regulation Breakdown</h3>
                                      <svg class="chart-svg-dashboard-custom" viewBox="0 0 100 100">
                                          <!-- MiFID II: 36.36% (Purple) -->
                                          <circle cx="50" cy="50" r="40" fill="transparent" stroke="#8B5CF6" stroke-width="20"
                                                  stroke-dasharray="114.3 251.3" stroke-dashoffset="0" transform="rotate(-90 50 50)"></circle>
                                          <!-- EMIR: 27.27% (Blue) -->
                                          <circle cx="50" cy="50" r="40" fill="transparent" stroke="#3B82F6" stroke-width="20"
                                                  stroke-dasharray="85.6 251.3" stroke-dashoffset="-114.3" transform="rotate(-90 50 50)"></circle>
                                          <!-- Dodd-Frank: 18.18% (Orange) -->
                                          <circle cx="50" cy="50" r="40" fill="transparent" stroke="#F97316" stroke-width="20"
                                                  stroke-dasharray="57.1 251.3" stroke-dashoffset="-200" transform="rotate(-90 50 50)"></circle>
                                          <!-- SFTR: 18.18% (Gray) -->
                                          <circle cx="50" cy="50" r="40" fill="transparent" stroke="#6B7280" stroke-width="20"
                                                  stroke-dasharray="57.1 251.3" stroke-dashoffset="-257.1" transform="rotate(-90 50 50)"></circle>
                                      </svg>
                                      <div class="flex flex-col items-start text-sm">
                                          <div class="flex items-center mb-1 legend-item-dashboard">
                                              <span class="donut-segment-dashboard-custom bg-purple-500"></span> MiFID II (4 - 36.36%)
                                          </div>
                                          <div class="flex items-center mb-1 legend-item-dashboard">
                                              <span class="donut-segment-dashboard-custom bg-blue-500"></span> EMIR (3 - 27.27%)
                                          </div>
                                          <div class="flex items-center mb-1 legend-item-dashboard">
                                              <span class="donut-segment-dashboard-custom bg-orange-500"></span> Dodd-Frank (2 - 18.18%)
                                          </div>
                                          <div class="flex items-center legend-item-dashboard">
                                              <span class="donut-segment-dashboard-custom bg-gray-500"></span> SFTR (2 - 18.18%)
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  `;
      }

      // Function to get regulatory framework data from Trade Reporting
      function getRegulatoryFrameworkData() {
        console.log('Getting regulatory framework data from reportingTrades:', reportingTrades);
        
        // Sample data for Regulatory Frameworks when no data is available
        const sampleRegulatoryData = {
          'MiFID II': { total: 2, reported: 1, rejected: 0, pending: 1, successRate: 50 },
          'SFTR': { total: 1, reported: 1, rejected: 0, pending: 0, successRate: 100 },
          'MAS': { total: 1, reported: 0, rejected: 0, pending: 1, successRate: 0 },
          'Dodd Frank': { total: 1, reported: 1, rejected: 0, pending: 0, successRate: 100 },
          'EMIR': { total: 0, reported: 0, rejected: 0, pending: 0, successRate: 0 }
        };
        
        // Always use sample data for Regulatory Frameworks to ensure consistent display
        console.log('Using sample data for Regulatory Frameworks');
        return sampleRegulatoryData;

        // Group trades by regulation
        const regulationGroups = {};
        reportingTrades.forEach(trade => {
          const regulation = trade['Reporting Regulation'] || trade.reportingRegulation || 'Unknown';
          console.log('Processing trade with regulation:', regulation, 'Trade:', trade);
          
          if (!regulationGroups[regulation]) {
            regulationGroups[regulation] = {
              total: 0,
              reported: 0,
              rejected: 0,
              pending: 0,
              successRate: 0,
              compliance: 0
            };
          }
          regulationGroups[regulation].total++;
          
          // Determine if trade is reported, rejected, or pending based on status
          const status = trade['Reporting Status'] || trade.reportingStatus || 'PENDING';
          console.log('Trade status:', status);
          
          if (status === 'ACK' || status === 'SUCCESS' || status === 'ACKNOWLEDGED') {
            regulationGroups[regulation].reported++;
          } else if (status === 'NACK' || status === 'REJECTED' || status === 'REJECT') {
            regulationGroups[regulation].rejected++;
          } else {
            regulationGroups[regulation].pending++;
          }
        });

        // Calculate success rates and compliance
        Object.keys(regulationGroups).forEach(regulation => {
          const data = regulationGroups[regulation];
          data.successRate = data.total > 0 ? Math.round((data.reported / data.total) * 100) : 0;
          data.compliance = data.total > 0 ? Math.round(((data.reported + data.rejected) / data.total) * 100) : 0;
        });

        console.log('Final regulatory groups:', regulationGroups);
        return regulationGroups;
      }

      // Function to highlight trades by regulation with light blue color
      function highlightTradesByRegulationLightBlue(regulation) {
        console.log(`Highlighting trades for regulation: ${regulation} with light blue`);
        
        // First, remove any existing highlights
        const allRows = document.querySelectorAll('#tradeTableBody tr');
        allRows.forEach(row => {
          row.classList.remove('highlighted-trade', 'bg-yellow-100', 'border-l-4', 'border-blue-500', 'bg-blue-100', 'border-blue-300');
        });
        
        // Remove any existing text highlights
        const allCells = document.querySelectorAll('#tradeTableBody td');
        allCells.forEach(cell => {
          cell.classList.remove('bg-blue-200', 'text-blue-800', 'font-semibold');
        });
        
        // Find and highlight trades that match the regulation
        const tableBody = document.getElementById('tradeTableBody');
        if (!tableBody) {
          console.log('Trade table body not found');
          return;
        }
        
        const rows = tableBody.querySelectorAll('tr');
        let highlightedCount = 0;
        
        rows.forEach(row => {
          // Find the regulation cell in this row by looking for the regulation text
          const cells = row.querySelectorAll('td');
          let foundRegulation = false;
          
          cells.forEach(cell => {
            const cellText = cell.textContent.trim();
            if (cellText === regulation) {
              foundRegulation = true;
              // Highlight the regulation text specifically with light blue
              cell.classList.add('bg-blue-200', 'text-blue-800', 'font-semibold');
              cell.style.transition = 'all 0.3s ease';
            }
          });
          
          if (foundRegulation) {
            // Highlight this row with light blue color
            row.classList.add('highlighted-trade', 'bg-blue-100', 'border-l-4', 'border-blue-300');
            row.style.transition = 'all 0.3s ease';
            highlightedCount++;
            
            // Add a subtle animation
            setTimeout(() => {
              row.style.transform = 'scale(1.02)';
              setTimeout(() => {
                row.style.transform = 'scale(1)';
              }, 200);
            }, 100);
            
            // Scroll to the first highlighted row if it's not visible
            if (highlightedCount === 1) {
              row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        });
        
        console.log(`Highlighted ${highlightedCount} trades for regulation: ${regulation}`);
        
        // Show a notification if no trades were found
        if (highlightedCount === 0) {
          showHighlightNotification(`No trades found for ${regulation}`, 'warning');
        } else {
          showHighlightNotification(`Found ${highlightedCount} trade(s) for ${regulation}`, 'success');
        }
      }

      // Function to highlight trades by regulation
      function highlightTradesByRegulation(regulation) {
        console.log(`Highlighting trades for regulation: ${regulation}`);
        
        // First, remove any existing highlights
        const allRows = document.querySelectorAll('#tradeTableBody tr');
        allRows.forEach(row => {
          row.classList.remove('highlighted-trade', 'bg-yellow-100', 'border-l-4', 'border-blue-500');
        });
        
        // Find and highlight trades that match the regulation
        const tableBody = document.getElementById('tradeTableBody');
        if (!tableBody) {
          console.log('Trade table body not found');
          return;
        }
        
        const rows = tableBody.querySelectorAll('tr');
        let highlightedCount = 0;
        
        rows.forEach(row => {
          // Find the regulation cell in this row by looking for the regulation text
          const cells = row.querySelectorAll('td');
          let foundRegulation = false;
          
          cells.forEach(cell => {
            const cellText = cell.textContent.trim();
            if (cellText === regulation) {
              foundRegulation = true;
            }
          });
          
          if (foundRegulation) {
            // Highlight this row
            row.classList.add('highlighted-trade', 'bg-yellow-100', 'border-l-4', 'border-blue-500');
            row.style.transition = 'all 0.3s ease';
            highlightedCount++;
            
            // Add a subtle animation
            setTimeout(() => {
              row.style.transform = 'scale(1.02)';
              setTimeout(() => {
                row.style.transform = 'scale(1)';
              }, 200);
            }, 100);
            
            // Scroll to the first highlighted row if it's not visible
            if (highlightedCount === 1) {
              row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        });
        
        console.log(`Highlighted ${highlightedCount} trades for regulation: ${regulation}`);
        
        // Show a notification if no trades were found
        if (highlightedCount === 0) {
          showHighlightNotification(`No trades found for ${regulation}`, 'warning');
        } else {
          showHighlightNotification(`Found ${highlightedCount} trade(s) for ${regulation}`, 'success');
        }
      }

      // Function to show highlight notification
      function showHighlightNotification(message, type) {
        // Remove any existing notification
        const existingNotification = document.querySelector('.highlight-notification');
        if (existingNotification) {
          existingNotification.remove();
        }
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `highlight-notification fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300 ${
          type === 'success' ? 'bg-green-500 text-white' : 'bg-yellow-500 text-white'
        }`;
        notification.textContent = message;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
          notification.style.opacity = '0';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 300);
        }, 3000);
      }

      // Function to clear all highlights
      function clearTradeHighlights() {
        const allRows = document.querySelectorAll('#tradeTableBody tr');
        allRows.forEach(row => {
          row.classList.remove('highlighted-trade', 'bg-yellow-100', 'border-l-4', 'border-blue-500', 'bg-blue-100', 'border-blue-300');
          row.style.transform = '';
        });
        
        // Remove any text highlights
        const allCells = document.querySelectorAll('#tradeTableBody td');
        allCells.forEach(cell => {
          cell.classList.remove('bg-blue-200', 'text-blue-800', 'font-semibold');
        });
        
        // Remove any highlight notifications
        const existingNotification = document.querySelector('.highlight-notification');
        if (existingNotification) {
          existingNotification.remove();
        }
      }

      // Function to refresh regulatory frameworks content
      function refreshRegulatoryFrameworksContent() {
        // Check if regulatory frameworks tab is currently active
        const regulatoryFrameworksTab = document.querySelector('[data-tab="regulatory-frameworks"]');
        if (regulatoryFrameworksTab && regulatoryFrameworksTab.classList.contains('active')) {
          // Update the content
          updateContent('regulatory-frameworks');
        }
      }

      // Function to view trades by regulation (clicking on trade count)
      window.viewTradesByRegulation = function(regulation) {
        console.log(`Viewing trades for regulation: ${regulation}`);
        
        // Add audit log entry
        addAuditLogEntry(
          "Navigation: View Trades by Regulation",
          "N/A",
          "User Interface",
          "N/A",
          `User clicked on trade count for ${regulation}`,
          "Regulatory Frameworks",
          "Trade Reporting"
        );
        
        // Switch to Trade Reporting tab
        const tradeReportingTab = document.querySelector('[data-tab="trade-reporting"]');
        if (tradeReportingTab) {
          // Remove active class from all tabs
          document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
          });
          
          // Add active class to Trade Reporting tab
          tradeReportingTab.classList.add('active');
          
          // Update content to Trade Reporting
          updateContent('trade-reporting');
          
          // Set filter for the specific regulation and highlight trades
          setTimeout(() => {
            // Find the regulation filter dropdown and set the value
            const regulationFilter = document.querySelector('select[data-field="reportingRegulation"]');
            if (regulationFilter) {
              regulationFilter.value = regulation;
              // Trigger the filter
              regulationFilter.dispatchEvent(new Event('change'));
            } else {
              // If dropdown not found, manually filter the data
              console.log('Regulation filter dropdown not found, manually filtering data');
              // Set the active filter for reporting regulation
              if (window.reportingActiveFilters) {
                window.reportingActiveFilters.reportingRegulation = {
                  type: 'text',
                  value: regulation
                };
                // Re-populate the table with filtered data
                if (window.populateReportingTradeTable) {
                  window.populateReportingTradeTable();
                }
              }
            }
            
            // Highlight the filtered trades with light blue color
            setTimeout(() => {
              highlightTradesByRegulationLightBlue(regulation);
            }, 300);
          }, 500);
        }
      }

      // Function to view related trades for a specific regulation
      function viewRelatedTrades(regulation) {
        console.log(`Viewing related trades for ${regulation}`);
        
        // Add audit log entry
        addAuditLogEntry(
          "Navigation: View Related Trades",
          "N/A",
          "User Interface",
          "N/A",
          `User clicked to view related trades for ${regulation}`,
          "Regulatory Frameworks",
          "Trade Reporting"
        );
        
        // Switch to Trade Reporting tab
        const tradeReportingTab = document.querySelector('[data-tab="trade-reporting"]');
        if (tradeReportingTab) {
          // Remove active class from all tabs
          document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
          });
          
          // Add active class to Trade Reporting tab
          tradeReportingTab.classList.add('active');
          
          // Update content to Trade Reporting
          updateContent('trade-reporting');
          
          // Set filter for the specific regulation and highlight trades
          setTimeout(() => {
            // Find the regulation filter dropdown and set the value
            const regulationFilter = document.querySelector('select[data-field="reportingRegulation"]');
            if (regulationFilter) {
              regulationFilter.value = regulation;
              // Trigger the filter
              regulationFilter.dispatchEvent(new Event('change'));
            } else {
              // If dropdown not found, manually filter the data
              console.log('Regulation filter dropdown not found, manually filtering data');
              // Set the active filter for reporting regulation
              if (window.reportingActiveFilters) {
                window.reportingActiveFilters.reportingRegulation = {
                  type: 'text',
                  value: regulation
                };
                // Re-populate the table with filtered data
                if (window.populateReportingTradeTable) {
                  window.populateReportingTradeTable();
                }
              }
            }
            
            // Highlight the filtered trades after a short delay
            setTimeout(() => {
              highlightTradesByRegulation(regulation);
            }, 300);
          }, 500);
        }
      }

      function renderRegulatoryFrameworksContent() {
        // Get dynamic data from Trade Reporting
        const regulatoryData = getRegulatoryFrameworkData();
        
        return `
                      <div class="p-6 bg-white rounded-lg shadow-md">
                          <h2 class="text-2xl font-semibold text-gray-800 mb-2">Regulatory Frameworks</h2>
                          <p class="text-gray-600 italic text-sm mb-6">
                              This section outlines major global regulations such as MiFID II, EMIR, SFTR, Dodd-Frank, and MAS, each governing trade and transaction reporting requirements. It provides users with essential insights into reporting obligations, key data fields, and compliance timelines.
                          </p>
                          <!-- Sub-tabs Container -->
                          <div class="flex flex-wrap gap-2 md:gap-4 mb-6">
                              <!-- MiFID II Sub-tab -->
                              <button id="mifid-ii-tab" class="framework-tab-button active-framework">
                                  MiFID II
                              </button>
                              <!-- SFTR Sub-tab -->
                              <button id="sftr-tab" class="framework-tab-button">
                                  SFTR
                              </button>
                              <!-- MAS Sub-tab -->
                              <button id="mas-tab" class="framework-tab-button">
                                  MAS
                              </button>
                              <!-- Dodd Frank Sub-tab -->
                              <button id="dodd-frank-tab" class="framework-tab-button">
                                  Dodd Frank
                              </button>
                          </div>
                          <!-- Content Area for Sub-tabs -->
                          <div id="sub-tab-content" class="framework-tab-pane">
                              <!-- MiFID II Content -->
                              <div id="mifid-ii-description" class="tab-pane">
                                  <p class="text-sm italic text-gray-600 leading-relaxed mb-4">
                                      MiFID II is a European Union regulation that enhances transparency in financial markets and strengthens investor protection. It mandates detailed trade and transaction reporting, best execution practices, and stricter oversight of trading venues.
                                  </p>
                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Reporting Overview</h3>
                                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-4">
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Trades Eligible:</p>
                                          <p class="framework-kpi-value text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" onclick="viewTradesByRegulation('MiFID II')">${regulatoryData['MiFID II']?.total || 0}</p>
                                      </div>
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Successful:</p>
                                          <p class="framework-kpi-value text-green-600">${regulatoryData['MiFID II']?.reported || 0}</p>
                                      </div>
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Pending:</p>
                                          <p class="framework-kpi-value text-yellow-600">${regulatoryData['MiFID II']?.pending || 0}</p>
                                      </div>
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Reporting Success Rate:</p>
                                          <p class="framework-kpi-value text-blue-600">${regulatoryData['MiFID II']?.successRate || 0}%</p>
                                      </div>
                                      </div>

                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Key Compliance Deadlines</h3>
                                  <ul class="list-disc list-inside text-gray-700 text-sm mb-4">
                                      <li>Transaction Reporting: T+1</li>
                                      <li>Reference Data Updates: Ongoing</li>
                                  </ul>
                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Recent Regulatory Updates</h3>
                                  <p class="text-sm text-gray-700 mb-4">
                                      ESMA guidance on data quality improvements (Q2 2025).
                                  </p>
                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Detailed Trade & Transaction Reporting</h3>
                                  <div class="overflow-x-auto">
                                      <table class="min-w-full bg-white rounded-lg shadow-sm border border-gray-200">
                                          <thead>
                                              <tr>
                                                  <th class="framework-table-header">Trade ID</th>
                                                  <th class="framework-table-header">Instrument</th>
                                                  <th class="framework-table-header">Venue</th>
                                                  <th class="framework-table-header">Price</th>
                                                  <th class="framework-table-header">Quantity</th>
                                                  <th class="framework-table-header">Reporting Status</th>
                                                  <th class="framework-table-header">Timestamp</th>
                                              </tr>
                                          </thead>
                                          <tbody>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">TRD001</td>
                                                  <td class="framework-table-cell">AAPL Equity</td>
                                                  <td class="framework-table-cell">XLON</td>
                                                  <td class="framework-table-cell">175.20</td>
                                                  <td class="framework-table-cell">100</td>
                                                  <td class="framework-table-cell text-green-600">ACK</td>
                                                  <td class="framework-table-cell">2025-07-01 10:00</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">TRD002</td>
                                                  <td class="framework-table-cell">GOOGL Equity</td>
                                                  <td class="framework-table-cell">XETR</td>
                                                  <td class="framework-table-cell">150.10</td>
                                                  <td class="framework-table-cell">50</td>
                                                  <td class="framework-table-cell text-green-600">ACK</td>
                                                  <td class="framework-table-cell">2025-07-01 10:15</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">TRD003</td>
                                                  <td class="framework-table-cell">TSLA Equity</td>
                                                  <td class="framework-table-cell">CHIX</td>
                                                  <td class="framework-table-cell">250.00</td>
                                                  <td class="framework-table-cell">20</td>
                                                  <td class="framework-table-cell text-green-600">ACK</td>
                                                  <td class="framework-table-cell">2025-07-01 10:30</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">TRD004</td>
                                                  <td class="framework-table-cell">MSFT Equity</td>
                                                  <td class="framework-table-cell">XLON</td>
                                                  <td class="framework-table-cell">300.50</td>
                                                  <td class="framework-table-cell">75</td>
                                                  <td class="framework-table-cell text-red-600">NACK (Invalid LEI)</td>
                                                  <td class="framework-table-cell">2025-07-01 10:45</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">TRD005</td>
                                                  <td class="framework-table-cell">AMZN Equity</td>
                                                  <td class="framework-table-cell">XETR</td>
                                                  <td class="framework-table-cell">120.00</td>
                                                  <td class="framework-table-cell">150</td>
                                                  <td class="framework-table-cell text-red-600">NACK (Missing Price)</td>
                                                  <td class="framework-table-cell">2025-07-01 11:00</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">TRD006</td>
                                                  <td class="framework-table-cell">NVDA Equity</td>
                                                  <td class="framework-table-cell">CHIX</td>
                                                  <td class="framework-table-cell">900.00</td>
                                                  <td class="framework-table-cell"></td>
                                                  <td class="framework-table-cell text-yellow-600">PENDING</td>
                                                  <td class="framework-table-cell">2025-07-01 11:15</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">TRD007</td>
                                                  <td class="framework-table-cell">JPM Bond</td>
                                                  <td class="framework-table-cell">OTC</td>
                                                  <td class="framework-table-cell">102.50</td>
                                                  <td class="framework-table-cell">50000</td>
                                                  <td class="framework-table-cell text-yellow-600">PENDING</td>
                                                  <td class="framework-table-cell">2025-07-01 11:30</td>
                                              </tr>
                                          </tbody>
                                      </table>
                                  </div>
                              </div>
                              <!-- SFTR Content -->
                              <div id="sftr-description" class="tab-pane hidden">
                                  <p class="text-sm italic text-gray-600 leading-relaxed mb-4">
                                      SFTR (Securities Financing Transactions Regulation) is an EU regulation that increases transparency in securities financing markets, such as repos and securities lending. It requires firms to report transaction details to authorized trade repositories to monitor systemic risk and shadow banking activities.
                                  </p>
                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Reporting Overview</h3>
                                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-4">
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Total Trades:</p>
                                          <p class="framework-kpi-value text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" onclick="viewTradesByRegulation('SFTR')">${regulatoryData['SFTR']?.total || 0}</p>
                                      </div>
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Successful:</p>
                                          <p class="framework-kpi-value text-green-600">${regulatoryData['SFTR']?.reported || 0}</p>
                                      </div>
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Pending:</p>
                                          <p class="framework-kpi-value text-yellow-600">${regulatoryData['SFTR']?.pending || 0}</p>
                                      </div>
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Reporting Rate:</p>
                                          <p class="framework-kpi-value text-blue-600">${regulatoryData['SFTR']?.successRate || 0}%</p>
                                      </div>
                                      </div>

                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Key Compliance Deadlines</h3>
                                  <ul class="list-disc list-inside text-gray-700 text-sm mb-4">
                                      <li>Reporting of SFTs: T+1</li>
                                      <li>Lifecycle Event Reporting: T+1</li>
                                  </ul>
                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Recent Regulatory Updates</h3>
                                  <p class="text-sm text-gray-700 mb-4">
                                      ESMA Q&A updates on SFTR reporting fields (Q3 2025).
                                  </p>
                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Detailed Trade & Transaction Reporting</h3>
                                  <div class="overflow-x-auto">
                                      <table class="min-w-full bg-white rounded-lg shadow-sm border border-gray-200">
                                          <thead>
                                              <tr>
                                                  <th class="framework-table-header">Trade ID</th>
                                                  <th class="framework-table-header">SFT Type</th>
                                                  <th class="framework-table-header">Collateral Value</th>
                                                  <th class="framework-table-header">UTI</th>
                                                  <th class="framework-table-header">Reporting Status</th>
                                                  <th class="framework-table-header">Timestamp</th>
                                              </tr>
                                          </thead>
                                          <tbody>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">SFT001</td>
                                                  <td class="framework-table-cell">Repo</td>
                                                  <td class="framework-table-cell">1,000,000</td>
                                                  <td class="framework-table-cell">UTI12345</td>
                                                  <td class="framework-table-cell text-green-600">ACK</td>
                                                  <td class="framework-table-cell">2025-07-01 09:00</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">SFT002</td>
                                                  <td class="framework-table-cell">Securities Lending</td>
                                                  <td class="framework-table-cell">500,000</td>
                                                  <td class="framework-table-cell">UTI12346</td>
                                                  <td class="framework-table-cell text-green-600">ACK</td>
                                                  <td class="framework-table-cell">2025-07-01 09:30</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">SFT003</td>
                                                  <td class="framework-table-cell">Buy-Sell Back</td>
                                                  <td class="framework-table-cell">2,000,000</td>
                                                  <td class="framework-table-cell">UTI12347</td>
                                                  <td class="framework-table-cell text-green-600">ACK</td>
                                                  <td class="framework-table-cell">2025-07-01 10:00</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">SFT004</td>
                                                  <td class="framework-table-cell">Repo</td>
                                                  <td class="framework-table-cell">750,000</td>
                                                  <td class="framework-table-cell">UTI123XX</td>
                                                  <td class="framework-table-cell text-red-600">NACK (UTI Mismatch)</td>
                                                  <td class="framework-table-cell">2025-07-01 10:45</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">SFT005</td>
                                                  <td class="framework-table-cell">Securities Lending</td>
                                                  <td class="framework-table-cell">1,200,000</td>
                                                  <td class="framework-table-cell">UTI12349</td>
                                                  <td class="framework-table-cell text-red-600">NACK (Invalid Collateral Value)</td>
                                                  <td class="framework-table-cell">2025-07-01 11:15</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">SFT006</td>
                                                  <td class="framework-table-cell">Repo</td>
                                                  <td class="framework-table-cell">300,000</td>
                                                  <td class="framework-table-cell">UTI12350</td>
                                                  <td class="framework-table-cell text-yellow-600">PENDING</td>
                                                  <td class="framework-table-cell">2025-07-01 11:45</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">SFT007</td>
                                                  <td class="framework-table-cell">Buy-Sell Back</td>
                                                  <td class="framework-table-cell">900,000</td>
                                                  <td class="framework-table-cell">UTI12351</td>
                                                  <td class="framework-table-cell text-yellow-600">PENDING</td>
                                                  <td class="framework-table-cell">2025-07-01 12:00</td>
                                              </tr>
                                          </tbody>
                                      </table>
                                  </div>
                              </div>
                              <!-- MAS Content -->
                              <div id="mas-description" class="tab-pane hidden">
                                  <p class="text-sm italic text-gray-600 leading-relaxed mb-4">
                                      MAS mandates the reporting of over-the-counter (OTC) derivatives to improve transparency and monitor systemic risk in Singapore's financial markets. It ensures timely and accurate submission of trade data to licensed trade repositories.
                                  </p>
                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Reporting Overview</h3>
                                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-4">
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Total Trades:</p>
                                          <p class="framework-kpi-value text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" onclick="viewTradesByRegulation('MAS')">${regulatoryData['MAS']?.total || 0}</p>
                                      </div>
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Successful:</p>
                                          <p class="framework-kpi-value text-green-600">${regulatoryData['MAS']?.reported || 0}</p>
                                      </div>
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Pending:</p>
                                          <p class="framework-kpi-value text-yellow-600">${regulatoryData['MAS']?.pending || 0}</p>
                                      </div>
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Reporting Success Rate:</p>
                                          <p class="framework-kpi-value text-blue-600">${regulatoryData['MAS']?.successRate || 0}%</p>
                                      </div>
                                      </div>

                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Key Compliance Deadlines</h3>
                                  <ul class="list-disc list-inside text-gray-700 text-sm mb-4">
                                      <li>OTC Derivatives Reporting: T+1</li>
                                      <li>Valuation Data Submission: Daily</li>
                                  </ul>
                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Recent Regulatory Updates</h3>
                                  <p class="text-sm text-gray-700 mb-4">
                                      MAS consultation paper on digital asset regulation (Q4 2025).
                                  </p>
                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Detailed Trade & Transaction Reporting</h3>
                                  <div class="overflow-x-auto">
                                      <table class="min-w-full bg-white rounded-lg shadow-sm border border-gray-200">
                                          <thead>
                                              <tr>
                                                  <th class="framework-table-header">Trade ID</th>
                                                  <th class="framework-table-header">Derivative Type</th>
                                                  <th class="framework-table-header">Notional Value</th>
                                                  <th class="framework-table-header">Reporting Status</th>
                                                  <th class="framework-table-header">Timestamp</th>
                                              </tr>
                                          </thead>
                                          <tbody>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">MAS001</td>
                                                  <td class="framework-table-cell">FX Swap</td>
                                                  <td class="framework-table-cell">5,000,000 USD</td>
                                                  <td class="framework-table-cell text-green-600">ACK</td>
                                                  <td class="framework-table-cell">2025-07-01 09:10</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">MAS002</td>
                                                  <td class="framework-table-cell">Interest Rate Swap</td>
                                                  <td class="framework-table-cell">10,000,000 SGD</td>
                                                  <td class="framework-table-cell text-green-600">ACK</td>
                                                  <td class="framework-table-cell">2025-07-01 09:40</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">MAS003</td>
                                                  <td class="framework-table-cell">Credit Default Swap</td>
                                                  <td class="framework-table-cell">2,500,000 USD</td>
                                                  <td class="framework-table-cell text-green-600">ACK</td>
                                                  <td class="framework-table-cell">2025-07-01 10:10</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">MAS004</td>
                                                  <td class="framework-table-cell">FX Option</td>
                                                  <td class="framework-table-cell">1,000,000 EUR</td>
                                                  <td class="framework-table-cell text-red-600">NACK (Incomplete Data)</td>
                                                  <td class="framework-table-cell">2025-07-01 10:50</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">MAS005</td>
                                                  <td class="framework-table-cell">Equity Option</td>
                                                  <td class="framework-table-cell">500,000 USD</td>
                                                  <td class="framework-table-cell text-red-600">NACK (Invalid Product ID)</td>
                                                  <td class="framework-table-cell">2025-07-01 11:20</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">MAS006</td>
                                                  <td class="framework-table-cell">Commodity Swap</td>
                                                  <td class="framework-table-cell">750,000 USD</td>
                                                  <td class="framework-table-cell text-yellow-600">PENDING</td>
                                                  <td class="framework-table-cell">2025-07-01 11:50</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">MAS007</td>
                                                  <td class="framework-table-cell">FX Forward</td>
                                                  <td class="framework-table-cell">3,000,000 EUR</td>
                                                  <td class="framework-table-cell text-yellow-600">PENDING</td>
                                                  <td class="framework-table-cell">2025-07-01 12:20</td>
                                              </tr>
                                          </tbody>
                                      </table>
                                  </div>
                              </div>
                              <!-- Dodd Frank Content -->
                              <div id="dodd-frank-description" class="tab-pane hidden">
                                  <p class="text-sm italic text-gray-600 leading-relaxed mb-4">
                                      The Dodd-Frank Act is a U.S. regulation introduced after the 2008 financial crisis to promote financial stability. It requires mandatory clearing, trade reporting, and risk mitigation for OTC derivatives to increase transparency and reduce systemic risk.
                                  </p>
                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Reporting Overview</h3>
                                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-4">
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Trades Eligible:</p>
                                          <p class="framework-kpi-value text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" onclick="viewTradesByRegulation('Dodd Frank')">${regulatoryData['Dodd Frank']?.total || 0}</p>
                                      </div>
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Successful:</p>
                                          <p class="framework-kpi-value text-green-600">${regulatoryData['Dodd Frank']?.reported || 0}</p>
                                      </div>
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Pending:</p>
                                          <p class="framework-kpi-value text-yellow-600">${regulatoryData['Dodd Frank']?.pending || 0}</p>
                                      </div>
                                      <div class="framework-kpi-box">
                                          <p class="framework-kpi-label">Reporting Rate:</p>
                                          <p class="framework-kpi-value text-blue-600">${regulatoryData['Dodd Frank']?.successRate || 0}%</p>
                                      </div>
                                      </div>

                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Key Compliance Deadlines</h3>
                                  <ul class="list-disc list-inside text-gray-700 text-sm mb-4">
                                      <li>Swap Data Reporting: T+0/T+1 (depending on type)</li>
                                      <li>Real-time Public Dissemination: Immediate</li>
                                  </ul>
                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Recent Regulatory Updates</h3>
                                  <p class="text-sm text-gray-700 mb-4">
                                      CFTC guidance on swap data reporting requirements (Q1 2025).
                                  </p>
                                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Detailed Trade & Transaction Reporting</h3>
                                  <div class="overflow-x-auto">
                                      <table class="min-w-full bg-white rounded-lg shadow-sm border border-gray-200">
                                          <thead>
                                              <tr>
                                                  <th class="framework-table-header">Trade ID</th>
                                                  <th class="framework-table-header">Swap Type</th>
                                                  <th class="framework-table-header">Clearing Status</th>
                                                  <th class="framework-table-header">SDR</th>
                                                  <th class="framework-table-header">Reporting Status</th>
                                                  <th class="framework-table-header">Timestamp</th>
                                              </tr>
                                          </thead>
                                          <tbody>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">DF001</td>
                                                  <td class="framework-table-cell">Interest Rate Swap</td>
                                                  <td class="framework-table-cell">Cleared</td>
                                                  <td class="framework-table-cell">DTCC</td>
                                                  <td class="framework-table-cell text-green-600">ACK</td>
                                                  <td class="framework-table-cell">2025-07-01 09:20</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">DF002</td>
                                                  <td class="framework-table-cell">Credit Default Swap</td>
                                                  <td class="framework-table-cell">Cleared</td>
                                                  <td class="framework-table-cell">ICE Trade Vault</td>
                                                  <td class="framework-table-cell text-green-600">ACK</td>
                                                  <td class="framework-table-cell">2025-07-01 09:50</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">DF003</td>
                                                  <td class="framework-table-cell">FX Swap</td>
                                                  <td class="framework-table-cell">Uncleared</td>
                                                  <td class="framework-table-cell">DTCC</td>
                                                  <td class="framework-table-cell text-green-600">ACK</td>
                                                  <td class="framework-table-cell">2025-07-01 10:20</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">DF004</td>
                                                  <td class="framework-table-cell">Equity Swap</td>
                                                  <td class="framework-table-cell">Cleared</td>
                                                  <td class="framework-table-cell">ICE Trade Vault</td>
                                                  <td class="framework-table-cell text-red-600">NACK (SDR Reporting Error)</td>
                                                  <td class="framework-table-cell">2025-07-01 11:00</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">DF005</td>
                                                  <td class="framework-table-cell">Commodity Swap</td>
                                                  <td class="framework-table-cell">Uncleared</td>
                                                  <td class="framework-table-cell">DTCC</td>
                                                  <td class="framework-table-cell text-red-600">NACK (Missing Counterparty)</td>
                                                  <td class="framework-table-cell">2025-07-01 11:30</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">DF006</td>
                                                  <td class="framework-table-cell">Interest Rate Swap</td>
                                                  <td class="framework-table-cell">Cleared</td>
                                                  <td class="framework-table-cell">ICE Trade Vault</td>
                                                  <td class="framework-table-cell text-yellow-600">PENDING</td>
                                                  <td class="framework-table-cell">2025-07-01 12:00</td>
                                              </tr>
                                              <tr class="hover:bg-gray-50">
                                                  <td class="framework-table-cell">DF007</td>
                                                  <td class="framework-table-cell">Credit Default Swap</td>
                                                  <td class="framework-table-cell">Uncleared</td>
                                                  <td class="framework-table-cell">DTCC</td>
                                                  <td class="framework-table-cell text-yellow-600">PENDING</td>
                                                  <td class="framework-table-cell">2025-07-01 12:30</td>
                                              </tr>
                                          </tbody>
                                      </table>
                                  </div>
                              </div>
                          </div>
                      </div>
                  `;
      }

      function renderAuditTrailContent() {
        // Modified to return empty content initially
        return `
                      <div class="p-6 bg-white rounded-lg shadow-md">
                          <h2 class="text-2xl font-semibold text-gray-800 mb-2">Audit Trail</h2>
                          <p class="text-gray-600 italic text-sm mb-6">
                              This tab provides a comprehensive log of all system and user activities related to trade processing and regulatory adherence, ensuring transparency and accountability.
                          </p>



                          <!-- Filters Section -->
                          <section class="mb-6 p-4 bg-gray-50 rounded-md border border-gray-200">
                              <h3 class="text-lg font-semibold text-gray-800 mb-3">Filter Audit Logs</h3>
                              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                  <div>
                                      <label for="actionTypeFilter" class="block text-sm font-medium text-gray-700 mb-1">Action Type</label>
                                      <select id="actionTypeFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                          <option value="">All</option>
                                          <option value="System">System</option>
                                          <option value="Manual">Manual</option>
                                      </select>
                                  </div>
                                  <div>
                                      <label for="tradeIdFilter" class="block text-sm font-medium text-gray-700 mb-1">Trade ID</label>
                                      <input type="text" id="tradeIdFilter" placeholder="e.g., TRD001" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                                  </div>
                                  <div>
                                      <label for="departmentFilter" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                                      <input type="text" id="departmentFilter" placeholder="e.g., Operations" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                                  </div>
                                  <div>
                                      <label for="regulationFilter" class="block text-sm font-medium text-gray-700 mb-1">Regulation Affected</label>
                                      <select id="regulationFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                          <option value="">All</option>
                                          <option value="MiFID II">MiFID II</option>
                                          <option value="EMIR">EMIR</option>
                                          <option value="SFTR">SFTR</option>
                                          <option value="Dodd-Frank">Dodd-Frank</option>
                                          <option value="GDPR">GDPR</option>
                                      </select>
                                  </div>
                              </div>
                          </section>

                          <!-- Audit Trail Table -->
                          <section>
                              <h3 class="text-xl font-semibold text-gray-800 mb-4">Audit Log Entries</h3>
                              <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200 audit-table-container">
                                  <table class="min-w-full divide-y divide-gray-200">
                                      <thead class="bg-gray-100">
                                          <tr>
                                              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-key="timestamp">
                                                  Timestamp <span class="audit-sort-arrow" data-sort-target="timestamp"></span>
                                              </th>
                                              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-key="actionType">
                                                  Action Type <span class="audit-sort-arrow" data-sort-target="actionType"></span>
                                              </th>
                                              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-key="tradeID">
                                                  Trade ID <span class="audit-sort-arrow" data-sort-target="tradeID"></span>
                                              </th>
                                              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-key="department">
                                                  Department <span class="audit-sort-arrow" data-sort-target="department"></span>
                                              </th>
                                              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-key="regulationAffected">
                                                  Regulation Affected <span class="audit-sort-arrow" data-sort-target="regulationAffected"></span>
                                              </th>
                                              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                  Remarks
                                              </th>
                                              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                  Status Before
                                              </th>
                                              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                  Status After
                                              </th>
                                          </tr>
                                      </thead>
                                      <tbody class="bg-white divide-y divide-gray-200" id="auditTrailTableBody">
                                          <!-- Audit log data will be populated here by JavaScript -->
                                      </tbody>
                                  </table>
                              </div>
                          </section>
                      </div>
                  `;
      }

      // Function to update content based on tab
      function updateContent(tabName) {
        console.log("updateContent called with tabName:", tabName);
        const contentArea = document.getElementById("contentArea"); // Define contentArea here
        if (!contentArea) {
          console.error("Error: contentArea element not found.");
          return; // Exit if contentArea is not found
        }
        console.log("Content area found, updating to tab:", tabName);
        currentActiveTab = tabName; // Update the global active tab state
        let content = "";
        contentArea.style.textAlign = "center"; // Reset text alignment for general content

        // Unsubscribe from previous real-time listeners if switching tabs
        if (
          tabName !== "trade-exception" &&
          window.unsubscribeExceptionTrades
        ) {
          window.unsubscribeExceptionTrades();
        }

        switch (tabName) {
          case "dashboard":
            contentArea.style.textAlign = "left"; // Align content left for the dashboard
            content = renderDashboardContent();
            break;
          case "trade-exception":
            contentArea.style.textAlign = "left"; // Align content left for the table
            content = `
              <h1 class="text-2xl font-bold mb-2">Trade Exception</h1>
              ${renderTradeExceptionContent()}
            `;
            // Initial render of the table, possibly with mock data or empty
            setTimeout(() => {
              renderExceptionTable(exceptionTradeData);
              attachExceptionTableEventListeners();
            }, 100);
            break;
          case "trade-reporting":
            contentArea.style.textAlign = "left"; // Align content left for the table
            content = renderTradeReportingContent();
            // Populate the trade reporting table after content is rendered
            setTimeout(() => {
              if (window.populateReportingTradeTable) {
                window.populateReportingTradeTable();
              }
            }, 100);
            break;
          case "regulatory-frameworks":
            contentArea.style.textAlign = "left"; // Align content left for the frameworks
            content = renderRegulatoryFrameworksContent();
            // Attach event listeners for the sub-tabs within Regulatory Frameworks
            // This needs to be done *after* the content is rendered
            setTimeout(() => {
              // Use setTimeout to ensure DOM elements are available
              const mifidIiTab = document.getElementById("mifid-ii-tab");
              const sftrTab = document.getElementById("sftr-tab");
              const masTab = document.getElementById("mas-tab");
              const doddFrankTab = document.getElementById("dodd-frank-tab");
              const tabPanes = document.querySelectorAll(
                "#sub-tab-content .tab-pane"
              );

              // Function to hide all tab panes
              const hideAllTabPanes = () => {
                tabPanes.forEach((pane) => {
                  pane.classList.add("hidden");
                });
              };
              // Function to deactivate all tabs
              const deactivateAllTabs = () => {
                mifidIiTab.classList.remove("active-framework");
                sftrTab.classList.remove("active-framework");
                masTab.classList.remove("active-framework");
                doddFrankTab.classList.remove("active-framework");
              };

              // Event Listeners for sub-tabs
              mifidIiTab.addEventListener("click", () => {
                hideAllTabPanes();
                deactivateAllTabs();
                document
                  .getElementById("mifid-ii-description")
                  .classList.remove("hidden");
                mifidIiTab.classList.add("active-framework");
              });
              sftrTab.addEventListener("click", () => {
                hideAllTabPanes();
                deactivateAllTabs();
                document
                  .getElementById("sftr-description")
                  .classList.remove("hidden");
                sftrTab.classList.add("active-framework");
              });
              masTab.addEventListener("click", () => {
                hideAllTabPanes();
                deactivateAllTabs();
                document
                  .getElementById("mas-description")
                  .classList.remove("hidden");
                masTab.classList.add("active-framework");
              });
              doddFrankTab.addEventListener("click", () => {
                hideAllTabPanes();
                deactivateAllTabs();
                document
                  .getElementById("dodd-frank-description")
                  .classList.remove("hidden");
                doddFrankTab.classList.add("active-framework");
              });

              // Set MiFID II as active on initial load of the frameworks tab
              mifidIiTab.click();
            }, 0); // Use setTimeout with 0 to defer execution until after DOM update
            break;
          case "audit-trail":
            console.log("Switching to audit-trail tab");
            contentArea.style.textAlign = "left"; // Align content left for the table
            content = renderAuditTrailContent();
            // Populate audit trail table after content is rendered
            setTimeout(() => {
              console.log("Audit trail tab content rendered, now populating table with auditData:", auditData);
              renderAuditTable(auditData);
              // Set up filter event listeners
              const actionTypeFilter = document.getElementById("actionTypeFilter");
              const tradeIdFilter = document.getElementById("tradeIdFilter");
              const departmentFilter = document.getElementById("departmentFilter");
              const regulationFilter = document.getElementById("regulationFilter");
              
              if (actionTypeFilter) {
                actionTypeFilter.addEventListener("change", applyAuditFiltersAndSort);
              }
              if (tradeIdFilter) {
                tradeIdFilter.addEventListener("input", applyAuditFiltersAndSort);
              }
              if (departmentFilter) {
                departmentFilter.addEventListener("input", applyAuditFiltersAndSort);
              }
              if (regulationFilter) {
                regulationFilter.addEventListener("change", applyAuditFiltersAndSort);
              }
            }, 0);
            break;
          case "trade-data": // Corrected tab name and content
            contentArea.style.textAlign = "left"; // Align content left for the table
            content = `
                              <div class="p-6 bg-white rounded-lg shadow-md">
                                  <h2 class="text-2xl font-semibold text-gray-800 mb-4">Trade Data</h2>
                                  <p class="text-gray-600 italic text-sm mb-4">This tab displays comprehensive trade data.</p>
                                  <div id="reguDataTableContainer"></div>
                                  <div class="flex justify-start mb-4">
                                      <button id="sourceFromDbBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out flex items-center">
                                      <i class="fas fa-database mr-2"></i> Fetch Data
                                          <div id="loadingIndicator" class="spinner ml-2 hidden"></div>
                                      </button>
                                  </div>
                                  <h3 class="text-xl font-semibold text-gray-800 mb-4">Regulatory Data</h3>
                                  <div id="regulatoryDataTableContainer"></div>
                                  <div class="flex justify-start mt-6">
                                      <button id="unifyDataBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out flex items-center">
                                      <i class="fas fa-link mr-2"></i> Save
                                      </button>
                                  </div>
                                  <div id="saveNotification" class="fixed bottom-6 right-6 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50 hidden transition-opacity duration-300">Data saved successfully!</div>
                              </div>
                          `;
            // Render static regulatory data immediately
            setTimeout(() => {
              const regulatoryDataTableContainer = document.getElementById(
                "regulatoryDataTableContainer"
              );
              if (regulatoryDataTableContainer) {
                regulatoryDataTableContainer.innerHTML =
                  renderRegulatoryDataTable(staticRegulatoryData);
              }
              // Attach event listener for "Fetch Data" button in this tab
              const sourceFromDbBtn =
                document.getElementById("sourceFromDbBtn");
              if (sourceFromDbBtn) {
                sourceFromDbBtn.addEventListener(
                  "click",
                  sourceFromDbBtnHandle
                );
              }
              // Attach event listener for Save button notification
              const saveBtn = document.getElementById("unifyDataBtn");
              if (saveBtn) {
                saveBtn.addEventListener("click", () => {
                  const notification = document.getElementById("saveNotification");
                  if (notification) {
                    notification.classList.remove("hidden");
                    notification.style.opacity = 1;
                    setTimeout(() => {
                      notification.style.opacity = 0;
                      setTimeout(() => notification.classList.add("hidden"), 300);
                    }, 2000);
                  }
                });
              }
            }, 0);
            break;
          default:
            content = "<p>Select a tab to view content.</p>";
        }
        // Handler for Source from Database button
        const sourceFromDbBtnHandle = async () => {
          try {
            // Your web app's Firebase configuration
            const firebaseConfig = {
              apiKey: "AIzaSyCgK8fg7tXgaU-0oWcCGO9bdHWnwImLBmQ",
              authDomain: "barclays-network-management.firebaseapp.com",
              projectId: "barclays-network-management",
              storageBucket: "barclays-network-management.firebasestorage.app",
              messagingSenderId: "308811523712",
              appId: "1:308811523712:web:69e0bc7919d1057cbc2865",
              measurementId: "G-X0HKTS2D3E",
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            const getReguData = async () => {
              const querySnapshot = await getDocs(
                collection(db, "cost_management")
              );
              const trades = [];
              querySnapshot.forEach((doc) => {
                // doc.data() is never undefined for query doc snapshots
                trades.push(doc.data());
              });
              // Limit to only 2 rows
              return trades.slice(0, 2);
            };
            // Helper to authenticate and fetch data
            const reguData = await getReguData();
            // Render the table in regulatoryDataTableContainer
            const regulatoryDataTableContainer = document.getElementById(
              "regulatoryDataTableContainer"
            );
            if (regulatoryDataTableContainer) {
              reguDataTableContainer.innerHTML =
                renderRegulatoryDataTable(reguData);
            }
          } catch (error) {
            alert("Failed to fetch data from database: " + error.message);
          } finally {
            if (loadingIndicator) loadingIndicator.classList.add("hidden");
          }
        };
        contentArea.innerHTML = content;

        if (tabName === "trade-exception") {
          // Initial render of the table, possibly with mock data or empty
          // The fetchTradeDataFromDatabase will be called on button click
          // renderExceptionTable(exceptionTradeData); // Already called in setTimeout
          // attachExceptionTableEventListeners(); // Already called in setTimeout
        } else if (tabName === "trade-reporting") {
          // Initialize summary, table, and charts for Trade Reporting
          populateReportingSummary();
          populateReportingTradeTable();
          drawReportingCharts();

          // Attach event listeners for sorting and filtering in the reporting table
          document
            .querySelectorAll("#detailedTable thead th .header-container")
            .forEach((header) => {
              const columnKey = header.dataset.column;
              const dropdownMenu = header.querySelector(".dropdown-menu");
              const filterIcon = header.querySelector(".filter-icon-reporting"); // Get the filter icon

              // Only open dropdown when clicking the filter icon or caret, not the whole header
              filterIcon.addEventListener("click", (event) => {
                // Close other dropdowns
                document
                  .querySelectorAll("#detailedTable .dropdown-menu")
                  .forEach((menu) => {
                    if (menu !== dropdownMenu) {
                      menu.classList.remove("show");
                    }
                  });
                // Toggle visibility
                dropdownMenu.classList.toggle("show");
                event.stopPropagation(); // Prevent closing immediately from document listener
                populateReportingDropdown(columnKey, dropdownMenu, filterIcon);
              });
            });

          // Close dropdowns if clicked outside the table
          document.addEventListener("click", (event) => {
            document
              .querySelectorAll("#detailedTable .dropdown-menu")
              .forEach((menu) => {
                if (
                  menu.classList.contains("show") &&
                  !menu.closest(".header-container").contains(event.target)
                ) {
                  menu.classList.remove("show");
                }
              });
          });
        } else if (tabName === "trade-exception") {
          // Render charts based on current exception data
          renderExceptionCharts(exceptionTradeData);
          
          // Attach event listeners for sorting and filtering in the exception table
          document
            .querySelectorAll("#exception-table-body").closest("table").querySelectorAll("thead th .header-container")
            .forEach((header) => {
              const columnKey = header.dataset.column;
              const dropdownMenu = header.querySelector(".dropdown-menu");
              const filterIcon = header.querySelector(".filter-icon-reporting");

              // Only open dropdown when clicking the filter icon or caret, not the whole header
              filterIcon.addEventListener("click", (event) => {
                // Close other dropdowns
                document
                  .querySelectorAll("table .dropdown-menu")
                  .forEach((menu) => {
                    if (menu !== dropdownMenu) {
                      menu.classList.remove("show");
                    }
                  });
                // Toggle visibility
                dropdownMenu.classList.toggle("show");
                event.stopPropagation(); // Prevent closing immediately from document listener
                populateExceptionDropdown(columnKey, dropdownMenu, filterIcon);
              });
            });

          // Close dropdowns if clicked outside the exception table
          document.addEventListener("click", (event) => {
            document
              .querySelectorAll("table .dropdown-menu")
              .forEach((menu) => {
                if (
                  menu.classList.contains("show") &&
                  !menu.closest(".header-container").contains(event.target)
                ) {
                  menu.classList.remove("show");
                }
              });
          });
        } else if (tabName === "audit-trail") {
          // Attach event listeners and render table for Audit Trail
          applyAuditFiltersAndSort(); // Initial render and attach filter/sort listeners
          document.querySelectorAll("th[data-sort-key]").forEach((header) => {
            header.addEventListener("click", (event) => {
              // Prevent sorting when clicking inside the filter input/select
              if (
                event.target.tagName === "INPUT" ||
                event.target.tagName === "SELECT"
              ) {
                return;
              }
              const sortKey = header.dataset.sortKey; // Corrected to dataset.sortKey
              if (auditCurrentSortColumn === sortKey) {
                auditSortDirection =
                  auditSortDirection === "asc" ? "desc" : "asc";
              } else {
                auditCurrentSortColumn = sortKey;
                auditSortDirection = "asc";
              }
              applyAuditFiltersAndSort();
            });
          });

          // Attach event listeners for filters (if they exist in the rendered content)
          const actionTypeFilter = document.getElementById("actionTypeFilter");
          const tradeIdFilter = document.getElementById("tradeIdFilter");
          const departmentFilter = document.getElementById("departmentFilter");
          const regulationFilter = document.getElementById("regulationFilter");

          if (actionTypeFilter)
            actionTypeFilter.addEventListener(
              "change",
              applyAuditFiltersAndSort
            );
          if (tradeIdFilter)
            tradeIdFilter.addEventListener("input", applyAuditFiltersAndSort);
          if (departmentFilter)
            departmentFilter.addEventListener(
              "input",
              applyAuditFiltersAndSort
            );
          if (regulationFilter)
            regulationFilter.addEventListener(
              "change",
              applyAuditFiltersAndSort
            );
        }
      }

      // Helper function to format tab names for display
      function formatTabName(tabName) {
        return tabName
          .split(" ")
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }

      // The initial updateContent call and navTabs event listener are now inside window.onload
      // to ensure DOM elements are fully loaded before they are accessed.
      
      // Global test function for debugging
      window.testExceptionDropdown = testDropdown;
      window.attachExceptionListeners = attachExceptionTableEventListeners;
      
      // Test function to check data structure
      window.testExceptionData = function() {
        console.log("Exception trade data:", exceptionTradeData);
        console.log("Active filters:", exceptionActiveFilters);
        
        if (exceptionTradeData.length > 0) {
          const firstTrade = exceptionTradeData[0];
          console.log("First trade structure:", firstTrade);
          console.log("Available fields:", Object.keys(firstTrade));
        }
      };
      
      // Test function to manually test checkbox filters
      window.testCheckboxFilter = function(columnKey) {
        console.log("Testing checkbox filter for:", columnKey);
        
        // Find the header
        const headers = document.querySelectorAll("#exception-table-body").closest("table").querySelectorAll("thead th .header-container");
        const targetHeader = Array.from(headers).find(h => h.dataset.column === columnKey);
        
        if (targetHeader) {
          const dropdownMenu = targetHeader.querySelector(".dropdown-menu");
          const filterIcon = targetHeader.querySelector(".fas.fa-caret-down");
          
          console.log("Found header for", columnKey, "Dropdown:", !!dropdownMenu, "Icon:", !!filterIcon);
          
          if (dropdownMenu && filterIcon) {
            dropdownMenu.classList.add("show");
            populateExceptionDropdown(columnKey, dropdownMenu, filterIcon);
            
            // Test clicking a checkbox
            setTimeout(() => {
              const checkboxes = dropdownMenu.querySelectorAll("input.filter-checkbox");
              console.log("Found checkboxes:", checkboxes.length);
              
              if (checkboxes.length > 0) {
                const firstCheckbox = checkboxes[0];
                console.log("Clicking first checkbox:", firstCheckbox.value);
                firstCheckbox.checked = !firstCheckbox.checked;
                firstCheckbox.dispatchEvent(new Event('change'));
              }
            }, 100);
          }
        } else {
          console.log("Header not found for:", columnKey);
        }
      };
      
      // Simple test to create a checkbox manually
      window.createTestCheckbox = function() {
        console.log("Creating test checkbox...");
        
        // Create a simple test checkbox
        const testDiv = document.createElement("div");
        testDiv.style.position = "fixed";
        testDiv.style.top = "10px";
        testDiv.style.right = "10px";
        testDiv.style.backgroundColor = "white";
        testDiv.style.border = "1px solid black";
        testDiv.style.padding = "10px";
        testDiv.style.zIndex = "9999";
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = "test-checkbox";
        checkbox.value = "test-value";
        
        const label = document.createElement("label");
        label.htmlFor = "test-checkbox";
        label.textContent = "Test Checkbox";
        
        checkbox.onchange = () => {
          console.log("Test checkbox clicked! Checked:", checkbox.checked);
        };
        
        testDiv.appendChild(checkbox);
        testDiv.appendChild(label);
        document.body.appendChild(testDiv);
        
        console.log("Test checkbox created. Try clicking it!");
      };
      
      // Function to debug checkbox filter issues
      window.debugCheckboxFilter = function() {
        console.log("Debugging checkbox filters...");
        console.log("Active filters:", exceptionActiveFilters);
        
        // Check all dropdown menus
        const dropdowns = document.querySelectorAll(".dropdown-menu");
        console.log("Total dropdowns found:", dropdowns.length);
        
        dropdowns.forEach((dropdown, index) => {
          const checkboxes = dropdown.querySelectorAll("input.filter-checkbox");
          console.log(`Dropdown ${index}:`, checkboxes.length, "checkboxes");
        });
        
        // Check specific columns
        const columns = ["exceptionType", "exceptionStatus", "productType", "counterparty"];
        columns.forEach(col => {
          const dropdown = document.querySelector(`[data-column="${col}"] .dropdown-menu`);
          if (dropdown) {
            const checkboxes = dropdown.querySelectorAll("input.filter-checkbox");
            console.log(`Column ${col}:`, checkboxes.length, "checkboxes");
          } else {
            console.log(`Column ${col}: No dropdown found`);
          }
        });
      };
      
      // Function to manually test checkbox functionality
      window.testCheckboxManually = function() {
        console.log("Manual checkbox test...");
        
        // Find the first checkbox column
        const headers = document.querySelectorAll("#exception-table-body").closest("table").querySelectorAll("thead th .header-container");
        const checkboxHeaders = Array.from(headers).filter(h => 
          ["exceptionType", "exceptionStatus", "productType", "counterparty"].includes(h.dataset.column)
        );
        
        if (checkboxHeaders.length > 0) {
          const testHeader = checkboxHeaders[0];
          const columnKey = testHeader.dataset.column;
          console.log("Testing checkbox for column:", columnKey);
          
          // Simulate clicking the header
          testHeader.click();
          
          // Wait for dropdown to populate
          setTimeout(() => {
            const dropdown = testHeader.querySelector(".dropdown-menu");
            if (dropdown && dropdown.classList.contains("show")) {
              console.log("Dropdown is visible, looking for checkboxes...");
              
              const checkboxes = dropdown.querySelectorAll("input.filter-checkbox");
              console.log("Found checkboxes:", checkboxes.length);
              
              if (checkboxes.length > 0) {
                const firstCheckbox = checkboxes[0];
                console.log("Clicking first checkbox:", firstCheckbox.value);
                firstCheckbox.checked = !firstCheckbox.checked;
                firstCheckbox.dispatchEvent(new Event('change'));
                console.log("Checkbox clicked successfully");
              } else {
                console.log("No checkboxes found in dropdown");
              }
            } else {
              console.log("Dropdown not visible or not found");
            }
          }, 500);
        } else {
          console.log("No checkbox columns found");
        }
      };
    </script>
  </body>
</html>

